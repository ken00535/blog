<!DOCTYPE html><html domain="blog.kenwsc.com" ga-id="GTM-MM4P38S" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="Backend,Golang" name="keywords"><link href="/img/favicon/favicon.png?hash=b6fc65e341" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>雙向互動的即時訊息：Websocket 入門</title><meta content="雙向互動的即時訊息：Websocket 入門" property="og:title"><meta content="雙向互動的即時訊息：Websocket 入門" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="在 HTTP 設計之初，網路應用主要是交換文件，因此當提交訊息或更新訊息時，需要刷新整個頁面。但是對需要互動的應用，如果使用 HTTP 傳遞訊息，則需要客戶端頻繁向伺服端輪詢，可想而知會造成客戶端跟伺服端很大的負擔。比較理想的情況是，應該存在一個事件驅動模型，當伺服端有事件發生時，它會主動通知訂閱的客戶端，客戶端再進行更新，而這就是 WebSocket 這套通訊協定誕生的原因。…" name="description"><meta content="在 HTTP 設計之初，網路應用主要是交換文件，因此當提交訊息或更新訊息時，需要刷新整個頁面。但是對需要互動的應用，如果使用 HTTP 傳遞訊息，則需要客戶端頻繁向伺服端輪詢，可想而知會造成客戶端跟伺服端很大的負擔。比較理想的情況是，應該存在一個事件驅動模型，當伺服端有事件發生時，它會主動通知訂閱的客戶端，客戶端再進行更新，而這就是 WebSocket 這套通訊協定誕生的原因。…" name="twitter:description"><meta content="在 HTTP 設計之初，網路應用主要是交換文件，因此當提交訊息或更新訊息時，需要刷新整個頁面。但是對需要互動的應用，如果使用 HTTP 傳遞訊息，則需要客戶端頻繁向伺服端輪詢，可想而知會造成客戶端跟伺服端很大的負擔。比較理想的情況是，應該存在一個事件驅動模型，當伺服端有事件發生時，它會主動通知訂閱的客戶端，客戶端再進行更新，而這就是 WebSocket 這套通訊協定誕生的原因。…" property="og:description"><meta content="article" property="og:type"><meta content="https://blog.kenwsc.com/posts/2020/a-full-duplex-protocol-websocket/" property="og:url"><meta content="Ken Chen's Blog" property="og:site_name"><meta content="https://blog.kenwsc.com/img/posts/2020/a-full-duplex-protocol-websocket/cover.png" property="og:image"><meta content="https://blog.kenwsc.com/img/posts/2020/a-full-duplex-protocol-websocket/cover.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://blog.kenwsc.com/posts/2020/a-full-duplex-protocol-websocket/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Ken Chen's Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
            var f = d.getElementsByTagName(s)[0];
            var j = d.createElement(s);
            var dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-MM4P38S');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}dl{clear:both;display:block!important;margin:0 0 1.5em}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}html{line-height:1.15;-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button,textarea{font-family:inherit;font-size:100%;line-height:1.15}button{overflow:visible;text-transform:none}textarea{margin:0}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}textarea{overflow:auto}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:1.75rem}body,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}code{border-radius:.3em;color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2{font-family:var(--font-family)}a:hover{text-decoration:underline}button,textarea{border-radius:.3em;max-width:100%}textarea{display:inline-block;margin-bottom:1.5em;min-height:7.5em;min-width:15em;border:1px solid #595959;padding:.75em}button+label,label+*,textarea+label{page-break-before:always}button,label{display:inline-block}button{background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li dl,li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.tag{color:#e2777a}.token.function,.token.number{color:#f08d49}.token.class-name,.token.property{color:#f8c555}.token.builtin,.token.keyword{color:#cc99cd}.token.attr-value,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold{font-weight:700}.token.entity{cursor:help}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:240px;height:40px;background:url(/img/logo.png) no-repeat;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;border-top:1px solid #ccc;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.post-tag:not(body){text-decoration:none;background-color:#f5f5f5;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border-radius:20px;color:#4a4a4a;display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;font-size:.75rem;height:2em;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;line-height:1.5;padding-left:.75em;padding-right:.75em;white-space:nowrap}.post-tag:hover{text-decoration:none;background:#ccc}.direct-link{display:none}.post-avatar{display:flex;align-items:center;height:36px}.post-avatar__time{font-size:13px}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:240px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px;width:max-content}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">文章列表</a> <a href="/tags/">標籤</a> <a href="/about/">關於我</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">雙向互動的即時訊息：Websocket 入門</h1><aside class="w-full"><div class="post-avatar"><div class="post-avatar__time">Ken Chen | 23 Aug 2020 <a href="/tags/node-js/" class="post-tag">Node.js</a> <a href="/tags/websocket/" class="post-tag">Websocket</a></div></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>在 HTTP 設計之初，網路應用主要是交換文件，因此當提交訊息或更新訊息時，需要刷新整個頁面，這也導致大量 HTML 被重複傳輸，浪費使用頻寬。後來 AJAX 被提出，讓 HTTP 可以只取得想要的伺服端訊息，同時在沒有重新導向的情況下更新頁面，讓 HTTP 更符合現代網路應用情境。</p><p>但是對需要互動的應用，像是聊天室、遊戲、即時狀態監控等等來說，如果使用 HTTP 傳遞訊息，則需要客戶端頻繁向伺服端輪詢(Polling)，有點像客戶端三不五時跟伺服端問說：「你有沒有新資料需要更新的啊？」可想而知會造成客戶端跟伺服端很大的負擔。比較理想的情況是，應該存在一個事件驅動模型，當伺服端有事件發生時，它會主動通知訂閱的客戶端，客戶端再進行更新，而這就是 WebSocket 這套通訊協定誕生的原因。</p><p>Websocket 沒有限定語言，但為了簡化操作，後端可以用 node.js，好跟前端的 JavaScript 共用一套函式庫。本文中會使用 node.js 常見的後端框架 Express，並搭配 <a href="http://socket.io" rel="noopener noreferrer" target="_blank">socket.io</a>，來建立前後端之間的 WebSocket 連線。</p><p>想 Clone 程式碼的，可以到<a href="https://github.com/ken00535/nodejs-medium-example" rel="noopener noreferrer" target="_blank">這裡</a>。</p><h2 id="create-server"><a href="#create-server" class="direct-link">#</a> Create Server</h2><p>既然是網路應用，首先來建立 Server，node.js 的專案結構是</p><pre><code>project
├── public
├── index.js
└── README.md
</code></pre><p>初始化專案</p><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> init</code></pre><p>npm 會問你一堆問題，通常按照預設來回答就好</p><pre class="language-bash"><code class="language-bash">ken@DESKTOP-2R08VK6:~/git/medium-example-nodejs/socket-io$ <span class="token function">npm</span> init<br>This utility will walk you through creating a package.json file.<br>It only covers the <span class="token function">most</span> common items, and tries to guess sensible defaults.<br><br>See <span class="token variable"><span class="token variable">`</span><span class="token function">npm</span> <span class="token class-name builtin">help</span> json<span class="token variable">`</span></span> <span class="token keyword">for</span> definitive documentation on these fields<br>and exactly what they do.<br><br>Use <span class="token variable"><span class="token variable">`</span><span class="token function">npm</span> <span class="token function">install</span> <span class="token operator">&lt;</span>pkg<span class="token operator">></span><span class="token variable">`</span></span> afterwards to <span class="token function">install</span> a package and<br>save it as a dependency <span class="token keyword">in</span> the package.json file.<br><br>Press ^C at any <span class="token function">time</span> to quit.<br>package name: <span class="token punctuation">(</span>socket-io<span class="token punctuation">)</span> <br>version: <span class="token punctuation">(</span><span class="token number">1.0</span>.0<span class="token punctuation">)</span> <br>description: socket.io demo<br>entry point: <span class="token punctuation">(</span>index.js<span class="token punctuation">)</span> <br><span class="token class-name builtin">test</span> command: <br><span class="token function">git</span> repository: <br>keywords: <br>author: kenwschen<br>license: <span class="token punctuation">(</span>ISC<span class="token punctuation">)</span> MIT<br>About to <span class="token function">write</span> to /home/ken/git/medium-example-nodejs/socket-io/package.json:<br><br><span class="token punctuation">{</span><br>    <span class="token string">"name"</span><span class="token class-name builtin">:</span> <span class="token string">"socket-io"</span>,<br>    <span class="token string">"version"</span><span class="token class-name builtin">:</span> <span class="token string">"1.0.0"</span>,<br>    <span class="token string">"description"</span><span class="token class-name builtin">:</span> <span class="token string">"socket.io demo"</span>,<br>    <span class="token string">"main"</span><span class="token class-name builtin">:</span> <span class="token string">"index.js"</span>,<br>    <span class="token string">"scripts"</span><span class="token class-name builtin">:</span> <span class="token punctuation">{</span><br>    <span class="token string">"test"</span><span class="token class-name builtin">:</span> <span class="token string">"echo <span class="token entity" title='\"'>\"</span>Error: no test specified<span class="token entity" title='\"'>\"</span> && exit 1"</span><br>    <span class="token punctuation">}</span>,<br>    <span class="token string">"author"</span><span class="token class-name builtin">:</span> <span class="token string">"kenwschen"</span>,<br>    <span class="token string">"license"</span><span class="token class-name builtin">:</span> <span class="token string">"MIT"</span><br><span class="token punctuation">}</span><br><br>Is this OK? <span class="token punctuation">(</span>yes<span class="token punctuation">)</span></code></pre><p>回答完後，專案初始化完成。</p><p>接著來安裝 express，這是一套 node.js 的 Web 框架，可以用來將不同的 URL 導向不同的資源（用專有名詞來說，可以用來做多路複用），它的官網是<br><a href="https://expressjs.com" rel="noopener noreferrer" target="_blank">Express — Node.js web application framework</a></p><p>安裝方式是</p><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> express --save</code></pre><p>npm 會將 express 加入 node_modules 中，讓 node 可以調用依賴，專案變成</p><pre><code>project
├── node_modules
├── public
├── index.js
├── package.json
├── package-lock.json
└── README.md
</code></pre><p>在入口 index.js 中加入內容</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    res<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'text/plain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello, World.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><br>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8001</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Express started'</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>前面是引用函式庫，並建立 express instance</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>再建立 root 的回覆訊息</p><pre class="language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    res<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'text/plain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello, World.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>當收到 Get / 的 HTTP request 時，response 的形式是純文本；狀態是 200 ok；內容是 “Hello, World.”</p><p>最後，監聽 port 8001，如果建立成功，印出訊息</p><pre class="language-js"><code class="language-js">server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><br>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8001</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Express started'</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>執行程式</p><pre class="language-bash"><code class="language-bash">node index.js</code></pre><p>在瀏覽器的導航列輸入 <a href="http://127.0.0.1:8001" rel="noopener noreferrer" target="_blank">http://127.0.0.1:8001</a> 可以看到 “Hello, World.”</p><h2 id="create-websocket-server"><a href="#create-websocket-server" class="direct-link">#</a> Create WebSocket Server</h2><p>有了基本 Server 後，再來加入 WebSocket，這邊使用 <a href="(https://socket.io/docs/)" rel="noopener noreferrer" target="_blank">Socket.IO</a> 這套函式庫</p><p>安裝方式是</p><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> socket.io --save</code></pre><p>改寫 index.js 內容</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> io <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// ...</span><br><br><span class="token keyword">var</span> servIo <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span><br>servIo<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'second'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">'second'</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>WebSocket 跟 HTTP Listen 同一個 Port，訂閱 connection 事件，當連線建立時會觸發</p><pre class="language-js"><code class="language-js">servIo<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span></code></pre><p>若是連線成功，則每秒發送當前的秒數到 second 事件中</p><pre class="language-js"><code class="language-js"><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'second'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">'second'</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="create-websocket-client"><a href="#create-websocket-client" class="direct-link">#</a> Create WebSocket Client</h2><p>建立完伺服端，接著建立客戶端。客戶端用到的的靜態資源會放在 public 下，因此新增兩個檔案</p><pre><code>project
├── node_modules
├── public
│   ├── client.js
│   └── socket.html
├── index.js
├── package.json
├── package-lock.json
└── README.md
</code></pre><p>也要讓 express 知道這件事，改寫 index.js</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> io <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>新增的兩個資源，socket.html 用以描述前端頁面；client.js 用來建立 WebSocket 並改寫 HTML 顯示的資訊。</p><p>先來看 HTML</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/socket.io/socket.io.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>client.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>second<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>引用了 <a href="http://socket.io" rel="noopener noreferrer" target="_blank">socket.io</a> 的函式庫，還有 jQuery 用來操作 HTML 元素。body 內執行 client.js 的內容，並有一個 div 顯示秒數資訊。</p><p>接著看 client.js</p><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> socket <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'second'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">second</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#second'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>second<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>訂閱 second 事件；當收到 second 時，改寫 second 元素中的內容</p><p>用瀏覽器打開 <a href="http://127.0.0.1:8001/socket.html%EF%BC%8C%E5%8F%AB%E5%87%BA%E5%89%9B%E5%89%9B%E5%BB%BA%E7%AB%8B%E7%9A%84%E9%A0%81%E9%9D%A2%EF%BC%8C%E7%94%A8" rel="noopener noreferrer" target="_blank">http://127.0.0.1:8001/socket.html，叫出剛剛建立的頁面，用</a> F12 打開瀏覽器的開發者視窗，可以看到資源都被 Get 回來</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-1-1920w.webp 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-1-1280w.webp 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-1-840w.webp 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-1-1920w.png 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-1-1280w.png 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-1-840w.png 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-1-320w.png 320w" type="image/png"><img alt="" height="458" src="/img/posts/2020/a-full-duplex-protocol-websocket/ws-1-1920w.png" width="783" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 783 458'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAgElEQVQImSWOuxLDIAzA+P+v5Ho5wLHxsyHA1EuqQYMmpQ6tnXyUmj9HbQAAiEhI0ntnSaU2fAKpiJudiJ27mnl4RKR7rjnnev3nmitGjPvaeyfmvtbae48xzIyZRSQ8Hsc31Vr/yV+ICADcXURP11RKIaLng1lVASDnTETCQio/EOuoKjLGwh8AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>其中有個 WebSocket 連線，點選後可以看到伺服器不斷傳送訊息</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-2-1920w.webp 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-2-1280w.webp 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-2-840w.webp 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-2-1920w.png 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-2-1280w.png 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-2-840w.png 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-2-320w.png 320w" type="image/png"><img alt="" height="605" src="/img/posts/2020/a-full-duplex-protocol-websocket/ws-2-1920w.png" width="782" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 782 605'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAIAAABV+fA3AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiUlEQVQImTWJQQ6DMAzA+v/vsR8wIIU0IW26UJDSCab5YFlywHmKG40TTDPEGAFuM9GGFDCRcBLZVUvOkijtIrmUqhrW/YNiKZvWWrUWrXJLz+sKr9GGdxtGW5a4YcqlqKqIIGLoD+6+RkBEd++9mxkAhKfvx0xEdD6YGTMH++PurbVfH8fRe/8Cwyiy6Uh0BDsAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>前端頁面上的秒數值也會不斷被刷新。</p><h2 id="monitor-websocket-packet"><a href="#monitor-websocket-packet" class="direct-link">#</a> Monitor WebSocket Packet</h2><p>我們可以用 WireShark 來觀察 WebSocket 的封包。WebSocket 的交握過程如下圖</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-3-1920w.webp 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-3-1280w.webp 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-3-840w.webp 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-3-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-3-1920w.png 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-3-1280w.png 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-3-840w.png 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-3-320w.png 320w" type="image/png"><img alt="" height="837" src="/img/posts/2020/a-full-duplex-protocol-websocket/ws-3-1920w.png" width="929" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 929 837'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAHCAYAAAA1WQxeAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA7klEQVQImWPQMrUL1zO1k+MwdWTwMrVmFjVzZNAztVPRNrVbrGVqN4lB29IpUNrCWTza1Irhv4YkQ4CJFYOUmYOMprnDTG0zhx4GFxc/qzpLG5XZRkZSM42NpaYZG4NouQQHdytDn0gRhig9Q7lePV3TVkMDwxZjI9MmYyPTifq6+oV6+oYM0pqMDJaOvnJhYenyAf4xCv7+UWre3uGasbH54nbeUepaRpZ8DPq+8fJW1XPV7Ip6NWyL+9Vt8tq1HJqXKpkkVOqqa+nzMJjYeyo6+0drOfqEazj7hBg7eocYuAXFKlu7B+rLaxqyAACJiDhiS3dgWwAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Client 會發起 HTTP Upgrade，要求將 Session 升級為 WebSocket 協定，Server 收到後，會回覆 Client 已經 Upgrade，雙方後續就可以使用 WebSocket 通訊。如果用 WireShark 抓取封包，結果會是</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-4-1920w.webp 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-4-1280w.webp 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-4-840w.webp 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-4-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-4-1920w.png 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-4-1280w.png 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-4-840w.png 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-4-320w.png 320w" type="image/png"><img alt="" height="103" src="/img/posts/2020/a-full-duplex-protocol-websocket/ws-4-1920w.png" width="1269" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1269 103'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAACCAIAAAAmbzBRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAo0lEQVQImQXB2wqCMAAA0P7/RzJzSVfyQYpEszKdeZk5b1tuMjVGRO+dM3GJ7tTATKdw2Frl/MaWsN9YpRaI9TGfPcZdIvcXqsfSQB/jzlcnrNoVsErNRMohU6xCdanuNMCugV1pZ7KYFKwJMXKjgL47mCPMKR05xIj0zEsjJoX4jiFO0asafrIW7TUJ/WcS5MhDsZ8leUsawQvWYtZWHWsE/wO2O4WJHH5vUAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>可以看到一開始是 HTTP，等到雙方交握完成後，就改為 WebSocket。</p><p>進一步查看交握的封包內容</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-5-1920w.webp 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-5-1280w.webp 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-5-840w.webp 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-5-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-5-1920w.png 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-5-1280w.png 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-5-840w.png 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-5-320w.png 320w" type="image/png"><img alt="" height="161" src="/img/posts/2020/a-full-duplex-protocol-websocket/ws-5-1920w.png" width="1105" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1105 161'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAg0lEQVQImW2ITQrCMBCFc38Kbly0FvEKIq5caCgI3sFFhDEIktBgJkTIdJSM6MrH+/l4qtmY2dY06/N8d+uHcaF9p117cO3+3mnfD+PyiKvT86+VFQFAzpl5IqKa2kWWJubXVyz+gboYAwDWXp13iJhSStIhhA/IiYgY4wNjFKxPofIGmvCg0ByExkMAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>HTTP 中會帶許多 Header，Upgrade 表示要升級的協定；Sec-WebSocket-Key 則是交握用的資訊。Server 收到後會回</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-6-1920w.webp 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-6-1280w.webp 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-6-840w.webp 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-6-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-6-1920w.png 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-6-1280w.png 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-6-840w.png 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-6-320w.png 320w" type="image/png"><img alt="" height="160" src="/img/posts/2020/a-full-duplex-protocol-websocket/ws-6-1920w.png" width="985" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 985 160'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAADCAIAAAD+5KMAAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAa0lEQVQImX3LsQ5AMBRA0f49i8Qqwicwid0gbD5AEYml2sarqL7QYLByctdLGiqdhHrZ6Katn09BsYblHtdnVB1hiT8Re+Aw9H3XUdrOMxOCSyk450opa+31jRhjGGOwLACgN63ghYg/23PecmCZ9oL2yHsAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>狀態碼是 101，表示協議切換；其中 Sec-WebSocket-Accept 是用 Sec-WebSocket-Key 算出來的值，用來避免跨協議攻擊。</p><p>後面 WebSocket 協定包括幀頭跟載荷</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-7-1920w.webp 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-7-1280w.webp 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-7-840w.webp 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-7-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/a-full-duplex-protocol-websocket/ws-7-1920w.png 1920w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-7-1280w.png 1280w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-7-840w.png 840w, /img/posts/2020/a-full-duplex-protocol-websocket/ws-7-320w.png 320w" type="image/png"><img alt="" height="219" src="/img/posts/2020/a-full-duplex-protocol-websocket/ws-7-1920w.png" width="942" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 942 219'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAECAIAAAAI1ii7AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAT0lEQVQImX3BiwnAIAwFwOy/ZUUMMY/6QZBGtIUOkDsCcJciOY8x5u9xUW+dmUO4AMw5zex1UYxRVUWktb73PudsFyVOAFS11rrWMrPl+gDSHrmuT+tfKAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Fin 的 bit 表示該幀為完結幀，通常 WebSocket 傳送只用到一幀，但也能支援多幀傳送；Opcode 是操作碼，表示內容的類型，通常用於 WebSocket 的傳送都是文本；Payload 是資料內容，可以看到事件名稱跟秒數都在 Payload 中。</p><h2 id="send-message-from-client"><a href="#send-message-from-client" class="direct-link">#</a> Send Message From Client</h2><p>由於 WebSocket 是雙向通訊，也可以改寫程式，由前端發訊息給後端，先在 HTML 中建立文本輸入欄位</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>client.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>second<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre><p>改寫 client.js</p><pre class="language-js"><code class="language-js"><span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keypress</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'client_data'</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>charCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>在前端載入完成時註冊一個 function，當文本輸入欄位被輸入新的值，這個值就會立刻傳送回後端。</p><p>接著改寫 index.js</p><pre class="language-js"><code class="language-js">servIo<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'second'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">'second'</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'client_data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>訂閱 client_data，當收到前端回傳的資料，用 console.log() 印出。</p><p>這樣就能完成雙向通訊了。</p><h2 id="%E5%B0%8F%E7%B5%90"><a href="#%E5%B0%8F%E7%B5%90" class="direct-link">#</a> 小結</h2><p>隨著 Web 領域的發展，WebSocket 已經是非常常見的應用了，畢竟現在的網路應用越來越接近桌面程式，前後端的互動更加頻繁，有些時候必須仰賴 WebSocket 才能滿足即時性的需求。像是開發設備前端，如果只使用單純的 AJAX，由於瀏覽器不可能每秒都跟後端取資料，拿到的數據不免有可能會失真，無法正確反映瞬間峰值，這時就是改用 WebSocket 的時機點。</p><h2 id="reference"><a href="#reference" class="direct-link">#</a> Reference</h2><ul><li><a href="https://expressjs.com/" rel="noopener noreferrer" target="_blank">express</a></li><li><a href="https://socket.io/docs/" rel="noopener noreferrer" target="_blank">socket.io</a></li><li><a href="https://www.cnblogs.com/sword-successful/p/4987124.html" rel="noopener noreferrer" target="_blank">Node.js、Express、Socket.io 入门</a></li><li><a href="https://w3c.hexschool.com/blog/e2d9c79d" rel="noopener noreferrer" target="_blank">Node.js 實作 The F2E_ChatRoom (1) 環境建置</a></li></ul><div class="article-footer"></div><div><p style="font-weight: bold;">標籤</p><div class="post-tags"><a href="/tags/node-js/" class="post-tag">Node.js</a> <a href="/tags/websocket/" class="post-tag">Websocket</a></div><p style="font-weight: bold;">其他文章</p><ul><li><a href="/posts/2022/concurrency-of-go-worker-pool/">Goroutine 的併發治理：管理 Worker Pool</a></li><li><a href="/posts/2020/publish-subscribe-pattern-by-go/">模組間的解耦合：發佈/訂閱模型</a></li><li><a href="/posts/2019/use-commitizen-to-write-graceful-git-comment/">輕鬆上手約定式提交：Commitizen 初體驗</a></li><li><a href="/posts/2019/use-prometheus-to-monitor-end-devices/">監控節點的度量指標：Prometheus 入門</a></li><li><a href="/posts/2019/setup-openwrt-on-virtualbox/">在 VirtualBox 上建置 Openwrt</a></li></ul></div><p style="font-weight: bold;">評論</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="ken00535/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"雙向互動的即時訊息：Websocket 入門","image":["https://blog.kenwsc.com/img/posts/2020/a-full-duplex-protocol-websocket/ws-1-1920w.png","https://blog.kenwsc.com/img/posts/2020/a-full-duplex-protocol-websocket/ws-2-1920w.png","https://blog.kenwsc.com/img/posts/2020/a-full-duplex-protocol-websocket/ws-3-1920w.png","https://blog.kenwsc.com/img/posts/2020/a-full-duplex-protocol-websocket/ws-4-1920w.png","https://blog.kenwsc.com/img/posts/2020/a-full-duplex-protocol-websocket/ws-5-1920w.png","https://blog.kenwsc.com/img/posts/2020/a-full-duplex-protocol-websocket/ws-6-1920w.png","https://blog.kenwsc.com/img/posts/2020/a-full-duplex-protocol-websocket/ws-7-1920w.png"],"author":{"@type":"Person","name":""},"publisher":{"@type":"Organization","name":"Ken Chen&#39;s Blog","url":"https://blog.kenwsc.com","logo":{"@type":"ImageObject","url":"https://blog.kenwsc.com/img/favicon/favicon.png","width":512,"height":512}},"url":"https://blog.kenwsc.com/posts/2020/a-full-duplex-protocol-websocket/","mainEntityOfPage":"https://blog.kenwsc.com/posts/2020/a-full-duplex-protocol-websocket/","datePublished":"2020-08-23","dateModified":"2023-02-07","description":"在 HTTP 設計之初，網路應用主要是交換文件，因此當提交訊息或更新訊息時，需要刷新整個頁面，這也導致大量 HTML 被重複傳輸，浪費使用頻寬。後來 AJAX 被提出，讓 HTTP 可以只取得想要的伺服端訊息，同時在沒有重新導向的情況下更新頁面，讓 HTTP..."}</script></article></main><footer><div class="footer-logos"><a href="https://medium.com/@ken00535" rel="noopener noreferrer" target="_blank"><img alt="medium" height="50" src="/img/icons/icon_social media_medium.svg" width="50"></a><a href="https://www.linkedin.com/in/ken00535" rel="noopener noreferrer" target="_blank"><img alt="linkedin" height="30" src="/img/icons/icon_social media_linkedln.svg" width="30"></a><a href="https://blog.kenwsc.com/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" height="30" src="/img/icons/rss-feed.svg" width="30"></a></div><div class="copyright">© 2023 Ken Chen's Blog, Powered by <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>