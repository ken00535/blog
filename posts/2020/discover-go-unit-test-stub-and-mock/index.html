<!DOCTYPE html><html domain="blog.kenwsc.com" ga-id="G-G76M9XJCKN" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="Backend,Golang" name="keywords"><link href="/img/favicon/favicon.png?hash=b6fc65e341" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>初探 Go 的單元測試：兼談 Stub 跟 Mock</title><meta content="初探 Go 的單元測試：兼談 Stub 跟 Mock" property="og:title"><meta content="初探 Go 的單元測試：兼談 Stub 跟 Mock" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="測試是程式的防護網，能確保程式符合設計。而針對測試中包含第三方依賴的情境，可以用 Stub 或 Mock 來解耦，讓商業邏輯跟底層套件分開。本文會用 ORM 當例子，介紹 Golang 的 Stub 跟 Mock，並實作三種不同方式的測試。…" name="description"><meta content="測試是程式的防護網，能確保程式符合設計。而針對測試中包含第三方依賴的情境，可以用 Stub 或 Mock 來解耦，讓商業邏輯跟底層套件分開。本文會用 ORM 當例子，介紹 Golang 的 Stub 跟 Mock，並實作三種不同方式的測試。…" name="twitter:description"><meta content="測試是程式的防護網，能確保程式符合設計。而針對測試中包含第三方依賴的情境，可以用 Stub 或 Mock 來解耦，讓商業邏輯跟底層套件分開。本文會用 ORM 當例子，介紹 Golang 的 Stub 跟 Mock，並實作三種不同方式的測試。…" property="og:description"><meta content="article" property="og:type"><meta content="https://blog.kenwsc.com/posts/2020/discover-go-unit-test-stub-and-mock/" property="og:url"><meta content="Ken Chen's Blog" property="og:site_name"><meta content="https://blog.kenwsc.com/img/posts/2020/discover-go-unit-test-stub-and-mock/cover.png" property="og:image"><meta content="https://blog.kenwsc.com/img/posts/2020/discover-go-unit-test-stub-and-mock/cover.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://blog.kenwsc.com/posts/2020/discover-go-unit-test-stub-and-mock/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Ken Chen's Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-G76M9XJCKN"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-G76M9XJCKN');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}.article-footer img,body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:1.75rem}body,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}button,code{border-radius:.3em}code{color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2{font-family:var(--font-family)}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ul{margin-bottom:0}blockquote{padding:0 1.5em;margin:1.5em 0 1.5em 1.5em;border-left:4px solid var(--primary)}blockquote footer{background:0 0;display:block;color:#ccc;padding:.75em 0;font-size:90%;text-align:start}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.property{color:#f8c555}.token.builtin,.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}#nav,.menu__btn{position:relative}.menu__btn{display:inline-block;width:24px;height:24px}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav{height:68px;z-index:2;align-items:center}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}#nav,.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}footer{margin-top:48px;font-size:14px;padding:24px;border-top:1px solid #ccc;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.post-tag:not(body){text-decoration:none;background-color:#f5f5f5;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border-radius:20px;color:#4a4a4a;display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;font-size:.75rem;height:2em;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;line-height:1.5;padding-left:.75em;padding-right:.75em;white-space:nowrap}.post-tag:hover{text-decoration:none;background:#ccc}.direct-link{display:none}.post-avatar{display:flex;align-items:center;height:36px}.post-avatar__time{font-size:13px}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}</style></head><body><header><nav><div id="nav"><div class="nav__links"><a href="/" title="Homepage">Home</a> <a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">初探 Go 的單元測試：兼談 Stub 跟 Mock</h1><aside class="w-full"><div class="post-avatar"><div class="post-avatar__time">Ken Chen | 22 Nov 2020 <a href="/tags/go/" class="post-tag">Go</a> <a href="/tags/test/" class="post-tag">Test</a></div></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>測試是程式的防護網，能確保程式符合設計，而當開發者需要對程式進行重構，以增進品質時，測試也可以確保程式不會出現改 A 壞 B 的情況。從商業角度來看，測試能降低維護與改善程式的成本，進而提高軟體開發的競爭力。</p><p>既然測試這麼好，那為什麼常看到軟體專案中沒有測試？在我的經驗中，主要原因有兩個：首先是軟體開發初期，架構還不是很穩定，API 隨時有可能改變，在 API 不穩時，如果就開始寫大量測試，會造成後面很大的維護成本，試著想想，API 的改變，可能就牽涉到測試流程跟測試資料的改變，而之前的 Corner Case 很可能都變成沒有價值的投資，在這情況下寫測試沒有意義。</p><p>再來，程式中可能會引用到第三方套件，例如 ORM 或 HTTP 之類的外部依賴，如果要實際測試，就會需要建構測試環境，而這些也會有建置與維護成本，像是網路斷掉，可能就會在程式邏輯沒動到的狀況下，讓 HTTP 的測試失效，這些維護成本會讓寫測試的投資報酬率看起來不太划算。</p><p>前一個問題需要仰賴架構設計，暫且不談；而針對測試中包含第三方依賴的情境，可以用 Stub 或 Mock 來解耦，讓商業邏輯跟底層套件分開。本文會用 ORM 當例子，介紹 Golang 的 Stub 跟 Mock，並實作三種不同方式的測試。需要 Clone 程式碼的，可以到<a href="https://github.com/ken00535/golang-medium-example" rel="noopener noreferrer" target="_blank">這裡</a>。</p><h2 id="basic-test"><a href="#basic-test" class="direct-link">#</a> Basic Test</h2><p>身為現代的程式語言，Golang 有內建自己的測試框架與命令行工具，假設專案架構是</p><pre><code>.
├── README.md
└── pkg
    └── foo
        ├── foo.go
        └── foo_test.go
</code></pre><p>其中 foo.go 是程式邏輯，而 foo_test.go 則是測試用的程式。在 Golang 的專案中，測試程式都用 _test.go 結尾，方便命令行工具辨認。</p><p>來看主程式</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">fooBasic</span><span class="token punctuation">(</span>num1 <span class="token builtin">int</span><span class="token punctuation">,</span> num2 <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> num1 <span class="token operator">+</span> num2<br><span class="token punctuation">}</span></code></pre><p>內有 fooBasic，將兩個參數相加後返回。</p><p>對應的測試程式 foo_test.go 可以是</p><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> foo<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>    <span class="token string">"testing"</span><br>    <span class="token string">"github.com/stretchr/testify/assert"</span><br><span class="token punctuation">)</span><br><br><span class="token keyword">func</span> <span class="token function">TestFooBasic</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    expect <span class="token operator">:=</span> <span class="token number">2</span><br>    actual <span class="token operator">:=</span> <span class="token function">fooBasic</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><br>    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>所有單元測試都用 Test 當開頭，內部的 testing.T 用來記錄測試上下文。單元測試內會 call fooBasic，得到的值再跟期望值比較，如果相同代表測試通過。</p><pre class="language-go"><code class="language-go">assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> actual<span class="token punctuation">)</span></code></pre><p>因為 Golang 內建的斷言庫不是很豐富，建議使用第三方斷言庫來做 assert，安裝用</p><pre class="language-bash"><code class="language-bash">go get -u <span class="token string">"github.com/stretchr/testify/assert"</span></code></pre><p>之後可以用 go test 來執行測試</p><pre class="language-bash"><code class="language-bash">ken@DESKTOP-2R08VK6:~/git/medium-example-golang/gotest$ go <span class="token builtin class-name">test</span> ./<span class="token punctuation">..</span>.<br>ok      example/gotest/pkg/foo  <span class="token number">0</span>.005s</code></pre><p>看到測試通過。</p><p>假設將期望值改成錯的，則會得到錯誤訊息</p><pre class="language-bash"><code class="language-bash">ken@DESKTOP-2R08VK6:~/git/medium-example-golang/gotest$ go <span class="token builtin class-name">test</span> ./<span class="token punctuation">..</span>.<br>--- FAIL: TestFooBasic <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span><br>    foo_test.go:17: <br>                Error Trace:    foo_test.go:17<br>                Error:          Not equal: <br>                                expected: <span class="token number">1</span><br>                                actual  <span class="token builtin class-name">:</span> <span class="token number">2</span><br>                Test:           TestFooBasic<br>FAIL<br>FAIL    example/gotest/pkg/foo  <span class="token number">0</span>.016s<br>FAIL</code></pre><h2 id="stub"><a href="#stub" class="direct-link">#</a> Stub</h2><p>知道怎麼建立基礎測試後，回到本文的主題：如果有第三方依賴的話，應該如何去進行測試呢？可想而知，除了少數特例，我們不會希望真的執行底層命令。最直觀的做法，是把第三方的程式碼換掉，讓相同名字的函式對應到不同的邏輯內容。用專業術語來講，叫做 Stub。</p><p>在 C 語言，我們可以用 Linker 連結不同的原始碼來達成這件事。但由於 Golang 已經將 Linker 處理掉了，要思考的角度應該轉變成是，從應用的層面，如何對第三方解耦。其實解法也算單純，因為 Golang 可以支援函式變數，因此只要在測試時，將函式變數的值換掉即可。</p><p>來看主程式</p><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> foo<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>    <span class="token string">"time"</span><br><br>    <span class="token string">"github.com/jinzhu/gorm"</span><br><span class="token punctuation">)</span><br><br><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    gorm<span class="token punctuation">.</span>Model<br>    Name     <span class="token builtin">string</span><br>    Age      <span class="token builtin">int</span><br>    Birthday time<span class="token punctuation">.</span>Time<br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">fooDatabaseCaseByValueFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token function">getUserAgeValueFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">var</span> getUserAgeValueFunc <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> user User<br>    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"postgres"</span><span class="token punctuation">,</span> <span class="token string">"host=myhost user=gorm dbname=gorm sslmode=disable password=mypassword"</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"connect fail"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    res <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&</span>user<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> res<span class="token punctuation">.</span>Error <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> user<span class="token punctuation">.</span>Age<br><span class="token punctuation">}</span></code></pre><p>這段程式碼負責在 Database 中查詢 User 的資料，ORM 是使用 gorm（不知道如何使用的人，可以看<a href="/posts/2020/gorm-from-init-to-use">這篇</a>來複習）。將 ORM 相關的程式碼都抽出成函式，並 Assign 給 getUserAgeValueFunc，再在 fooDatabaseCaseByValueFunc 中調用並返回查詢結果。</p><p>測試程式則是</p><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> foo<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>    <span class="token string">"testing"</span><br>    <span class="token string">"github.com/prashantv/gostub"</span><br>    <span class="token string">"github.com/stretchr/testify/assert"</span><br><span class="token punctuation">)</span><br><br><span class="token keyword">func</span> <span class="token function">TestFooDatabaseByValueFunc</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    want <span class="token operator">:=</span> <span class="token number">1</span><br>    stub <span class="token operator">:=</span> gostub<span class="token punctuation">.</span><span class="token function">Stub</span><span class="token punctuation">(</span><span class="token operator">&</span>getUserAgeValueFunc<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token number">1</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token keyword">defer</span> stub<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    actual <span class="token operator">:=</span> <span class="token function">fooDatabaseCaseByValueFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> want<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>gostub.Stub 這套函式庫可以取代任意的變數，等到測試完成後，再將變數還原。</p><p>使用時，用</p><pre class="language-go"><code class="language-go">stub <span class="token operator">:=</span> gostub<span class="token punctuation">.</span><span class="token function">Stub</span><span class="token punctuation">(</span><span class="token operator">&</span>getUserAgeValueFunc<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token number">1</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>來對 getUserAgeValueFunc 進行取代，將它取代成</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token number">1</span><br><span class="token punctuation">}</span></code></pre><p>固定返回 1 這個值，等到執行完成後，再調用 Reset 還原</p><pre class="language-go"><code class="language-go"><span class="token keyword">defer</span> stub<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>如此就能做到 Stub 了。</p><h2 id="monkey-patch"><a href="#monkey-patch" class="direct-link">#</a> Monkey Patch</h2><p>但是等等，依照 Step 2 的方式，豈不是每個 Func 都要改成變數，才能換成 Stub？因為要測試，所以需要動到 Production Code，這樣不是前後關係倒置了嗎？是的，所以 gostub.Stub 的方式，又叫做侵入式。好的，既然有侵入式，那也有非侵入式，我們可以來嘗試 monkey 這套函式庫。</p><p>monkey 可以幫助 Golang 的開發者做 Monkey Patch，依照 <a href="https://blog.techbridge.cc/2018/07/14/python-monkey-patch/" rel="noopener noreferrer" target="_blank">TechBridge</a> 的解釋，Monkey Patch 是</p><blockquote><p>Monkey Patch 就是在 run time 時動態更改 class 或是 module 已經定義好的函數或是屬性內容。</p></blockquote><p>簡單來說，就是在 runtime 改變函式行為。Monkey Patch 的底層也不複雜，是使用 reflect 來實現。</p><p>要安裝 Monkey Patch，用</p><pre class="language-bash"><code class="language-bash">go get -u bou.ke/monkey</code></pre><p>回到主程式本身，修改原先 foo.go 的調用方式</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">fooDatabaseCaseByFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token function">getUserAgeFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">getUserAgeFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> user User<br>    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"postgres"</span><span class="token punctuation">,</span> <span class="token string">"host=myhost user=gorm dbname=gorm sslmode=disable password=mypassword"</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"connect fail"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    res <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&</span>user<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> res<span class="token punctuation">.</span>Error <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> user<span class="token punctuation">.</span>Age<br><span class="token punctuation">}</span></code></pre><p>改成不要使用變數來調用。</p><p>接著修改測試程式</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestFooDatabaseByFunc</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    want <span class="token operator">:=</span> <span class="token number">1</span><br>    patch <span class="token operator">:=</span> monkey<span class="token punctuation">.</span><span class="token function">Patch</span><span class="token punctuation">(</span>getUserAgeFunc<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token number">1</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token keyword">defer</span> patch<span class="token punctuation">.</span><span class="token function">Restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    actual <span class="token operator">:=</span> <span class="token function">fooDatabaseCaseByFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> want<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>同樣是測試結束後，用 Restore 還原，不同的是，這次可以直接修改函式，而不用將函式指定給變數了。</p><p>既然可以修改函式，那有沒有可能修改第三方函式庫呢？當然也可以。假設不要透過函式調用，而是直接使用第三方函式庫的話，foo.go 會是</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">fooDatabaseCaseDirectCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> user User<br>    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"postgres"</span><span class="token punctuation">,</span> <span class="token string">"host=myhost user=gorm dbname=gorm sslmode=disable password=mypassword"</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"connect fail"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    res <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&</span>user<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> res<span class="token punctuation">.</span>Error <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> user<span class="token punctuation">.</span>Age<br><span class="token punctuation">}</span></code></pre><p>同時，測試會變成</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestFooDatabaseByMonkeyPatch</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    want <span class="token operator">:=</span> <span class="token number">1</span><br>    user <span class="token operator">:=</span> User<span class="token punctuation">{</span>Age<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><br>    db <span class="token operator">:=</span> <span class="token operator">&</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">{</span><span class="token punctuation">}</span><br>    patch <span class="token operator">:=</span> monkey<span class="token punctuation">.</span><span class="token function">Patch</span><span class="token punctuation">(</span>gorm<span class="token punctuation">.</span>Open<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> db<span class="token punctuation">,</span> <span class="token boolean">nil</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    patchFirst <span class="token operator">:=</span> monkey<span class="token punctuation">.</span><span class="token function">PatchInstanceMethod</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"First"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token boolean">_</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> out <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span><br>        val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        substitute <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><br>        val<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>substitute<span class="token punctuation">)</span><br>        <span class="token keyword">return</span> db<br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    patchClose <span class="token operator">:=</span> monkey<span class="token punctuation">.</span><span class="token function">PatchInstanceMethod</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Close"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token boolean">nil</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        patch<span class="token punctuation">.</span><span class="token function">Restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        patchFirst<span class="token punctuation">.</span><span class="token function">Restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        patchClose<span class="token punctuation">.</span><span class="token function">Restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    actual <span class="token operator">:=</span> <span class="token function">fooDatabaseCaseDirectCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> want<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>可以看到會需要先 Patch gorm.Open</p><pre class="language-go"><code class="language-go">patch <span class="token operator">:=</span> monkey<span class="token punctuation">.</span><span class="token function">Patch</span><span class="token punctuation">(</span>gorm<span class="token punctuation">.</span>Open<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> db<span class="token punctuation">,</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>再 Patch 返回的物件方法</p><pre class="language-go"><code class="language-go">patchFirst <span class="token operator">:=</span> monkey<span class="token punctuation">.</span><span class="token function">PatchInstanceMethod</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"First"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token boolean">_</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> out <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span><br>    val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    substitute <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><br>    val<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>substitute<span class="token punctuation">)</span><br>    <span class="token keyword">return</span> db<br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>最後再 Patch gorm.Close</p><pre class="language-go"><code class="language-go">patchClose <span class="token operator">:=</span> monkey<span class="token punctuation">.</span><span class="token function">PatchInstanceMethod</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Close"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>結束前記得要還原</p><pre class="language-go"><code class="language-go"><span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    patch<span class="token punctuation">.</span><span class="token function">Restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    patchFirst<span class="token punctuation">.</span><span class="token function">Restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    patchClose<span class="token punctuation">.</span><span class="token function">Restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>可以看到測試邏輯變得很不清晰，大多時間都在 Patch 第三方套件，因此從測試的觀點來說，最好還是將第三方套件相關的東西抽出成函式，讓程式具備更好的可測試性。</p><h2 id="mock"><a href="#mock" class="direct-link">#</a> Mock</h2><p>Stub 可以將函式的行為給換掉，但如果想要追求更高的互動性，例如驗證函式的傳入參數是否跟預期相同，或是函式被調用的次數是不是預期的次數，這時就需要個跟真實物件很像的偽物，來做參數跟調用驗證。這個偽物在技術上，稱為 Mock。</p><p>在 Golang 的語境中，Stub 跟 Mock 的差異，可以簡單認為</p><ul><li>Stub 是換掉原先的變數</li><li>Mock 是對同樣 Interface 的不同實現</li></ul><p>什麼叫對同樣 Interface 的不同實現？Talk is cheap, show me the code，主程式是</p><pre class="language-go"><code class="language-go"><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    gorm<span class="token punctuation">.</span>Model<br>    Name     <span class="token builtin">string</span><br>    Age      <span class="token builtin">int</span><br>    Birthday time<span class="token punctuation">.</span>Time<br><span class="token punctuation">}</span><br><br><span class="token comment">// Database is database</span><br><span class="token keyword">type</span> Database <span class="token keyword">interface</span> <span class="token punctuation">{</span><br>    <span class="token function">First</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">fooDatabaseCaseIndirectCall</span><span class="token punctuation">(</span>db Database<span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> user User<br>    db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&</span>user<span class="token punctuation">)</span><br>    <span class="token keyword">return</span> user<span class="token punctuation">.</span>Age<br><span class="token punctuation">}</span></code></pre><p>函式接受一個參數傳入，該參數是 Database 這個 Interface。這裡涉及到一項重要的差異，在設計函式時，需要以 Interface 來實現，從 Golang 的角度來看，這才是解耦的根本之道，函式跟函式用 Interface 來溝通，而不是跟專用的 Instance 溝通，如此一來，函式之間就可以不存在依賴關係。</p><p>既然說到 Mock 是對 Interface 的不同實現，當然要來設計個 Mock，新增檔案 foo_self_mock.go</p><pre><code>.
├── README.md
└── pkg
    └── foo
        ├── foo.go
        ├── foo_self_mock.go
        └── foo_test.go
</code></pre><p>內容是</p><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> foo<br><br><span class="token keyword">type</span> dbMock <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">newDbMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>dbMock <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token operator">&</span>dbMock<span class="token punctuation">{</span><span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>dbMock<span class="token punctuation">)</span> <span class="token function">First</span><span class="token punctuation">(</span>out <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    out<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>Age <span class="token operator">=</span> <span class="token number">1</span><br><span class="token punctuation">}</span></code></pre><p>該 Mock 實現 Database，並將 First 傳入參數的值修改成 1。</p><p>回到測試程式，會變成</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestFooDatabaseCustomMock</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    want <span class="token operator">:=</span> <span class="token number">1</span><br>    m <span class="token operator">:=</span> <span class="token function">newDbMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    actual <span class="token operator">:=</span> <span class="token function">fooDatabaseCaseIndirectCall</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><br>    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> want<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>用 newDbMock 取得 Mock，再將該 Mock 傳進函式中，給函式進行調用，由於調用後會得到 1 的結果，這項測試就可以 Pass 了。</p><p>Mock 最簡單的概念就是這樣，在 Golang 官方維護的庫中，也有 Mock 用的工具 gomock，用來自動產生 Mock 程式碼。要使用 gomock，可以先安裝</p><pre class="language-bash"><code class="language-bash">go get -u github.com/golang/mock/mockgen</code></pre><p>再使用它的命令行工具</p><pre class="language-bash"><code class="language-bash">mockgen -destination foo_mock.go -source foo.go -package foo</code></pre><p>mockgen 會去讀取 -source 指定檔案中的 interface，再產生對應的程式碼</p><pre class="language-go"><code class="language-go"><span class="token comment">// Code generated by MockGen. DO NOT EDIT.</span><br><span class="token comment">// Source: foo.go</span><br><br><span class="token comment">// Package foo is a generated GoMock package.</span><br><span class="token keyword">package</span> foo<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>    gomock <span class="token string">"github.com/golang/mock/gomock"</span><br>    reflect <span class="token string">"reflect"</span><br><span class="token punctuation">)</span><br><br><span class="token comment">// MockDatabase is a mock of Database interface</span><br><span class="token keyword">type</span> MockDatabase <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    ctrl     <span class="token operator">*</span>gomock<span class="token punctuation">.</span>Controller<br>    recorder <span class="token operator">*</span>MockDatabaseMockRecorder<br><span class="token punctuation">}</span><br><br><span class="token comment">// MockDatabaseMockRecorder is the mock recorder for MockDatabase</span><br><span class="token keyword">type</span> MockDatabaseMockRecorder <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    mock <span class="token operator">*</span>MockDatabase<br><span class="token punctuation">}</span><br><br><span class="token comment">// NewMockDatabase creates a new mock instance</span><br><span class="token keyword">func</span> <span class="token function">NewMockDatabase</span><span class="token punctuation">(</span>ctrl <span class="token operator">*</span>gomock<span class="token punctuation">.</span>Controller<span class="token punctuation">)</span> <span class="token operator">*</span>MockDatabase <span class="token punctuation">{</span><br>    mock <span class="token operator">:=</span> <span class="token operator">&</span>MockDatabase<span class="token punctuation">{</span>ctrl<span class="token punctuation">:</span> ctrl<span class="token punctuation">}</span><br>    mock<span class="token punctuation">.</span>recorder <span class="token operator">=</span> <span class="token operator">&</span>MockDatabaseMockRecorder<span class="token punctuation">{</span>mock<span class="token punctuation">}</span><br>    <span class="token keyword">return</span> mock<br><span class="token punctuation">}</span><br><br><span class="token comment">// EXPECT returns an object that allows the caller to indicate expected use</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>MockDatabase<span class="token punctuation">)</span> <span class="token function">EXPECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>MockDatabaseMockRecorder <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> m<span class="token punctuation">.</span>recorder<br><span class="token punctuation">}</span><br><br><span class="token comment">// First mocks base method</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>MockDatabase<span class="token punctuation">)</span> <span class="token function">First</span><span class="token punctuation">(</span>arg0 <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    m<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>T<span class="token punctuation">.</span><span class="token function">Helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    m<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"First"</span><span class="token punctuation">,</span> arg0<span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// First indicates an expected call of First</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>mr <span class="token operator">*</span>MockDatabaseMockRecorder<span class="token punctuation">)</span> <span class="token function">First</span><span class="token punctuation">(</span>arg0 <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">*</span>gomock<span class="token punctuation">.</span>Call <span class="token punctuation">{</span><br>    mr<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>T<span class="token punctuation">.</span><span class="token function">Helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> mr<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span><span class="token function">RecordCallWithMethodType</span><span class="token punctuation">(</span>mr<span class="token punctuation">.</span>mock<span class="token punctuation">,</span> <span class="token string">"First"</span><span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>MockDatabase<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">.</span>First<span class="token punctuation">)</span><span class="token punctuation">,</span> arg0<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>跟我們剛剛自製的 mock 大致上類似，不同的是還有 Expect 跟 Recorder，這裡可以理解為支援參數驗證，預期的驗證行為會被記錄在 Recorder，而正式的調用行為則會用 Mock 的 First 來調用。落實到測試程式上，則是</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestFooDatabaseGomock</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    want <span class="token operator">:=</span> <span class="token number">1</span><br>    <span class="token keyword">var</span> user User<br>    ctrl <span class="token operator">:=</span> gomock<span class="token punctuation">.</span><span class="token function">NewController</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><br>    <span class="token keyword">defer</span> ctrl<span class="token punctuation">.</span><span class="token function">Finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    m <span class="token operator">:=</span> <span class="token function">NewMockDatabase</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span><br>    m<span class="token punctuation">.</span><span class="token function">EXPECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span>gomock<span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token operator">&</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetArg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> User<span class="token punctuation">{</span>Age<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>    actual <span class="token operator">:=</span> <span class="token function">fooDatabaseCaseIndirectCall</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><br>    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> want<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>為了產生 Mock，要先產生一個 controller 當參數</p><pre class="language-go"><code class="language-go">ctrl <span class="token operator">:=</span> gomock<span class="token punctuation">.</span><span class="token function">NewController</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span></code></pre><p>controller 在結束時，會用 Finish 來驗證所有的調用行為</p><pre class="language-go"><code class="language-go"><span class="token keyword">defer</span> ctrl<span class="token punctuation">.</span><span class="token function">Finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>將 controller 傳給 NewMockDatabase，得到 mock，並為 mock 設定預期跟回傳參數</p><pre class="language-go"><code class="language-go">m <span class="token operator">:=</span> <span class="token function">NewMockDatabase</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span><br>m<span class="token punctuation">.</span><span class="token function">EXPECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span>gomock<span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token operator">&</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetArg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> User<span class="token punctuation">{</span>Age<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>同樣將 mock 傳入調用，得到結果並驗證</p><pre class="language-go"><code class="language-go">actual <span class="token operator">:=</span> <span class="token function">fooDatabaseCaseIndirectCall</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><br>assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> want<span class="token punctuation">,</span> actual<span class="token punctuation">)</span></code></pre><p>可以看到用 Mockgen 建立的 mock 具備更高的互動性，可以依照開發者的需求來客制化行為。</p><h2 id="%E5%B0%8F%E7%B5%90"><a href="#%E5%B0%8F%E7%B5%90" class="direct-link">#</a> 小結</h2><p>介紹完 gostub、monkey 跟 gomock 三套函式庫後，來簡單做個結論。原則上，因為 gostub 是侵入式，會影響到原本的 Production code，基本上可以不用考慮，它的功用完全可以用 monkey 來取代。</p><p>而 gomock 的確很棒，能驗證互動行為，但這是建立在 Production code 用 interface 當參數的前提下，問題是，如果不是要做成函式庫，開放給其他人調用，而僅僅是應用程式內部使用的話，幾乎不太可能用 interface 當傳入參數。因為優點同時也是缺點，為了解耦依賴，必須要先在一個不同的地方實現 instance，再進行依賴注入，這會讓調用者的邏輯變得很複雜，每次要 call method 前，都要先把依賴 new 出來。再來，使用 interface 最直接的後果，就是沒辦法做 code nevigation，當只是要做個簡單的 function 時，用 Mock 的代價未免高了點。</p><p>我的建議是，盡可能將第三方的呼叫都封裝到函式中，不要直接寫在 Production code，這會大幅降低 Stub 的成本；再來，如果不是特殊需求，盡量少用 Mock，它的行為太複雜，會讓 test 變得不像 test。如果可以，我們應該要由程式架構來解決測試的複雜度。</p><h2 id="reference%3A"><a href="#reference%3A" class="direct-link">#</a> Reference:</h2><ul><li><a href="https://github.com/bouk/monkey" rel="noopener noreferrer" target="_blank">bouk/monkey: Monkey patching in Go — GitHub</a></li><li><a href="https://github.com/prashantv/gostub" rel="noopener noreferrer" target="_blank">prashantv/gostub: gostub is a library to make … — GitHub</a></li><li><a href="https://github.com/golang/mock" rel="noopener noreferrer" target="_blank">golang/mock: GoMock is a mocking framework for the … — GitHub</a></li><li><a href="https://blog.techbridge.cc/2018/07/14/python-monkey-patch/" rel="noopener noreferrer" target="_blank">Python Monkey Patch 入門教學 — TechBridge 技術共筆部落格</a></li></ul><div class="article-footer"></div><div><p style="font-weight: bold;">標籤</p><div class="post-tags"><a href="/tags/go/" class="post-tag">Go</a> <a href="/tags/test/" class="post-tag">Test</a></div><p style="font-weight: bold;">其他文章</p><ul><li><a href="/posts/2022/oauth-2-0-roles-and-channels/">OAuth 2.0：角色與信道</a></li><li><a href="/posts/2022/error-as-resource-grpc-error-handling/">讓錯誤成為資源：gRPC 的錯誤處理模型</a></li><li><a href="/posts/2020/conan-build-and-manage-c-cpp-artifacts/">Conan：建置並管理 C/C++ 的產出物</a></li><li><a href="/posts/2020/database-migration-by-go/">資料庫版本遷移：以 Go 為例</a></li><li><a href="/posts/2020/use-conan-to-manage-c-package/">Conan：C/C++ 的套件管理工具</a></li></ul></div><p style="font-weight: bold;">評論</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="ken00535/blog" theme="github-light"></script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "初探 Go 的單元測試：兼談 Stub 跟 Mock",
  "image": [],
  "author": {
    "@type": "Person",
    "name": ""
  }, 
  "publisher": {
    "@type": "Organization",
    "name": "Ken Chen&#39;s Blog",
    "url": "https://blog.kenwsc.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.kenwsc.com/img/favicon/favicon.png",
      "width": 512,
      "height": 512
    }
  },
  "url": "https://blog.kenwsc.com/posts/2020/discover-go-unit-test-stub-and-mock/",
  "mainEntityOfPage": "https://blog.kenwsc.com/posts/2020/discover-go-unit-test-stub-and-mock/",
  "datePublished": "2020-11-22",
  "dateModified": "2022-12-15",
  "description": "測試是程式的防護網，能確保程式符合設計，而當開發者需要對程式進行重構，以增進品質時，測試也可以確保程式不會出現改 A 壞 B 的情況。從商業角度來看，測試能降低維護與改善程式的成本，進而提高軟體開發的競爭力。..."
}</script></article></main><footer><div class="footer-logos"><a href="https://medium.com/@ken00535" rel="noopener noreferrer" target="_blank"><img alt="medium" height="50" src="/img/icons/icon_social media_medium.svg" width="50"></a><a href="https://www.linkedin.com/in/ken00535" rel="noopener noreferrer" target="_blank"><img alt="linkedin" height="30" src="/img/icons/icon_social media_linkedln.svg" width="30"></a><a href="https://blog.kenwsc.com/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" height="30" src="/img/icons/rss-feed.svg" width="30"></a></div><div class="copyright">© 2022 Ken Chen's Blog, Powered by <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>