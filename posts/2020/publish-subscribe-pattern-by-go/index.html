<!DOCTYPE html><html domain="blog.kenwsc.com" ga-id="G-G76M9XJCKN" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="Backend,Golang" name="keywords"><link href="/img/favicon/favicon.png?hash=b6fc65e341" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>模組間的解耦合：發佈/訂閱模型</title><meta content="模組間的解耦合：發佈/訂閱模型" property="og:title"><meta content="模組間的解耦合：發佈/訂閱模型" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="Golang 的哲學是簡單，語言上更強調小元件的延展與復用，例如使用組合取代繼承，使用 Goroutine 取代 Thread 等。本文會講解怎麼使用 channel 來實現 Observer Pattern，或者更現代的說法，實現 Publish/Subscribe 的架構，來建構彼此獨立的模組。…" name="description"><meta content="Golang 的哲學是簡單，語言上更強調小元件的延展與復用，例如使用組合取代繼承，使用 Goroutine 取代 Thread 等。本文會講解怎麼使用 channel 來實現 Observer Pattern，或者更現代的說法，實現 Publish/Subscribe 的架構，來建構彼此獨立的模組。…" name="twitter:description"><meta content="Golang 的哲學是簡單，語言上更強調小元件的延展與復用，例如使用組合取代繼承，使用 Goroutine 取代 Thread 等。本文會講解怎麼使用 channel 來實現 Observer Pattern，或者更現代的說法，實現 Publish/Subscribe 的架構，來建構彼此獨立的模組。…" property="og:description"><meta content="article" property="og:type"><meta content="https://blog.kenwsc.com/posts/2020/publish-subscribe-pattern-by-go/" property="og:url"><meta content="Ken Chen's Blog" property="og:site_name"><meta content="https://blog.kenwsc.com/img/posts/2020/publish-subscribe-pattern-by-go/cover.png" property="og:image"><meta content="https://blog.kenwsc.com/img/posts/2020/publish-subscribe-pattern-by-go/cover.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://blog.kenwsc.com/posts/2020/publish-subscribe-pattern-by-go/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Ken Chen's Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-G76M9XJCKN"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-G76M9XJCKN');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}.article-footer img,body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b{font-weight:700}sub{font-size:75%;line-height:0;position:relative;vertical-align:baseline;bottom:-.25em}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:1.75rem}body,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}button,code{border-radius:.3em}code{color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2{font-family:var(--font-family)}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ul{margin-bottom:0}blockquote{padding:0 1.5em;margin:1.5em 0 1.5em 1.5em;border-left:4px solid var(--primary)}blockquote footer{background:0 0;display:block;color:#ccc;padding:.75em 0;font-size:90%;text-align:start}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.property{color:#f8c555}.token.builtin,.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}#nav,.menu__btn{position:relative}.menu__btn{display:inline-block;width:24px;height:24px}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav{height:68px;z-index:2;align-items:center}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}#nav,.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}footer{margin-top:48px;font-size:14px;padding:24px;border-top:1px solid #ccc;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.post-tag:not(body){text-decoration:none;background-color:#f5f5f5;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border-radius:20px;color:#4a4a4a;display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;font-size:.75rem;height:2em;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;line-height:1.5;padding-left:.75em;padding-right:.75em;white-space:nowrap}.post-tag:hover{text-decoration:none;background:#ccc}.direct-link{display:none}.post-avatar{display:flex;align-items:center;height:36px}.post-avatar__time{font-size:13px}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}</style></head><body><header><nav><div id="nav"><div class="nav__links"><a href="/" title="Homepage">Home</a> <a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">模組間的解耦合：發佈/訂閱模型</h1><aside class="w-full"><div class="post-avatar"><div class="post-avatar__time">Ken Chen | 13 Jul 2020 <a href="/tags/go/" class="post-tag">Go</a> <a href="/tags/design-pattern/" class="post-tag">Design Pattern</a></div></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>Observer Pattern 是物件導向常用的架構，例如多個 Chart 與單一 Data Source 的互動，就可以使用 Observer Pattern 設計，好避免資料不同步的問題。而且 Observer Pattern 可以切開 Subject 跟 Observer，讓個別模組的功能更明確，修改副作用更小。</p><p>Golang 的哲學是簡單，語言上更強調小元件的延展與復用，例如使用組合取代繼承，使用 Goroutine 取代 Thread 等。本文會講解怎麼使用 channel 來實現 Observer Pattern，或者更現代的說法，實現 Publish/Subscribe 的架構，來建構彼此獨立的模組。</p><h2 id="introduce-observer-pattern"><a href="#introduce-observer-pattern" class="direct-link">#</a> Introduce Observer Pattern</h2><p>先來對 Observer Pattern 做個解說。依照 GoF 的物件導向經典《Design Pattern》，Observer Pattern 的需求場景是</p><blockquote><p>定義對象間的一種一對多的依賴關係，當一個對象的狀態發生改變時，所有依賴於它的對象都得到通知並被自動更新。</p></blockquote><p>我們可以想像成訂閱報紙的情境，當現在有個新的事件發生，所有有訂閱報紙的讀者，都可以收到最新的事件訊息，讀者可以根據這個訊息來採取反應，例如買賣股票、規劃行程、改變計劃等。報紙的發行人不知道讀者會採取什麼行動，它只負責將消息傳遞給讀者。</p><p>如果將 Observer Pattern 用 Class Diagram 來表示，會是</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/publish-subscribe-pattern-by-go/pattern-1-1920w.webp 1920w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-1-1280w.webp 1280w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-1-840w.webp 840w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/publish-subscribe-pattern-by-go/pattern-1-1920w.png 1920w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-1-1280w.png 1280w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-1-840w.png 840w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-1-320w.png 320w" type="image/png"><img alt="" src="/img/posts/2020/publish-subscribe-pattern-by-go/pattern-1-1920w.png" height="389" width="1039" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1039 389'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApElEQVQImUWN0Q6CIAAA/f/fykpFbSHQzInZkIZMneAApxs9tOqe7uG2C+IouhHSUCqltNZprdd1vZclhHDfd/8lSAG45DljDBUwS0FDqfdeCPGRfyel7LpuWRattTHGOTdNI8YIXq/Pth2Goe/7F+dBHJ0zAGhdP5oGFQXnXAhxCg8EY8Y6jFCSJFVVBccwJBjPs1JKjePgnPXeW2uNMdu2/b5vnjOwIkf+PlEAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>由圖中可以看到，主要分成兩個物件，Subject 知道有誰訂閱，當發生消息時，會 Notify 所有訂閱者，要求它們 Update；Observer 則實作 Update，會由 Subject 中取得最新資料，以供後續使用。將前後順序用 Sequence Diagram 來表示後，就會是</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/publish-subscribe-pattern-by-go/pattern-2-1920w.webp 1920w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-2-1280w.webp 1280w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-2-840w.webp 840w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/publish-subscribe-pattern-by-go/pattern-2-1920w.png 1920w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-2-1280w.png 1280w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-2-840w.png 840w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-2-320w.png 320w" type="image/png"><img alt="" src="/img/posts/2020/publish-subscribe-pattern-by-go/pattern-2-1920w.png" height="431" width="923" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 923 431'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAIAAAAcxIEBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfUlEQVQImT3M3QpEERRAYe//dMqN5EpKfs8Oob3D1Mxp1vXXYjlnY8ycs9bKObfWImKtNYTgvW+tsXOOlDKEsPcGgDnn/YaIRHTvZUSktX6eh4icc2OMv0DEVyilnHPeeyFESomIEBEA1lqvMMaUUnrvAJBSaq3FGIUQv98HgNibTRzirGgAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h2 id="design-pub%2Fsub-module"><a href="#design-pub%2Fsub-module" class="direct-link">#</a> Design Pub/Sub Module</h2><p>我們的需求是設計一個發佈/訂閱的模組，用於支撐商業邏輯的開發。這個模組類似於中間人的角色，發佈者透過這個模組來發佈訊息，模組也會負責將收到的訊息轉發給訂閱者。</p><p>專案架構為</p><pre><code>project
├── cmd
├── pkg
│   └── pubsub
│       └── pubsub.go
├── scripts
│   └── build_win.bat
├── go.mod
└── README.md
</code></pre><p>完整的程式碼如下</p><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> pubsub<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>    <span class="token string">"fmt"</span><br>    <span class="token string">"sync"</span><br><span class="token punctuation">)</span><br><br><span class="token comment">// DataType is data type of message</span><br><span class="token keyword">type</span> DataType <span class="token builtin">string</span><br><br><span class="token comment">// Client is a client of pub/sub pattern</span><br><span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    writer  <span class="token keyword">chan</span> DataType<br>    readers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">chan</span> DataType<br>    mutex   sync<span class="token punctuation">.</span>Mutex<br><span class="token punctuation">}</span><br><br><span class="token comment">// Pub publish message</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Pub</span><span class="token punctuation">(</span>data DataType<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    m<span class="token punctuation">.</span>writer <span class="token operator">&lt;-</span> data<br><span class="token punctuation">}</span><br><br><span class="token comment">// Sub subscribe message</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Sub</span><span class="token punctuation">(</span>handler <span class="token keyword">func</span><span class="token punctuation">(</span>DataType<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    m<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">defer</span> m<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    readChannel <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> DataType<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><br>    m<span class="token punctuation">.</span>readers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>readers<span class="token punctuation">,</span> readChannel<span class="token punctuation">)</span><br>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> <span class="token punctuation">{</span><br>            data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>readChannel<br>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">handler</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// NewClient new a client</span><br><span class="token keyword">func</span> <span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Client <span class="token punctuation">{</span><br>    broker <span class="token operator">:=</span> <span class="token operator">&</span>Client<span class="token punctuation">{</span><br>        writer<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> DataType<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> <span class="token punctuation">{</span><br>            data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>broker<span class="token punctuation">.</span>writer<br>            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> reader <span class="token operator">:=</span> <span class="token keyword">range</span> broker<span class="token punctuation">.</span>readers <span class="token punctuation">{</span><br>                reader <span class="token operator">&lt;-</span> data<br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> broker<br><span class="token punctuation">}</span></code></pre><p>一段一段來看。</p><p>首先定義訊息格式 DataType，假設為 string，但可依照需求自行定義，如果要傳輸的格式比較複雜，也可以定義成 struct</p><pre class="language-go"><code class="language-go"><span class="token comment">// DataType is data type of message</span><br><span class="token keyword">type</span> DataType <span class="token builtin">string</span></code></pre><p>定義用戶端，讓創建此用戶端的人，可以進行 pub/sub。這邊用 channel 做為 pub/sub 溝通的管道。</p><p>channel 在 Golang 中，類似 Linux 的 pipeline 概念，常用於在兩個不同的 Go routine 間傳遞資料。</p><p><img alt="https://www.slideshare.net/ssuser9ebf46/golang-101" src="https://cdn-images-1.medium.com/max/2000/0*y05M3ztJWGbFsn-u"><em><a href="https://www.slideshare.net/ssuser9ebf46/golang-101" rel="noopener noreferrer" target="_blank">https://www.slideshare.net/ssuser9ebf46/golang-101</a></em></p><p>writer 這個 channel 用於接受發佈訊息，經由中間人的 Goroutine 後，會將訊息用各訂閱的 channel readers，轉交給訂閱者的 Goroutine</p><pre class="language-go"><code class="language-go"><span class="token comment">// Client is a client of pub/sub pattern</span><br><span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    writer  <span class="token keyword">chan</span> DataType<br>    readers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">chan</span> DataType<br>    mutex   sync<span class="token punctuation">.</span>Mutex<br><span class="token punctuation">}</span></code></pre><p>實現 pub 的邏輯，當使用者輸入訊息後，將此訊息丟到 channel 中</p><pre class="language-go"><code class="language-go"><span class="token comment">// Pub publish message</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Pub</span><span class="token punctuation">(</span>data DataType<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    m<span class="token punctuation">.</span>writer <span class="token operator">&lt;-</span> data<br><span class="token punctuation">}</span></code></pre><p>實現 sub 的邏輯，當使用者訂閱時，創建一個新的 channel，並將它加入 readers 的陣容內，同時啟動 Goroutine，持續監聽這個 channel。如果有任何訊息進來，調用使用者註冊的 handler 來處理這則訊息。</p><p>Goroutine 是 Golang 的最大特色，類似其他語言中的 Thread，中文翻成協程，相對 Thread 輕量，適合用在高併發的場景。它的底層對應到內部的 scheduler，會根據當前的狀況來決定調用哪個 Goroutine。我們利用 Go routine 來實現 Publish/Subscribe 的架構，可以更有效率處理訂閱問題。</p><p>使用 Goroutine 只要用關鍵字 go 即可</p><pre class="language-go"><code class="language-go"><span class="token comment">// Sub subscribe message</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Sub</span><span class="token punctuation">(</span>handler <span class="token keyword">func</span><span class="token punctuation">(</span>DataType<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    m<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">defer</span> m<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    readChannel <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> DataType<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><br>    m<span class="token punctuation">.</span>readers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>readers<span class="token punctuation">,</span> readChannel<span class="token punctuation">)</span><br>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> <span class="token punctuation">{</span><br>            data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>readChannel<br>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">handler</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>接著建立 writer 與 readers 間的轉發關係。</p><p>當 Client 初始化時，建立 writer，同時用 Goroutine 來監看 writer，如果 writer 內有任何的訊息，Goroutine 會遍歷 readers，將消息轉發給 readers。</p><pre class="language-go"><code class="language-go"><span class="token comment">// NewClient new a client</span><br><span class="token keyword">func</span> <span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Client <span class="token punctuation">{</span><br>    broker <span class="token operator">:=</span> <span class="token operator">&</span>Client<span class="token punctuation">{</span><br>    writer<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> DataType<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> <span class="token punctuation">{</span><br>            data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>broker<span class="token punctuation">.</span>writer<br>            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> reader <span class="token operator">:=</span> <span class="token keyword">range</span> broker<span class="token punctuation">.</span>readers <span class="token punctuation">{</span><br>                reader <span class="token operator">&lt;-</span> data<br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> broker<br><span class="token punctuation">}</span></code></pre><h2 id="step-3%3A-use-pub%2Fsub-module"><a href="#step-3%3A-use-pub%2Fsub-module" class="direct-link">#</a> Step 3: Use Pub/Sub Module</h2><p>完成模組開發後，再來就是使用模組了，新增使用的主程式</p><pre><code>project
├── cmd
│   └── pubsub
│       └── main.go
├── pkg
│   └── pubsub
│       └── pubsub.go
├── scripts
│   └── build_win.bat
├── go.mod
└── README.md
</code></pre><p>內容是</p><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>    <span class="token string">"errors"</span><br>    <span class="token string">"example/pkg/pubsub"</span><br>    <span class="token string">"fmt"</span><br>    <span class="token string">"time"</span><br><span class="token punctuation">)</span><br><br><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    client <span class="token operator">:=</span> pubsub<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">var</span> printMessage <span class="token keyword">func</span><span class="token punctuation">(</span>pubsub<span class="token punctuation">.</span>DataType<span class="token punctuation">)</span> <span class="token builtin">error</span><br>    printMessage <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>msg pubsub<span class="token punctuation">.</span>DataType<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> msg <span class="token operator">==</span> <span class="token string">"error"</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"this is an error"</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><br>        <span class="token keyword">return</span> <span class="token boolean">nil</span><br>    <span class="token punctuation">}</span><br>    client<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>printMessage<span class="token punctuation">)</span><br>    client<span class="token punctuation">.</span><span class="token function">Pub</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><br>    client<span class="token punctuation">.</span><span class="token function">Pub</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><br>    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>使用模組內的初始化函式（因為 Golang 不是物件導向語言，沒有建構式），來取得要使用的 client</p><pre class="language-go"><code class="language-go">client <span class="token operator">:=</span> pubsub<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>建立 handler 做為訂閱時的 callback function，當訂閱的訊息出現時，調用這個 handler 來處理。這裡建立的 handler 會判斷訊息是不是 error 這個字串，如果是的話，回傳錯誤訊息，否則正常印出訊息</p><pre class="language-go"><code class="language-go"><span class="token keyword">var</span> printMessage <span class="token keyword">func</span><span class="token punctuation">(</span>pubsub<span class="token punctuation">.</span>DataType<span class="token punctuation">)</span> <span class="token builtin">error</span><br>printMessage <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>msg pubsub<span class="token punctuation">.</span>DataType<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> msg <span class="token operator">==</span> <span class="token string">"error"</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"this is an error"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><br>    <span class="token keyword">return</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span></code></pre><p>最後訂閱與發佈訊息</p><p>用 Sub 註冊訂閱用的 handler；用 Pub 發佈訊息。發佈的訊息有兩則，第一則是正常訊息，內容是 Hello；第二則是 error 訊息，如果正常運行的話，會讓 handler 回傳錯誤</p><pre class="language-go"><code class="language-go">client<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>printMessage<span class="token punctuation">)</span><br>client<span class="token punctuation">.</span><span class="token function">Pub</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><br>client<span class="token punctuation">.</span><span class="token function">Pub</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><br>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span></code></pre><p>實際執行</p><pre class="language-bash"><code class="language-bash">D:<span class="token punctuation">\</span>git<span class="token punctuation">\</span>golang-project<span class="token operator">></span>.<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>pubsub.exe<br>Hello<br>this is an error</code></pre><p>得到訊息內容跟 error！</p><h2 id="multiple-topic"><a href="#multiple-topic" class="direct-link">#</a> Multiple Topic</h2><p>在前面的設計中，已經可以進行發佈跟訂閱了，但如果想要訂閱多個主題，就需要建立多個 client，用起來很麻煩，這衍生出新的需求：我們需要擴充原來的介面，使它可以支持多主題訂閱</p><p>回去修改模組為</p><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> pubsub<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>    <span class="token string">"fmt"</span><br>    <span class="token string">"sync"</span><br><span class="token punctuation">)</span><br><br><span class="token comment">// DataType is data type of message</span><br><span class="token keyword">type</span> DataType <span class="token builtin">string</span><br><br><span class="token comment">// MessageChannel is a channel of pub/sub pattern</span><br><span class="token keyword">type</span> MessageChannel <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    writer  <span class="token keyword">chan</span> DataType<br>    readers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">chan</span> DataType<br>    mutex   sync<span class="token punctuation">.</span>Mutex<br><span class="token punctuation">}</span><br><br><span class="token comment">// Client is client of pub/sub pattern</span><br><span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    topic <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>MessageChannel<br><span class="token punctuation">}</span><br><br><span class="token comment">// Pub publish message</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Pub</span><span class="token punctuation">(</span>topic <span class="token builtin">string</span><span class="token punctuation">,</span> data DataType<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>writer <span class="token operator">&lt;-</span> data<br><span class="token punctuation">}</span><br><br><span class="token comment">// Sub subscribe message</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Sub</span><span class="token punctuation">(</span>topic <span class="token builtin">string</span><span class="token punctuation">,</span> handler <span class="token keyword">func</span><span class="token punctuation">(</span>DataType<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">defer</span> m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    readChannel <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> DataType<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><br>    m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>readers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>readers<span class="token punctuation">,</span> readChannel<span class="token punctuation">)</span><br>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> <span class="token punctuation">{</span><br>            data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>readChannel<br>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">handler</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// AddTopic publish message</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">AddTopic</span><span class="token punctuation">(</span>topic <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&</span>MessageChannel<span class="token punctuation">{</span><br>        writer<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> DataType<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> <span class="token punctuation">{</span><br>            data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>writer<br>            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> reader <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>readers <span class="token punctuation">{</span><br>                reader <span class="token operator">&lt;-</span> data<br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// NewClient new a client</span><br><span class="token keyword">func</span> <span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Client <span class="token punctuation">{</span><br>    client <span class="token operator">:=</span> <span class="token operator">&</span>Client<span class="token punctuation">{</span><br>        topic<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>MessageChannel<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> client<br><span class="token punctuation">}</span></code></pre><p>在原來的架構上，再抽象一層，重新命名原來的 Client 為 MessageChannel，負責各 Topic 的實際執行。上面則建立新的 Client，內部是一個 map，可以放置多個 MessageChannel，好實現多主題的訂閱</p><pre class="language-go"><code class="language-go"><span class="token comment">// MessageChannel is a channel of pub/sub pattern</span><br><span class="token keyword">type</span> MessageChannel <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    writer  <span class="token keyword">chan</span> DataType<br>    readers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">chan</span> DataType<br>    mutex   sync<span class="token punctuation">.</span>Mutex<br><span class="token punctuation">}</span><br><br><span class="token comment">// Client is client of pub/sub pattern</span><br><span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    topic <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>MessageChannel<br><span class="token punctuation">}</span></code></pre><p>當 Pub/Sub 時，會取出對應 Topic 的 MessageChannel，進行 Pub/Sub</p><pre class="language-go"><code class="language-go"><span class="token comment">// Pub publish message</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Pub</span><span class="token punctuation">(</span>topic <span class="token builtin">string</span><span class="token punctuation">,</span> data DataType<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>writer <span class="token operator">&lt;-</span> data<br><span class="token punctuation">}</span><br><br><span class="token comment">// Sub subscribe message</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Sub</span><span class="token punctuation">(</span>topic <span class="token builtin">string</span><span class="token punctuation">,</span> handler <span class="token keyword">func</span><span class="token punctuation">(</span>DataType<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">defer</span> m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    readChannel <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> DataType<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><br>    m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>readers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>readers<span class="token punctuation">,</span> readChannel<span class="token punctuation">)</span><br>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> <span class="token punctuation">{</span><br>            data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>readChannel<br>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">handler</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>新增 AddTopic，當使用者要使用新的 Topic 時，會在內部建立轉發機制</p><pre class="language-go"><code class="language-go"><span class="token comment">// AddTopic publish message</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">AddTopic</span><span class="token punctuation">(</span>topic <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&</span>MessageChannel<span class="token punctuation">{</span><br>        writer<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> DataType<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> <span class="token punctuation">{</span><br>            data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>writer<br>            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> reader <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>topic<span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">.</span>readers <span class="token punctuation">{</span><br>                reader <span class="token operator">&lt;-</span> data<br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>同時修改使用的程式碼 main.go，改為</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    client <span class="token operator">:=</span> pubsub<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    client<span class="token punctuation">.</span><span class="token function">AddTopic</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><br>    client<span class="token punctuation">.</span><span class="token function">AddTopic</span><span class="token punctuation">(</span><span class="token string">"echo"</span><span class="token punctuation">)</span><br>    <span class="token keyword">var</span> printMessage <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>msg pubsub<span class="token punctuation">.</span>DataType<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> msg <span class="token operator">==</span> <span class="token string">"error"</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"This is an error"</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><br>        <span class="token keyword">return</span> <span class="token boolean">nil</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">var</span> echoMessage <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>msg pubsub<span class="token punctuation">.</span>DataType<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>msg <span class="token operator">+</span> <span class="token string">" nice to meet you!"</span><span class="token punctuation">)</span><br>        <span class="token keyword">return</span> <span class="token boolean">nil</span><br>    <span class="token punctuation">}</span><br>    client<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> printMessage<span class="token punctuation">)</span><br>    client<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"echo"</span><span class="token punctuation">,</span> echoMessage<span class="token punctuation">)</span><br>    client<span class="token punctuation">.</span><span class="token function">Pub</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"Hello"</span><span class="token punctuation">)</span><br>    client<span class="token punctuation">.</span><span class="token function">Pub</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">)</span><br>    client<span class="token punctuation">.</span><span class="token function">Pub</span><span class="token punctuation">(</span><span class="token string">"echo"</span><span class="token punctuation">,</span> <span class="token string">"Go"</span><span class="token punctuation">)</span><br>    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>在這個例子中，對 hello、echo 兩個 topic 進行訂閱</p><pre class="language-go"><code class="language-go">client<span class="token punctuation">.</span><span class="token function">AddTopic</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><br>client<span class="token punctuation">.</span><span class="token function">AddTopic</span><span class="token punctuation">(</span><span class="token string">"echo"</span><span class="token punctuation">)</span></code></pre><p>兩個訂閱有不同的 handler。echo 除了印出訊息外，也副加其他內容</p><pre class="language-go"><code class="language-go"><span class="token keyword">var</span> echoMessage <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>msg pubsub<span class="token punctuation">.</span>DataType<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>msg <span class="token operator">+</span> <span class="token string">" nice to meet you!"</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span></code></pre><p>對兩個 Topic 進行發佈/訂閱</p><pre class="language-go"><code class="language-go">client<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> printMessage<span class="token punctuation">)</span><br>client<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"echo"</span><span class="token punctuation">,</span> echoMessage<span class="token punctuation">)</span><br>client<span class="token punctuation">.</span><span class="token function">Pub</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"Hello"</span><span class="token punctuation">)</span><br>client<span class="token punctuation">.</span><span class="token function">Pub</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">)</span><br>client<span class="token punctuation">.</span><span class="token function">Pub</span><span class="token punctuation">(</span><span class="token string">"echo"</span><span class="token punctuation">,</span> <span class="token string">"Go"</span><span class="token punctuation">)</span></code></pre><p>確認成果</p><pre class="language-bash"><code class="language-bash">Go <span class="token function">nice</span> to meet you<span class="token operator">!</span><br>Hello<br>This is an error</code></pre><h2 id="%E5%B0%8F%E7%B5%90"><a href="#%E5%B0%8F%E7%B5%90" class="direct-link">#</a> 小結</h2><p>用 Golang 完成 Pub/Sub 模型後，可以回去跟標準的 Observer Pattern 比較。兩者的概念是類似的，中間都有一段程式碼負責轉發訊息，在 Observer Pattern 是 Notify，在我們的設計中，是 AddTopic 的 Goroutine。</p><p>Observer Pattern 在設計上，是由發佈者調用 Subject 的函式 SetState 來發佈訊息，再由各訂閱者自行調用 Subject 的函式來獲得訂閱的訊息，Subject 在中間只充當通知的角色。整個動作是由發佈者發起，並在發佈者的 thread 中執行，如果想要併發的效果，則需要另外設計。</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/publish-subscribe-pattern-by-go/pattern-3-1920w.webp 1920w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-3-1280w.webp 1280w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-3-840w.webp 840w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-3-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2020/publish-subscribe-pattern-by-go/pattern-3-1920w.png 1920w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-3-1280w.png 1280w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-3-840w.png 840w, /img/posts/2020/publish-subscribe-pattern-by-go/pattern-3-320w.png 320w" type="image/png"><img alt="" src="/img/posts/2020/publish-subscribe-pattern-by-go/pattern-3-1920w.png" height="431" width="923" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 923 431'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAIAAAAcxIEBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfUlEQVQImT3M3QpEERRAYe//dMqN5EpKfs8Oob3D1Mxp1vXXYjlnY8ycs9bKObfWImKtNYTgvW+tsXOOlDKEsPcGgDnn/YaIRHTvZUSktX6eh4icc2OMv0DEVyilnHPeeyFESomIEBEA1lqvMMaUUnrvAJBSaq3FGIUQv98HgNibTRzirGgAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Golang 由於有 Goroutine 跟 channel，在設計上可以更精巧，發佈者與訂閱者都有各自獨立的 Goroutine 在處理，效率高得多；而且因為有 channel 的存在，使得 Goroutine 推送或接收訊息時，無須理會其他模組的執行狀況，即使有 Fail 的情形，也不會影響到其他模組。簡單講，因為併發實現的成本降低了，可以更容易享受到併發的優勢。</p><p>在設計處理上，Golang 似乎認為 OOP 過早強調設計，導致編寫程式碼時，都需要先定義類別，這樣會讓程式碼因為類別而硬化，重構時需要反覆對類別進行 Push Up 跟 Push Down，有看過 Martin Fowler 的《Refactoring》應該會很有感，整本書的精神就在講如何重新設計類別。</p><p>Golang 的概念更偏向使用時才設計，例如處理函式不用放在事先定義的 Update 中，而是訂閱時才有的 echoMessage，某程度上，Golang 不強調模型，而是強調使用。</p><h2 id="reference"><a href="#reference" class="direct-link">#</a> Reference</h2><ul><li><a href="https://tour.golang.org/concurrency/1" rel="noopener noreferrer" target="_blank">A Tour of Go</a></li></ul><div class="article-footer"></div><div><p style="font-weight: bold;">標籤</p><div class="post-tags"><a href="/tags/go/" class="post-tag">Go</a> <a href="/tags/design-pattern/" class="post-tag">Design Pattern</a></div><p style="font-weight: bold;">其他文章</p><ul><li><a href="/posts/2022/concurrency-of-go-worker-pool/">Goroutine 的併發治理：管理 Worker Pool</a></li><li><a href="/posts/2020/use-protobuf-in-golang/">一種更緊湊的數據格式：Protobuf 入門</a></li><li><a href="/posts/2019/send-gmail-with-python/">從零開始的 SMTP：以 Python 為例</a></li><li><a href="/posts/2019/visualize-your-redmine-data/">掌握 Redmine 的活動指標：繪製熱度圖</a></li><li><a href="/posts/2019/using-physical-disc-with-virtualbox/">用 VirtualBox 開啟實體硬碟中的 Windows</a></li></ul></div><p style="font-weight: bold;">評論</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="ken00535/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"模組間的解耦合：發佈/訂閱模型","image":["https://blog.kenwsc.com/img/posts/2020/publish-subscribe-pattern-by-go/pattern-1-1920w.png","https://blog.kenwsc.com/img/posts/2020/publish-subscribe-pattern-by-go/pattern-2-1920w.png","https://cdn-images-1.medium.com/max/2000/0*y05M3ztJWGbFsn-u","https://blog.kenwsc.com/img/posts/2020/publish-subscribe-pattern-by-go/pattern-3-1920w.png"],"author":{"@type":"Person","name":""},"publisher":{"@type":"Organization","name":"Ken Chen&#39;s Blog","url":"https://blog.kenwsc.com","logo":{"@type":"ImageObject","url":"https://blog.kenwsc.com/img/favicon/favicon.png","width":512,"height":512}},"url":"https://blog.kenwsc.com/posts/2020/publish-subscribe-pattern-by-go/","mainEntityOfPage":"https://blog.kenwsc.com/posts/2020/publish-subscribe-pattern-by-go/","datePublished":"2020-07-13","dateModified":"2022-12-27","description":"Observer Pattern 是物件導向常用的架構，例如多個 Chart 與單一 Data Source 的互動，就可以使用 Observer Pattern 設計，好避免資料不同步的問題。而且 Observer Pattern 可以切開 Subject 跟..."}</script></article></main><footer><div class="footer-logos"><a href="https://medium.com/@ken00535" rel="noopener noreferrer" target="_blank"><img alt="medium" src="/img/icons/icon_social media_medium.svg" height="50" width="50"></a><a href="https://www.linkedin.com/in/ken00535" rel="noopener noreferrer" target="_blank"><img alt="linkedin" src="/img/icons/icon_social media_linkedln.svg" height="30" width="30"></a><a href="https://blog.kenwsc.com/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" src="/img/icons/rss-feed.svg" height="30" width="30"></a></div><div class="copyright">© 2022 Ken Chen's Blog, Powered by <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>