<!DOCTYPE html><html domain="blog.kenwsc.com" ga-id="GTM-MM4P38S" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="Backend,Golang" name="keywords"><link href="/img/favicon/favicon.png?hash=b6fc65e341" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>OAuth 2.0 的身份認證：OpenID Connect</title><meta content="OAuth 2.0 的身份認證：OpenID Connect" property="og:title"><meta content="OAuth 2.0 的身份認證：OpenID Connect" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="OAuth 2 讓網路服務可以存取第三方的受保護資源，因此，有些開發者進一步利用 OAuth 2 來進行認證。但這中間會存在著一些語義落差，因為 OAuth 2 當初設計目的是「授權」而不是「認證」，兩者關注的焦點會有些不同。OpenID Connect 是基於 OAuth 2 的一套身份認證協定，讓開發者可以在 OAuth 2 授權的基礎上，也加入標準的認證流程。在這篇文章中，我會說明授權跟認證的場景有何差異，並講解 OpenID Connect 如何滿足認證的需要。..." name="description"><meta content="OAuth 2 讓網路服務可以存取第三方的受保護資源，因此，有些開發者進一步利用 OAuth 2 來進行認證。但這中間會存在著一些語義落差，因為 OAuth 2 當初設計目的是「授權」而不是「認證」，兩者關注的焦點會有些不同。OpenID Connect 是基於 OAuth 2 的一套身份認證協定，讓開發者可以在 OAuth 2 授權的基礎上，也加入標準的認證流程。在這篇文章中，我會說明授權跟認證的場景有何差異，並講解 OpenID Connect 如何滿足認證的需要。..." name="twitter:description"><meta content="OAuth 2 讓網路服務可以存取第三方的受保護資源，因此，有些開發者進一步利用 OAuth 2 來進行認證。但這中間會存在著一些語義落差，因為 OAuth 2 當初設計目的是「授權」而不是「認證」，兩者關注的焦點會有些不同。OpenID Connect 是基於 OAuth 2 的一套身份認證協定，讓開發者可以在 OAuth 2 授權的基礎上，也加入標準的認證流程。在這篇文章中，我會說明授權跟認證的場景有何差異，並講解 OpenID Connect 如何滿足認證的需要。..." property="og:description"><meta content="article" property="og:type"><meta content="https://blog.kenwsc.com/posts/2023/openid-connect/" property="og:url"><meta content="Ken Chen's Blog" property="og:site_name"><meta content="https://blog.kenwsc.com/img/posts/2023/openid-connect/cover.png" property="og:image"><meta content="https://blog.kenwsc.com/img/posts/2023/openid-connect/cover.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://blog.kenwsc.com/posts/2023/openid-connect/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Ken Chen's Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
            var f = d.getElementsByTagName(s)[0];
            var j = d.createElement(s);
            var dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-MM4P38S');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}dl{clear:both;display:block!important;margin:0 0 1.5em}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}sub{font-size:75%;line-height:0;position:relative;vertical-align:baseline;bottom:-.25em}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:1.75rem}body,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}button,code{border-radius:.3em}code{color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2{font-family:var(--font-family)}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li dl,li ul{margin-bottom:0}blockquote{padding:0 1.5em;margin:1.5em 0 1.5em 1.5em;border-left:4px solid var(--primary)}blockquote footer{background:0 0;display:block;color:#ccc;padding:.75em 0;font-size:90%;text-align:start}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.property{color:#f8c555}.token.builtin,.token.keyword{color:#cc99cd}.token.string,.token.variable{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:240px;height:40px;background:url(/img/logo.png) no-repeat;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;border-top:1px solid #ccc;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.post-tag:not(body){text-decoration:none;background-color:#f5f5f5;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border-radius:20px;color:#4a4a4a;display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;font-size:.75rem;height:2em;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;line-height:1.5;padding-left:.75em;padding-right:.75em;white-space:nowrap}.post-tag:hover{text-decoration:none;background:#ccc}.direct-link{display:none}.post-avatar{display:flex;align-items:center;height:36px}.post-avatar__time{font-size:13px}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:240px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px;width:max-content}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">文章列表</a> <a href="/tags/">標籤</a> <a href="/about/">關於我</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">OAuth 2.0 的身份認證：OpenID Connect</h1><aside class="w-full"><div class="post-avatar"><div class="post-avatar__time">Ken Chen | 20 Jan 2023 <a href="/tags/web/" class="post-tag">Web</a> <a href="/tags/authentication/" class="post-tag">Authentication</a></div></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>OAuth 2 讓網路服務可以存取第三方的受保護資源，因此，有些開發者會進一步利用 OAuth 2 來進行使用者認證。但這中間存在著一些語義落差，因為 OAuth 2 當初設計目的是「授權」而不是「認證」，兩者關注的焦點會有些不同。OpenID Connect 是基於 OAuth 2 的一套身份認證協定，讓開發者可以在 OAuth 2 授權的基礎上，再加入標準的認證流程。在這篇文章中，我會說明授權跟認證的場景有何差異，並講解 OpenID Connect 如何滿足認證需求。</p><p>因為 OpenID Connect 是建構在 OAuth 2 的基礎上，我會假設這篇文章的讀者已經知道 OAuth 2 的組件與流程，如果你不熟悉，可以先閱讀另外兩篇文章</p><ul><li><a href="https://blog.kenwsc.com/posts/2022/oauth-2-0-roles-and-channels/">OAuth 2.0：角色與信道</a></li><li><a href="https://blog.kenwsc.com/posts/2022/oauth-2-0-authorization-grant/">OAuth 2.0：授權許可</a></li></ul><h2 id="%E8%AA%8D%E8%AD%89-vs-%E6%8E%88%E6%AC%8A"><a href="#%E8%AA%8D%E8%AD%89-vs-%E6%8E%88%E6%AC%8A" class="direct-link">#</a> 認證 vs 授權</h2><p><strong>認證(Authentication)</strong> 是證明身份(identity)的機制，它包含兩個問題：你是誰？你怎麼證明？想想餐廳訂位的例子，你需要告知服務生你的姓名與手機電話，她才會幫你帶位。在網路服務中，這兩個問題最常見的形式是：你的帳號是什麼？密碼是什麼？通常這兩個問題會一起問，以防止惡意人士探查特定的人(identity)是否是服務的使用者。當然，如果只憑單項證明，只要證明洩漏，身份就會被冒用，因此像是銀行開戶，會需要攜帶雙證件，讓身份更為安全，在資安上，這稱為多重要素認證(MFA)。</p><p><strong>授權(Authorization)</strong> 則是授予資源存取權限的機制，它包含的問題是：要開放哪些資源？開放給誰？假設你有物品遺忘在車上，你將車鑰匙給朋友，請他去車上幫忙把東西拿過來。你就開放了車子這項資源，而對象則是你的朋友。授權跟身份不一定有關，像是 Facebook 的動態可以只設為私人消息，只開放給特定的朋友；也可以設為公開消息，讓所有人都看到。如果你只開放給特定的人，顯然在看到你的訊息前，就需要先經過認證了。</p><p>以 OAuth 2 的流程來說，Client 會要求使用者授權，讓它可以存取第三方資源。當使用者被導向到 Authorization Server 後，Authorization Server 會先請使用者認證，等確認身份沒問題，就會緊接著要求授權。授權結果會用 Token 交給 Client，讓 Client 可以存取受保護資源。</p><h2 id="oauth-2-%E7%9A%84%E5%95%8F%E9%A1%8C"><a href="#oauth-2-%E7%9A%84%E5%95%8F%E9%A1%8C" class="direct-link">#</a> OAuth 2 的問題</h2><p>既然 OAuth 2 的流程有要求使用者認證，也有把授權結果轉成 Token 交給 Client。那為什麼還有問題呢？回到原點，我們來問問 Client 要如何回答認證的兩個問題。首先是「我是誰？」，Client 知道使用者是誰嗎？因為使用者是跟 Authorization Server 認證，Authorization Server 知道使用者的身份，但 Authorization Server 交給 Client 只是個 Token，而依照 OAuth 2 的規範，這個 Token 應該要是不透明的</p><blockquote><p>Access tokens are credentials used to access protected resources. An access token is a string representing an authorization issued to the client. The string is usually opaque to the client.</p><p>訪問令牌是用來訪問受保護資源的憑證。訪問令牌是個字串，用以表達簽發給 Client 的授權。這個字串通常對 Client 來說不透明。</p></blockquote><p>因此，Client 只知道自己拿到授權，如果要知道是「誰」授權的，它需要用 Access Token 存取有使用者身份的資源，例如跟帳號有關的 API，才能知道使用者身份。</p><p>再來，Client 是依據哪項證明，知道跟 Client 互動的是使用者本人呢？它同樣是透過授權結果來得知，如果 Access Token 能拿到使用者資料，代表使用者有經過 Authorization Server 認證，Client 就能把 Access Token 的有效性當成使用者身份的證明。</p><p align="center"><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2023/openid-connect/oidc-1-1920w.webp 1920w, /img/posts/2023/openid-connect/oidc-1-1280w.webp 1280w, /img/posts/2023/openid-connect/oidc-1-840w.webp 840w, /img/posts/2023/openid-connect/oidc-1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2023/openid-connect/oidc-1-1920w.png 1920w, /img/posts/2023/openid-connect/oidc-1-1280w.png 1280w, /img/posts/2023/openid-connect/oidc-1-840w.png 840w, /img/posts/2023/openid-connect/oidc-1-320w.png 320w" type="image/png"><img height="656" src="/img/posts/2023/openid-connect/oidc-1-1920w.png" width="719" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 719 656'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAHCAYAAAA1WQxeAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAdklEQVQImT2ORw5EIQxDuf9R6e0jukfOSHiBUPJsR8UYMcZA7x0hBFhrYYyB1lr+aq2FlBIIEjrnYM4JzmlUHJZS4JwTsLUmS4qwABwSYMX3fZJw78Xe+1/BBLpzzq+GEoAPaYp38Lhaq/TT/AC6WMUU7/275QfJVtlmbHhF6QAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>換句話說，在流程上我們可以看到，Client 需要存取受保護資源來達成認證，而在 OAuth 2 中，沒有規範使用者身份的格式跟存取端點。每家 Provider 的實作可能不同，例如 A 有支援使用者的 email 而 B 沒有；或者 A、B 都支援，但 response body 的字段名稱不同；又或者字段名稱也相同，但存放在不同的 Endpoint 中。這些差異需要 Client 的開發者開發一套中間層處理，也不利於開放認證環境的推廣。</p><h2 id="openid-connect"><a href="#openid-connect" class="direct-link">#</a> OpenID Connect</h2><p>為了讓使用者能用 OAuth 的基礎建設進行認證，OpenID Foundation 設計出 OpenID Connect。因應認證的場景，它定義出兩個新角色，並將它們映射到 OAuth 的角色上</p><ul><li><strong>OpenID Provider</strong> 負責認證使用者，並提供身份證明給 Relying Party，讓 Relying Party 知道認證發生還有使用者是誰。這可以對照到 OAuth 2 的 Authorization Server 跟 Protected Resource。</li><li><strong>Relying Party</strong> 從 OpenID Provider 獲得認證憑證與使用者資訊。對照到 OAuth 2 的 Client。</li></ul><p>從 OpenID Connect 的角度來看的話，流程變成</p><p align="center"><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2023/openid-connect/oidc-2-1920w.webp 1920w, /img/posts/2023/openid-connect/oidc-2-1280w.webp 1280w, /img/posts/2023/openid-connect/oidc-2-840w.webp 840w, /img/posts/2023/openid-connect/oidc-2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2023/openid-connect/oidc-2-1920w.png 1920w, /img/posts/2023/openid-connect/oidc-2-1280w.png 1280w, /img/posts/2023/openid-connect/oidc-2-840w.png 840w, /img/posts/2023/openid-connect/oidc-2-320w.png 320w" type="image/png"><img height="656" src="/img/posts/2023/openid-connect/oidc-2-1920w.png" width="629" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 629 656'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiUlEQVQYlVWOCwqEMAxEe/+DimJVbNXajx15WXZhAylN8pIZt66riBijxnFUKUW9d03TpGEY5M7z1LIsmudZIQSDAe77FjN3XZdtk4DHcai1ppyznuf5ABScRg6Qet9365kEhffeEhnOk7VWOR42aKSUDNi2zf4/4BsMcI9h5P4ADCGHSXzgDeAFdqD3rmSZLLoAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>前面的流程都相同，主要差異在 (A)、(B)、(C) 的三個步驟。我們說過，OAuth 要求 Token 對 Client 來說是不透明的，可是認證又要求 Relying Party 能夠由 OpenID Provider 回傳的資訊來知道使用者身份，要如何同時滿足這兩個需求呢？答案是，在 OpenID Provider 的回傳中，多加入一個 ID Token，而該 Token 對 Relying Party 來講可讀。如此就能在兼容 OAuth 的前提下，又取得認證資訊。</p><p>具體來說，當 Relying Party 跟 OpenID Provider 要求 Token 時，OpenID Provider 站在 Authorization Server 的角度會給出 Access Token，同時，它站在 OpenID Provider 的角度，也會附上 ID Token。在同一個 Response 中會帶有這兩項資訊</p><pre class="language-json"><code class="language-json">HTTP/<span class="token number">1.1</span> <span class="token number">200</span> OK<br>Content-Type<span class="token operator">:</span> application/json<br>Cache-Control<span class="token operator">:</span> no-store<br>Pragma<span class="token operator">:</span> no-cache<br><br><span class="token punctuation">{</span><br>  <span class="token property">"access_token"</span><span class="token operator">:</span> <span class="token string">"SlAV32hkKG"</span><span class="token punctuation">,</span><br>  <span class="token property">"token_type"</span><span class="token operator">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span><br>  <span class="token property">"refresh_token"</span><span class="token operator">:</span> <span class="token string">"8xLOxBtZp8"</span><span class="token punctuation">,</span><br>  <span class="token property">"expires_in"</span><span class="token operator">:</span> <span class="token number">3600</span><span class="token punctuation">,</span><br>  <span class="token property">"id_token"</span><span class="token operator">:</span> "eyJhbGciOiJSUzI1NiIsImtpZCI6IjFlOWdkazcifQ.ewogImlzc<br>    yI6ICJodHRwOi8vc2VydmVyLmV4YW1wbGUuY29tIiwKICJzdWIiOiAiMjQ4Mjg5<br>    NzYxMDAxIiwKICJhdWQiOiAiczZCaGRSa3F0MyIsCiAibm9uY2UiOiAibi0wUzZ<br>    fV3pBMk1qIiwKICJleHAiOiAxMzExMjgxOTcwLAogImlhdCI6IDEzMTEyODA5Nz<br>    AKfQ.ggW8hZ1EuVLuxNuuIJKX_V8a_OMXzR0EHR9R6jgdqrOOF4daGU96Sr_P6q<br>    Jp6IcmD3HP99Obi1PRs-cwh3LO-p146waJ8IhehcwL7F09JdijmBqkvPeB2T9CJ<br>    NqeGpe-gccMg4vfKjkM8FcGvnzZUN4_KSP0aAp1tOJ1zZwgjxqGByKHiOtX7Tpd<br>    QyHE5lcMiKPXfEIQILVq0pc_E2DzL7emopWoaoZTF_m0_N0YzFC6g6EJbOEoRoS<br>    K5hoDalrcvRYLSrQAZZKflyuVCyixEoV9GfNQC3_osjzw2PAithfubEEBLuVVk4<br>    XUVrWOLrLl0nx7RkKU8NXNHq-rvKMzqg"<br><span class="token punctuation">}</span></code></pre><p>ID Token 是 JWT 的格式，解碼後，內容類似</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"https://server.example.com"</span><span class="token punctuation">,</span><br>  <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"24400320"</span><span class="token punctuation">,</span><br>  <span class="token property">"aud"</span><span class="token operator">:</span> <span class="token string">"s6BhdRkqt3"</span><span class="token punctuation">,</span><br>  <span class="token property">"nonce"</span><span class="token operator">:</span> <span class="token string">"n-0S6_WzA2Mj"</span><span class="token punctuation">,</span><br>  <span class="token property">"exp"</span><span class="token operator">:</span> <span class="token number">1311281970</span><span class="token punctuation">,</span><br>  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1311280970</span><span class="token punctuation">,</span><br>  <span class="token property">"auth_time"</span><span class="token operator">:</span> <span class="token number">1311280969</span><span class="token punctuation">,</span><br>  <span class="token property">"acr"</span><span class="token operator">:</span> <span class="token string">"urn:mace:incommon:iap:silver"</span><br><span class="token punctuation">}</span></code></pre><p>其中 <code>iss</code> 是 ID Token 的簽核者，可以當成是 OpenID Provider 的名稱，而 <code>sub</code> 是簽核者用來標示使用者的唯一碼。<code>iss</code> 跟 <code>sub</code> 可以組合成一個不重複的 ID，用來辨識使用者。</p><p>然而僅僅靠 ID，在應用上仍然稍嫌不夠力，我們在自我介紹時，不會說我是 A123456789，而是會講我的名字是 Ken，居住在台北。這些個人資訊可以給 Relying Party 更充足的訊息，讓它辨識來自不同 OpenID Provider 的相同使用者。為了讓這些資訊的取得有標準可以依循，OpenID Connect 重用 OAuth 2 的 scope 並規範特定的 Endpoint。Relying Party 在向 OpenID Provider 提出授權申請時，可以在 scope 中放入</p><pre class="language-bash"><code class="language-bash"><span class="token assign-left variable">scope</span><span class="token operator">=</span>openid profile email phone</code></pre><p>只要該 OpenID Provider 有支援，Relying Party 就能用 Access Token 向 userinfo 端點發出請求</p><pre class="language-bash"><code class="language-bash">GET /userinfo HTTP/1.1<br>Host: server.example.com<br>Authorization: Bearer SlAV32hkKG</code></pre><p>並得到使用者的完整資訊</p><pre class="language-bash"><code class="language-bash">HTTP/1.1 <span class="token number">200</span> OK<br>Content-Type: application/json<br><br><span class="token punctuation">{</span><br>  <span class="token string">"sub"</span><span class="token builtin class-name">:</span> <span class="token string">"248289761001"</span>,<br>  <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"Jane Doe"</span>,<br>  <span class="token string">"given_name"</span><span class="token builtin class-name">:</span> <span class="token string">"Jane"</span>,<br>  <span class="token string">"family_name"</span><span class="token builtin class-name">:</span> <span class="token string">"Doe"</span>,<br>  <span class="token string">"preferred_username"</span><span class="token builtin class-name">:</span> <span class="token string">"j.doe"</span>,<br>  <span class="token string">"email"</span><span class="token builtin class-name">:</span> <span class="token string">"janedoe@example.com"</span>,<br>  <span class="token string">"picture"</span><span class="token builtin class-name">:</span> <span class="token string">"http://example.com/janedoe/me.jpg"</span><br><span class="token punctuation">}</span></code></pre><h2 id="%E4%BD%BF%E7%94%A8-google-%E5%B8%B3%E8%99%9F%E8%AA%8D%E8%AD%89"><a href="#%E4%BD%BF%E7%94%A8-google-%E5%B8%B3%E8%99%9F%E8%AA%8D%E8%AD%89" class="direct-link">#</a> 使用 Google 帳號認證</h2><p>讓我們實際看一下用 Google 來登入的例子，先給張時序圖，讓大家知道我們需要有哪些 Endpoint</p><p align="center"><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2023/openid-connect/oidc-3-1920w.webp 1920w, /img/posts/2023/openid-connect/oidc-3-1280w.webp 1280w, /img/posts/2023/openid-connect/oidc-3-840w.webp 840w, /img/posts/2023/openid-connect/oidc-3-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2023/openid-connect/oidc-3-1920w.png 1920w, /img/posts/2023/openid-connect/oidc-3-1280w.png 1280w, /img/posts/2023/openid-connect/oidc-3-840w.png 840w, /img/posts/2023/openid-connect/oidc-3-320w.png 320w" type="image/png"><img height="702" src="/img/posts/2023/openid-connect/oidc-3-1920w.png" width="846" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 846 702'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAeklEQVQYlVVOWQpEIQzz/gf1Q1Hcd8kjQgemYFubNI2qtaKUghACYoxIKUFizgniKuf8QJKstXDOPYCEMQbWWlCttTfg4wKJMmPtvUORzY+c4mkCorL3hrr3/jwwSDLGQGsN7/1TVEzc4KYYFZ/snycmIbGec/6UeekDc4f0xom3CtUAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Client 有三個 Endpoint，分別是 <code>/login</code>、<code>/callback</code> 跟 <code>/</code>。使用者進到 <code>/login</code> 後，會導向到 OpenID Provider 進行認證與授權，之後導回 <code>/callback</code>，接收 ID Token 並綁定 session 後再導到首頁。</p><p>跟 OAuth 有關的部分，在<a href="https://blog.kenwsc.com/posts/2022/oauth-2-0-go-and-google-example/">另一篇文章</a>中有詳細解說，如果不熟的可以翻翻，這邊就不再多說明了。底下會把重點放在實現 OpenID Connect 需要的修改，首先來看端點跟配置</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    sessions <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>    cfg <span class="token operator">=</span> <span class="token function">NewGoogleOAuthConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    e <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    e<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"callback"</span><span class="token punctuation">,</span> OAuth2Callback<span class="token punctuation">)</span><br>    e<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">,</span> Login<span class="token punctuation">)</span><br>    e<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> GetHomePage<span class="token punctuation">)</span><br>    e<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"localhost:8080"</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">NewGoogleOAuthConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>oauth2<span class="token punctuation">.</span>Config <span class="token punctuation">{</span><br>    config <span class="token operator">:=</span> <span class="token operator">&</span>oauth2<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><br>        ClientID<span class="token punctuation">:</span>     clientID<span class="token punctuation">,</span><br>        ClientSecret<span class="token punctuation">:</span> clientSecret<span class="token punctuation">,</span><br>        RedirectURL<span class="token punctuation">:</span>  <span class="token string">"http://localhost:8080/callback"</span><span class="token punctuation">,</span><br>        Scopes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><br>            oidc<span class="token punctuation">.</span>ScopeOpenID<span class="token punctuation">,</span><br>            <span class="token string">"email"</span><span class="token punctuation">,</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        Endpoint<span class="token punctuation">:</span> google<span class="token punctuation">.</span>Endpoint<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> config<br><span class="token punctuation">}</span></code></pre><p>OpenID Connect 的函式庫使用 <a href="https://pkg.go.dev/github.com/coreos/go-oidc/v3@v3.5.0/oidc" rel="noopener noreferrer" target="_blank">github.com/coreos/go-oidc/v3/oidc</a>，能替我們降低一些開發成本。在跟 OpenID Provider 要權限前，記得 Scopes 要帶上 <code>oidc.ScopeOpenID</code>，我們還想知道 <code>email</code>，因此底下也加進去。</p><p>接著來到重頭戲 <code>/callback</code>，用收到的授權碼兌換 Access Token 跟 ID Token</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">OAuth2Callback</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// ...</span><br>    token<span class="token punctuation">,</span> err <span class="token operator">:=</span> cfg<span class="token punctuation">.</span><span class="token function">Exchange</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        ctx<span class="token punctuation">.</span><span class="token function">AbortWithError</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>        <span class="token keyword">return</span><br>    <span class="token punctuation">}</span><br>    <span class="token comment">// ...</span><br>    provider<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> oidc<span class="token punctuation">.</span><span class="token function">NewProvider</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"https://accounts.google.com"</span><span class="token punctuation">)</span><br>    verifier <span class="token operator">:=</span> provider<span class="token punctuation">.</span><span class="token function">Verifier</span><span class="token punctuation">(</span><span class="token operator">&</span>oidc<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>ClientID<span class="token punctuation">:</span> clientID<span class="token punctuation">}</span><span class="token punctuation">)</span><br>    idToken<span class="token punctuation">,</span> err <span class="token operator">=</span> verifier<span class="token punctuation">.</span><span class="token function">Verify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">Extra</span><span class="token punctuation">(</span><span class="token string">"id_token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        ctx<span class="token punctuation">.</span><span class="token function">AbortWithError</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>        <span class="token keyword">return</span><br>    <span class="token punctuation">}</span><br>    userInfo<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        ctx<span class="token punctuation">.</span><span class="token function">AbortWithError</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>        <span class="token keyword">return</span><br>    <span class="token punctuation">}</span><br>    sid <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">NewV4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    sessions<span class="token punctuation">[</span>sid<span class="token punctuation">]</span> <span class="token operator">=</span> userInfo<br>    ctx<span class="token punctuation">.</span><span class="token function">SetCookie</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">,</span> sid<span class="token punctuation">,</span> <span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><br>    ctx<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusFound<span class="token punctuation">,</span> <span class="token string">"http://localhost:8080"</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>取得 ID Token 後，先驗證該 Token 沒問題，解碼後內容是</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"https://accounts.google.com"</span><span class="token punctuation">,</span><br>  <span class="token property">"azp"</span><span class="token operator">:</span> <span class="token string">"xxxxxx.apps.googleusercontent.com"</span><span class="token punctuation">,</span><br>  <span class="token property">"aud"</span><span class="token operator">:</span> <span class="token string">"xxxxxx.apps.googleusercontent.com"</span><span class="token punctuation">,</span><br>  <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"104498875333XXXXXXXXXX"</span><span class="token punctuation">,</span><br>  <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"kenxxxxx@gmail.com"</span><span class="token punctuation">,</span><br>  <span class="token property">"email_verified"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>  <span class="token property">"at_hash"</span><span class="token operator">:</span> <span class="token string">"2RCplQvBCznJOwok6Yl8GA"</span><span class="token punctuation">,</span><br>  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1674159649</span><span class="token punctuation">,</span><br>  <span class="token property">"exp"</span><span class="token operator">:</span> <span class="token number">1674163249</span><br><span class="token punctuation">}</span></code></pre><p>以 ID Token 來說，Google 給的資訊已經夠多了，很多 optional 的欄位都有值，但其他的 Provider 未必會在 ID Token 給出詳細資訊，如果沒看到想要的資訊，可以再由 <code>/userinfo</code> 來拿</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span>token <span class="token operator">*</span>oauth2<span class="token punctuation">.</span>Token<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    res<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"https://openidconnect.googleapis.com/v1/userinfo"</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<br>    <span class="token punctuation">}</span><br>    <span class="token keyword">defer</span> res<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">var</span> resp <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><br>    data<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><br>    json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&</span>resp<span class="token punctuation">)</span><br>    <span class="token keyword">return</span> resp<span class="token punctuation">,</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span></code></pre><p>這份資料會先綁定 Session，等到使用者來拿時，再回傳回去</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">GetHomePage</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    sid<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Cookie</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span><br>    userInfo <span class="token operator">:=</span> sessions<span class="token punctuation">[</span>sid<span class="token punctuation">]</span><br>    ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> userInfo<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>最後得到 Response 中的個人資訊</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>    <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"kenxxxxx@gmail.com"</span><span class="token punctuation">,</span><br>    <span class="token property">"email_verified"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>    <span class="token property">"picture"</span><span class="token operator">:</span> <span class="token string">"https://lh3.googleusercontent.com/a-/xxxxxx"</span><span class="token punctuation">,</span><br>    <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"104498875333XXXXXXXXXX"</span><br><span class="token punctuation">}</span></code></pre><p>可以看到要修改的點不多，幾乎都是單純加上 OpenID Connect 的邏輯而已，跟 OAuth 2 的相容性非常好。</p><h2 id="%E5%B0%8F%E7%B5%90"><a href="#%E5%B0%8F%E7%B5%90" class="direct-link">#</a> 小結</h2><p>OpenID Connect 像是 OAuth 2 的擴充，儘管原本 OAuth 2 能做到類似認證的效果，但這是憑藉技術上的手段，而不是原本就在規範中。要知道，OAuth 2 的 Protected Resourece 沒有供應身份端點的義務，如果只是單純的 OAuth 2，客戶端沒辦法保證能做到認證的事。當然實際上，因為常串的 OAuth 2 資源都是 Meta / Microsoft / Amazon / Google 這類大廠，真的要找還是找得到，但這就跟「開放認證協定」不是同一回事了。</p><p>OpenID Connect 從規範上補足這件事，如果哪家廠商支援 OpenID Connect，我們可以合理預期，它會有能辨識身份的 ID Token 跟詳細資訊的 userinfo 端點，而身份資訊範圍也能從 OpenID Connect 的 scope 中看到，像是 Google 的 <a href="https://accounts.google.com/.well-known/openid-configuration" rel="noopener noreferrer" target="_blank">Discovery document</a> 就很明確，能讓開發者在初期就確定能否拿到想要的資訊</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token comment">// ...</span><br>  <span class="token property">"scopes_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token string">"openid"</span><span class="token punctuation">,</span><br>    <span class="token string">"email"</span><span class="token punctuation">,</span><br>    <span class="token string">"profile"</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token comment">// ...</span><br>  <span class="token property">"claims_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token string">"aud"</span><span class="token punctuation">,</span><br>    <span class="token string">"email"</span><span class="token punctuation">,</span><br>    <span class="token string">"email_verified"</span><span class="token punctuation">,</span><br>    <span class="token string">"exp"</span><span class="token punctuation">,</span><br>    <span class="token string">"family_name"</span><span class="token punctuation">,</span><br>    <span class="token string">"given_name"</span><span class="token punctuation">,</span><br>    <span class="token string">"iat"</span><span class="token punctuation">,</span><br>    <span class="token string">"iss"</span><span class="token punctuation">,</span><br>    <span class="token string">"locale"</span><span class="token punctuation">,</span><br>    <span class="token string">"name"</span><span class="token punctuation">,</span><br>    <span class="token string">"picture"</span><span class="token punctuation">,</span><br>    <span class="token string">"sub"</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre><p>希望看完這篇文後，能幫忙釐清 OAuth 2 跟 OpenID Connect 的關係，知道角色間如何對應，也能讓開發者們在開發第三方登入的應用時，更快進入狀況。</p><h2 id="reference"><a href="#reference" class="direct-link">#</a> Reference</h2><ul><li><a href="https://openid.net/connect/" rel="noopener noreferrer" target="_blank">Welcome to OpenID Connect</a></li><li><a href="https://www.rfc-editor.org/rfc/rfc6749#page-10" rel="noopener noreferrer" target="_blank">RFC 6749</a></li><li><a href="https://www.ithome.com.tw/voice/134389" rel="noopener noreferrer" target="_blank">驗證與授權</a></li><li><a href="https://petertc.medium.com/openid-connect-a27e0a3cc2ae" rel="noopener noreferrer" target="_blank">每當點選社群帳號登入，背後發生了什麼事？</a></li><li><a href="https://kimlin20011.medium.com/%E6%B7%B1%E5%85%A5%E6%B7%BA%E5%87%BA-openid-connect-%E4%B8%80-8701bbf00958" rel="noopener noreferrer" target="_blank">深入淺出 OpenID Connect (一)</a></li><li><a href="https://developers.google.com/identity/openid-connect/openid-connect" rel="noopener noreferrer" target="_blank">OpenID Connect | Authentication | Google Developers</a></li><li><a href="https://ithelp.ithome.com.tw/articles/10300937?sc=iThelpR" rel="noopener noreferrer" target="_blank">如何驗證 ID Token 的資訊</a></li></ul><div class="article-footer"></div><div><p style="font-weight: bold;">標籤</p><div class="post-tags"><a href="/tags/web/" class="post-tag">Web</a> <a href="/tags/authentication/" class="post-tag">Authentication</a></div><p style="font-weight: bold;">其他文章</p><ul><li><a href="/posts/2022/concurrency-of-go-error-handling/">Goroutine 的併發治理：由錯誤處理談起</a></li><li><a href="/posts/2022/oauth-2-0-authorization-grant/">OAuth 2.0：授權許可</a></li><li><a href="/posts/2020/gorm-from-init-to-use/">GORM：從建置到 CRUD</a></li><li><a href="/posts/2020/develop-your-middleware-by-golang/">訊息的處理架構：路由與中間層模式</a></li><li><a href="/posts/2019/visualize-your-redmine-data/">掌握 Redmine 的活動指標：繪製熱度圖</a></li></ul></div><p style="font-weight: bold;">評論</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="ken00535/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"OAuth 2.0 的身份認證：OpenID Connect","image":["https://blog.kenwsc.com/img/posts/2023/openid-connect/oidc-1-1920w.png","https://blog.kenwsc.com/img/posts/2023/openid-connect/oidc-2-1920w.png","https://blog.kenwsc.com/img/posts/2023/openid-connect/oidc-3-1920w.png"],"author":{"@type":"Person","name":""},"publisher":{"@type":"Organization","name":"Ken Chen&#39;s Blog","url":"https://blog.kenwsc.com","logo":{"@type":"ImageObject","url":"https://blog.kenwsc.com/img/favicon/favicon.png","width":512,"height":512}},"url":"https://blog.kenwsc.com/posts/2023/openid-connect/","mainEntityOfPage":"https://blog.kenwsc.com/posts/2023/openid-connect/","datePublished":"2023-01-20","dateModified":"2023-01-27","description":"OAuth 2 讓網路服務可以存取第三方的受保護資源，因此，有些開發者會進一步利用 OAuth 2 來進行使用者認證。但這中間存在著一些語義落差，因為 OAuth 2 當初設計目的是「授權」而不是「認證」，兩者關注的焦點會有些不同。OpenID Connect 是基於 OAuth..."}</script></article></main><footer><div class="footer-logos"><a href="https://medium.com/@ken00535" rel="noopener noreferrer" target="_blank"><img height="50" src="/img/icons/icon_social media_medium.svg" width="50" alt="medium"></a><a href="https://www.linkedin.com/in/ken00535" rel="noopener noreferrer" target="_blank"><img height="30" src="/img/icons/icon_social media_linkedln.svg" width="30" alt="linkedin"></a><a href="https://blog.kenwsc.com/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img height="30" src="/img/icons/rss-feed.svg" width="30" alt="rss feed"></a></div><div class="copyright">© 2023 Ken Chen's Blog, Powered by <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>