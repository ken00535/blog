<!DOCTYPE html><html domain="blog.kenwsc.com" ga-id="GTM-MM4P38S" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="Backend,Golang" name="keywords"><link href="/img/favicon/favicon.png?hash=b6fc65e341" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>Goroutine 的併發治理：管理 Worker Pool</title><meta content="Goroutine 的併發治理：管理 Worker Pool" property="og:title"><meta content="Goroutine 的併發治理：管理 Worker Pool" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="併發會需要多個 Goroutine 來同時執行任務，Goroutine 雖然輕量，也還是有配置成本，如果每次新的任務進來，都需要重新建立並配置 Goroutine，一方面不容易管理 Goroutine 的記憶體，一方面也會消耗 CPU 的運算效能。這時 Worker Pool 就登場了，這篇文章會從 0 開始建立 Work Pool，試著丟進不同的場景需求，看看如何實現。..." name="description"><meta content="併發會需要多個 Goroutine 來同時執行任務，Goroutine 雖然輕量，也還是有配置成本，如果每次新的任務進來，都需要重新建立並配置 Goroutine，一方面不容易管理 Goroutine 的記憶體，一方面也會消耗 CPU 的運算效能。這時 Worker Pool 就登場了，這篇文章會從 0 開始建立 Work Pool，試著丟進不同的場景需求，看看如何實現。..." name="twitter:description"><meta content="併發會需要多個 Goroutine 來同時執行任務，Goroutine 雖然輕量，也還是有配置成本，如果每次新的任務進來，都需要重新建立並配置 Goroutine，一方面不容易管理 Goroutine 的記憶體，一方面也會消耗 CPU 的運算效能。這時 Worker Pool 就登場了，這篇文章會從 0 開始建立 Work Pool，試著丟進不同的場景需求，看看如何實現。..." property="og:description"><meta content="article" property="og:type"><meta content="https://blog.kenwsc.com/posts/2022/concurrency-of-go-worker-pool/" property="og:url"><meta content="Ken Chen's Blog" property="og:site_name"><meta content="https://blog.kenwsc.com/img/posts/2022/concurrency-of-go-worker-pool/cover.png" property="og:image"><meta content="https://blog.kenwsc.com/img/posts/2022/concurrency-of-go-worker-pool/cover.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://blog.kenwsc.com/posts/2022/concurrency-of-go-worker-pool/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Ken Chen's Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
            var f = d.getElementsByTagName(s)[0];
            var j = d.createElement(s);
            var dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-MM4P38S');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}dl{clear:both;display:block!important;margin:0 0 1.5em}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}html{line-height:1.15;-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button,input,select{font-family:inherit;font-size:100%;line-height:1.15}.article-footer img,body,input,select{margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:1.75rem}body,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}code{border-radius:.3em;color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2{font-family:var(--font-family)}a:hover{text-decoration:underline}button,input,select{border-radius:.3em;max-width:100%}input{padding:.75em}button+label,input+label,label+*,select+label{page-break-before:always}input,select{margin-bottom:1.5em;display:inline}button,label{display:inline-block}button{background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}input[type=number],input[type=range],input[type=time],input[type=url],select{border:1px solid #595959;padding:.75em}select[multiple]{min-width:15em}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li dl,li ul{margin-bottom:0}blockquote{padding:0 1.5em;margin:1.5em 0 1.5em 1.5em;border-left:4px solid var(--primary)}blockquote footer{background:0 0;display:block;color:#ccc;padding:.75em 0;font-size:90%;text-align:start}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.property{color:#f8c555}.token.builtin,.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}#nav,.menu__btn{position:relative}.menu__btn{display:inline-block;width:24px;height:24px}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav{height:68px;z-index:2;align-items:center}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}#nav,.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}footer{margin-top:48px;font-size:14px;padding:24px;border-top:1px solid #ccc;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.post-tag:not(body){text-decoration:none;background-color:#f5f5f5;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border-radius:20px;color:#4a4a4a;display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;font-size:.75rem;height:2em;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;line-height:1.5;padding-left:.75em;padding-right:.75em;white-space:nowrap}.post-tag:hover{text-decoration:none;background:#ccc}.direct-link{display:none}.post-avatar{display:flex;align-items:center;height:36px}.post-avatar__time{font-size:13px}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}</style></head><body><header><nav><div id="nav"><div class="nav__links"><a href="/" title="Homepage">Home</a> <a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">Goroutine 的併發治理：管理 Worker Pool</h1><aside class="w-full"><div class="post-avatar"><div class="post-avatar__time">Ken Chen | 20 Dec 2022 <a href="/tags/go/" class="post-tag">Go</a> <a href="/tags/concurrency/" class="post-tag">Concurrency</a></div></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>併發會需要多個 Goroutine 來同時執行任務，Goroutine 雖然輕量，也還是有配置成本，如果每次新的任務進來，都需要重新建立並配置 Goroutine，一方面不容易管理 Goroutine 的記憶體，一方面也會消耗 CPU 的運算效能。這時 Worker Pool 就登場了，我們可以在執行前，先將 Goroutine 配置好放到資源池中，要用時再調用閒置資源來處理，藉此資源回收重複利用。這篇文章會從 0 開始建立 Work Pool，試著丟進不同的場景需求，看看如何實現。</p><h2 id="%E5%9F%BA%E6%9C%AC%E7%9A%84-worker-pool"><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84-worker-pool" class="direct-link">#</a> 基本的 Worker Pool</h2><p>Worker Pool 的概念可以用這張圖來解釋</p><p align="center"><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/concurrency-of-go-worker-pool/worker-1-1920w.webp 1920w, /img/posts/2022/concurrency-of-go-worker-pool/worker-1-1280w.webp 1280w, /img/posts/2022/concurrency-of-go-worker-pool/worker-1-840w.webp 840w, /img/posts/2022/concurrency-of-go-worker-pool/worker-1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/concurrency-of-go-worker-pool/worker-1-1920w.png 1920w, /img/posts/2022/concurrency-of-go-worker-pool/worker-1-1280w.png 1280w, /img/posts/2022/concurrency-of-go-worker-pool/worker-1-840w.png 840w, /img/posts/2022/concurrency-of-go-worker-pool/worker-1-320w.png 320w" type="image/png"><img height="342" src="/img/posts/2022/concurrency-of-go-worker-pool/worker-1-1920w.png" width="626" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 626 342'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAz0lEQVQImTWOvWqEQBSFzxYhWFkkRSBFniCtdpZp8kKBBDYvkGLDvpKdjWKxzSAjdwZXGBCuP4jCDXchxWk+Dt85YOY7EYFz7oeIhIh4mibpuu5DOTPfF0VxQJ7nUOC9Pw/DIN77eV1Xadv2W3lZljDGQAtvAA5EdF6WRU23YtM0RwAIIbzXdf0Ka+0FwAMRnXTy32iM+Yzj+OV6vfqqqn6RJMmTTqiRmcU5N6vZWntUnmXZcxRFj2q/fQwhnLZtk3Ec533fpe/7L+WaNE3xB0Moqv77VYbGAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Job 會放在 Queue 中送給 Pool 內配置好的 Worker，Worker 處理完後再將結果送到另一個 Queue 內。因為這是很常見的併發模式，<a href="https://gobyexample.com/worker-pools" rel="noopener noreferrer" target="_blank">Go by Example</a> 有個精簡的例子，說明 Worker Pool 如何實現</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>id <span class="token builtin">int</span><span class="token punctuation">,</span> jobs <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> results <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token keyword">range</span> jobs <span class="token punctuation">{</span><br>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token string">"started  job"</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><br>        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><br>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token string">"finished job"</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><br>        results <span class="token operator">&lt;-</span> j <span class="token operator">*</span> <span class="token number">2</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> numJobs <span class="token operator">=</span> <span class="token number">5</span><br>    jobs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> numJobs<span class="token punctuation">)</span><br>    results <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> numJobs<span class="token punctuation">)</span><br>    <span class="token keyword">for</span> w <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> w <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span> w<span class="token operator">++</span> <span class="token punctuation">{</span><br>        <span class="token keyword">go</span> <span class="token function">worker</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> jobs<span class="token punctuation">,</span> results<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> numJobs<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">{</span><br>        jobs <span class="token operator">&lt;-</span> j<br>    <span class="token punctuation">}</span><br>    <span class="token function">close</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><br>    <span class="token keyword">for</span> a <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> a <span class="token operator">&lt;=</span> numJobs<span class="token punctuation">;</span> a<span class="token operator">++</span> <span class="token punctuation">{</span><br>        <span class="token operator">&lt;-</span>results<br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Worker Pool 的特點是一次配置，多次執行。先建立 Worker 的 input / output channel，這裡用 <code>jobs</code> 跟 <code>results</code>。接著用 Goroutine 起好所有的 worker，並監聽 <code>jobs</code> 的資訊。然後就可以開始往 <code>jobs</code> 內丟工作，並到 <code>results</code> 等著接收處理完的訊息。</p><p>這段程式讓 Job 可以併發執行，但它沒經過封裝，資訊比較散，例如要修改 worker 數量的話，需要修改 <code>numJobs</code> 這個變數；如果希望 channel 可以 buffer 還沒處理的 job，則需要修改 <code>jobs</code> 初始化的命令。這些跟 Goroutine 管理相關的邏輯，可以宣告個 Worker Pool 的 struct 來集中管理。</p><p>經過封裝的 Worker Pool 變成</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    pool <span class="token operator">:=</span> <span class="token function">NewWorkerPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><br>    pool<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>            pool<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    pool<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">type</span> WorkerPool <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    jobCh     <span class="token keyword">chan</span> <span class="token builtin">int</span><br>    done      <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><br>    queueLen  <span class="token builtin">int</span><br>    workerCnt <span class="token builtin">int</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">NewWorkerPool</span><span class="token punctuation">(</span>queueLen <span class="token builtin">int</span><span class="token punctuation">,</span> workerCnt <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>WorkerPool <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token operator">&</span>WorkerPool<span class="token punctuation">{</span><br>        jobCh<span class="token punctuation">:</span>     <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> queueLen<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        done<span class="token punctuation">:</span>      <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        queueLen<span class="token punctuation">:</span>  queueLen<span class="token punctuation">,</span><br>        workerCnt<span class="token punctuation">:</span> workerCnt<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>workerCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>jobCh <span class="token punctuation">{</span><br>                time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><br>                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">"finished job"</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><br>                p<span class="token punctuation">.</span>done <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Push</span><span class="token punctuation">(</span>j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    p<span class="token punctuation">.</span>jobCh <span class="token operator">&lt;-</span> j<br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Wait</span><span class="token punctuation">(</span>total <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> cnt <span class="token builtin">int</span><br>    <span class="token keyword">for</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>done <span class="token punctuation">{</span><br>        cnt<span class="token operator">++</span><br>        <span class="token keyword">if</span> cnt <span class="token operator">==</span> total <span class="token punctuation">{</span><br>            <span class="token keyword">return</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>我們把 input/output 兩個 channel 都放進 Worker Pool 內，並在 <code>Run()</code> 中配置與啟動 Goroutine，而 <code>Push</code> 則用來將 Job 放進 Queue 中，最後用 <code>Wait</code> 來等待所有任務執行完成。這與 Go by Example 的邏輯相同，只是外面用 OOP 的概念多封裝一層。</p><p>試著執行一下</p><pre class="language-bash"><code class="language-bash">worker <span class="token number">1</span> finished job <span class="token number">2</span><br>worker <span class="token number">2</span> finished job <span class="token number">1</span><br>worker <span class="token number">4</span> finished job <span class="token number">4</span><br><span class="token punctuation">..</span>.<br>worker <span class="token number">4</span> finished job <span class="token number">98</span><br>worker <span class="token number">1</span> finished job <span class="token number">96</span><br>worker <span class="token number">2</span> finished job <span class="token number">97</span></code></pre><p>這邊有個有意思的問題，task number 該由 WorkPool 來管理，還是該由 main func 來管理？就我的觀點來說，有多少任務只有 Worker Pool 的調用方知道，因此讓 main func 來作這件事比較妥當。</p><h2 id="%E6%9C%89-timeout-%E7%9A%84%E7%AD%89%E5%BE%85"><a href="#%E6%9C%89-timeout-%E7%9A%84%E7%AD%89%E5%BE%85" class="direct-link">#</a> 有 Timeout 的等待</h2><p>讓我們多加一些場景需求進去。假設 Worker 中可能會有長時間執行的任務，為了避免執行時間太長，超過規格容許程度。要在 <code>Wait</code> 時設定 timeout，超過就退出並回覆一個 timeout error。</p><p>這個需求只要活用 Go select 的能力就可以達成。什麼是 select？這是一個用來監聽 input 的命令，只要有 input 進來就會觸發後續的處理。熟悉 C 語言的工程師應該能想到 C 中的 select function，的確，兩者的語義是類似，只是 C 主要是用來監聽文件描述符，而 Go 擴大了 input 的使用範圍。讓我們多問一個問題，假設一個程序有兩個 input，兩個 input 同時有值進來，程序應該要先執行哪個 input 的值？這要回到 CSP 的定義來看</p><p>在 CSP 模型的第五點，Tony Hoare 說</p><blockquote><p>If several input guards of a set of alternatives have ready destinations, only one is selected and the others have no effect; but the choice between them is arbitrary.</p><p>如果多個守護命令成立，只有一個會被執行，其他的沒有效果。但是要選擇哪個執行則是隨機。</p></blockquote><p>事實上，Go 也是這麼實現的</p><blockquote><p>A select blocks until one of its cases can run, then it executes that case. It chooses one at random if multiple are ready.</p><p>select 會阻塞直到其中一個 case 可以執行，當多個 case 可以執行時，則隨機選擇一個。</p></blockquote><p>Tony Hoare 沒詳細解釋這樣設計的原因，但我想，這是避免 input 間存在隱性的相依關係，如果 input 的 select 是隨機的，等於說兩個 input 的地位相等。</p><p>回來看 timeout 的實現，這邊只要修改 <code>Wait()</code> 就可以了</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Wait</span><span class="token punctuation">(</span>d time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> total <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> cnt <span class="token builtin">int</span><br>    timeout <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><br>    <span class="token keyword">for</span> <span class="token punctuation">{</span><br>        <span class="token keyword">select</span> <span class="token punctuation">{</span><br>        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>timeout<span class="token punctuation">:</span><br>            <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">)</span><br>        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>done<span class="token punctuation">:</span><br>            cnt<span class="token operator">++</span><br>            <span class="token keyword">if</span> cnt <span class="token operator">==</span> total <span class="token punctuation">{</span><br>                <span class="token keyword">return</span> <span class="token boolean">nil</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>試著執行，可以看到</p><pre class="language-bash"><code class="language-bash">worker <span class="token number">3</span> finished job <span class="token number">3</span><br>worker <span class="token number">0</span> finished job <span class="token number">0</span><br><span class="token punctuation">..</span>.<br>worker <span class="token number">0</span> finished job <span class="token number">43</span><br>worker <span class="token number">1</span> finished job <span class="token number">44</span><br>worker <span class="token number">4</span> finished job <span class="token number">41</span><br><span class="token function">timeout</span><br>worker <span class="token number">4</span> finished job <span class="token number">49</span><br>worker <span class="token number">3</span> finished job <span class="token number">45</span><br>worker <span class="token number">0</span> finished job <span class="token number">47</span><br>worker <span class="token number">2</span> finished job <span class="token number">46</span><br>worker <span class="token number">1</span> finished job <span class="token number">48</span></code></pre><p>timeout 後，只有還在執行的 job 會被執行完，其他的就不再執行。</p><h2 id="%E5%82%B3%E9%81%9E-job-%E8%80%8C%E4%B8%8D%E6%98%AF%E8%B3%87%E6%96%99"><a href="#%E5%82%B3%E9%81%9E-job-%E8%80%8C%E4%B8%8D%E6%98%AF%E8%B3%87%E6%96%99" class="direct-link">#</a> 傳遞 Job 而不是資料</h2><p>在前面的範例中，我們都是拿 i 當 input，但這是傳遞資料給 worker 處理，處理邏輯還是放在 worker 中。如果處理的邏輯改變了，原本的設計就會失敗。資料跟處理邏輯應該是兩件事，如果想讓調用端自定義 Job 處理的方式，可以怎麼做？直覺做法是類似 callback function，調用端註冊要執行的 func，等到條件符合時，註冊的 func 就會自動被調用。在 Go 語言，func 是一等公民，我們可以換個角度想，如果把 func 也當成一種值，只要把 func 丟進 Queue 中，讓 worker 自行呼叫就好了。</p><p>先來設計 Job 的樣子</p><pre class="language-go"><code class="language-go"><span class="token keyword">type</span> Job <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    Fn <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">NewJob</span><span class="token punctuation">(</span>fn <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> Job <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> Job<span class="token punctuation">{</span><br>        Fn<span class="token punctuation">:</span> fn<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>j <span class="token operator">*</span>Job<span class="token punctuation">)</span> <span class="token function">Do</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> j<span class="token punctuation">.</span><span class="token function">Fn</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p><code>NewJob</code> 會吃進一個 func，把它包裝起來，在 worker 內，只需要用 <code>Do()</code> 來呼叫它</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>workerCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>jobCh <span class="token punctuation">{</span><br>                j<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><br>                p<span class="token punctuation">.</span>done <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>而具體的邏輯，會放在 main func 內</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    pool <span class="token operator">:=</span> <span class="token function">NewWorkerPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><br>    pool<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>            num <span class="token operator">:=</span> i<br>            pool<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span><span class="token function">NewJob</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>                time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><br>                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token string">"finished job"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><br>                <span class="token keyword">return</span> <span class="token boolean">nil</span><br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h2 id="%E9%A9%97%E8%AD%89%E8%A8%AD%E8%A8%88"><a href="#%E9%A9%97%E8%AD%89%E8%A8%AD%E8%A8%88" class="direct-link">#</a> 驗證設計</h2><p>使用併發後，應該能帶來效能上的提升，但至於實際上改善多少？有沒有如同預期？會需要另外設計 Benchmark 來確認併發有沒有發揮作用。</p><p>關於 Benchmark，可以從三個面向來看，第一個是第一項任務完成時間，在一個響應式的系統中，第一項任務完成時間會關係到使用者多快可以得到回饋，好知道請求有被執行；第二個是每項任務平均完成時間，理想情況下，各任務的完成時間應該會差不多，但如果有資源阻塞的情況，就可能拉長某些任務的處理時間；第三個是全部任務完成時間，從端到端的觀點來看，代表整個請求的處理被完成。</p><p>我們把效能監控交給一個背景執行的 Goroutine 負責，稱它為 Gb，用來統計各個 Worker Pool 中各 Goroutine 的執行情況，Worker Pool 的 Goroutine 會在開始跟結束時，各送一個訊號給 Gb</p><pre class="language-go"><code class="language-go">startCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><br>endCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><br><br>pool<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span><span class="token function">NewJob</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>    startCh <span class="token operator">&lt;-</span> num<br>    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><br>    endCh <span class="token operator">&lt;-</span> num<br>    <span class="token keyword">return</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>而 Gb 會監控這個訊號，並轉成需要的 metric，等到執行完畢時印出</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">statWork</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> startCh <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> endCh <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> first time<span class="token punctuation">.</span>Duration<br>    <span class="token keyword">var</span> periods <span class="token punctuation">[</span><span class="token punctuation">]</span>time<span class="token punctuation">.</span>Duration<br>    startTs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span><br>    startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> <span class="token punctuation">{</span><br>            <span class="token keyword">select</span> <span class="token punctuation">{</span><br>            <span class="token keyword">case</span> n <span class="token operator">:=</span> <span class="token operator">&lt;-</span>startCh<span class="token punctuation">:</span><br>                startTs<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token keyword">case</span> n <span class="token operator">:=</span> <span class="token operator">&lt;-</span>endCh<span class="token punctuation">:</span><br>                period <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>startTs<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><br>                periods <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>periods<span class="token punctuation">,</span> period<span class="token punctuation">)</span><br>                <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>periods<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span><br>                    first <span class="token operator">=</span> period<br>                <span class="token punctuation">}</span><br>            <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>                total <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><br>                <span class="token keyword">var</span> allPeriod time<span class="token punctuation">.</span>Duration<br>                <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> periods <span class="token punctuation">{</span><br>                    allPeriod <span class="token operator">+=</span> p<br>                <span class="token punctuation">}</span><br>                average <span class="token operator">:=</span> allPeriod <span class="token operator">/</span> <span class="token number">100</span><br>                fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"first: %v, average: %v, total: %v\n"</span><span class="token punctuation">,</span> first<span class="token punctuation">,</span> average<span class="token punctuation">,</span> total<span class="token punctuation">)</span><br>                done <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><br>                <span class="token keyword">return</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> done<br><span class="token punctuation">}</span></code></pre><p>另外，我們不僅想知道執行後的 metric，我們也想知道執行時的狀況是否如同預期，像是有多少 Job 正在「執行中」，又有多少 Job 已經「被完成」，因此多加一個 ticker，每 20ms 印出一次執行狀況</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">statWork</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> startCh <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> endCh <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><br>    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">20</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><br>    <span class="token keyword">var</span> wip<span class="token punctuation">,</span> cnt <span class="token builtin">int</span><br>    <span class="token comment">// ...</span><br>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> <span class="token punctuation">{</span><br>            <span class="token keyword">select</span> <span class="token punctuation">{</span><br>            <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span><br>                fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"ts: %v, wip: %d, cnt: %d \n"</span><span class="token punctuation">,</span><br>                    time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">,</span><br>                    wip<span class="token punctuation">,</span><br>                    cnt<span class="token punctuation">,</span><br>                <span class="token punctuation">)</span><br>            <span class="token comment">// ...</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre><p>先看在沒有併發的情況下，得到的結果</p><pre class="language-bash"><code class="language-bash">ts: <span class="token number">20</span>.533328ms, wip: <span class="token number">1</span>, cnt: <span class="token number">0</span> <br>ts: <span class="token number">40</span>.240159ms, wip: <span class="token number">1</span>, cnt: <span class="token number">0</span> <br>ts: <span class="token number">61</span>.060294ms, wip: <span class="token number">1</span>, cnt: <span class="token number">0</span> <br>ts: <span class="token number">81</span>.064288ms, wip: <span class="token number">1</span>, cnt: <span class="token number">0</span> <br>ts: <span class="token number">101</span>.070834ms, wip: <span class="token number">1</span>, cnt: <span class="token number">0</span> <br>ts: <span class="token number">120</span>.955999ms, wip: <span class="token number">1</span>, cnt: <span class="token number">1</span> <br>ts: <span class="token number">140</span>.383283ms, wip: <span class="token number">1</span>, cnt: <span class="token number">1</span> <br><span class="token comment"># ...</span><br>ts: <span class="token number">10</span>.001063663s, wip: <span class="token number">1</span>, cnt: <span class="token number">99</span> <br>ts: <span class="token number">10</span>.021033326s, wip: <span class="token number">1</span>, cnt: <span class="token number">99</span> <br>first: <span class="token number">101</span>.164179ms, average: <span class="token number">100</span>.386499ms, total: <span class="token number">10</span>.039199429s</code></pre><p>第一個任務用時 101.16ms，平均 100.38ms，因為總共有 100 個 job，所以總共用了 10s 左右的時間，跟預期差不多。另外執行時的 wip 都是 1，顯示同時間只有一個 worker 在執行。</p><p>再來看有併發的結果</p><pre class="language-bash"><code class="language-bash">ts: <span class="token number">20</span>.569597ms, wip: <span class="token number">5</span>, cnt: <span class="token number">0</span> <br>ts: <span class="token number">40</span>.118856ms, wip: <span class="token number">5</span>, cnt: <span class="token number">0</span> <br>ts: <span class="token number">61</span>.041621ms, wip: <span class="token number">5</span>, cnt: <span class="token number">0</span> <br>ts: <span class="token number">80</span>.207746ms, wip: <span class="token number">5</span>, cnt: <span class="token number">0</span> <br>ts: <span class="token number">101</span>.211041ms, wip: <span class="token number">5</span>, cnt: <span class="token number">2</span> <br>ts: <span class="token number">121</span>.074584ms, wip: <span class="token number">5</span>, cnt: <span class="token number">5</span><br><span class="token comment"># ...</span><br>ts: <span class="token number">1</span>.980522061s, wip: <span class="token number">5</span>, cnt: <span class="token number">95</span> <br>ts: <span class="token number">2</span>.000850008s, wip: <span class="token number">5</span>, cnt: <span class="token number">95</span> <br>first: <span class="token number">100</span>.971561ms, average: <span class="token number">99</span>.18092ms, total: <span class="token number">2</span>.003859502s</code></pre><p>第一個任務用時 100.97ms，平均 99.18ms，跟沒併發的情況差異不大，因為開了 5 個 Goroutine 去分擔 Job，全部任務完成時間縮短為 1/5，只有 2s 左右。另外執行時的 wip 都是 5，每個 worker 都有吃到工作，完成數也穩定上升，偶爾有 2 跳到 5 這樣的情況，代表每個 worker 不一定會同時完成任務。</p><p>從結果可以看出來，併發對第一項任務完成時間的幫助不大，因為本質上，併發是利用阻塞的時間處理其他事情，而第一項任務通常還不會有阻塞問題；但由於有效利用了阻塞時間，在全部任務完成時間可以得到有效提升。</p><p>最後，再看看同樣是併發，有 worker pool 跟沒有 worker pool 在效能上會差多少，這邊用 go 的 benchmark 來測試</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">BenchmarkPool</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    pool <span class="token operator">:=</span> <span class="token function">NewWorkerPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><br>    pool<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    b<span class="token punctuation">.</span><span class="token function">ResetTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>        wg <span class="token operator">:=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">{</span><span class="token punctuation">}</span><br>        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><br>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>            pool<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span><span class="token function">NewJob</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>                wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                <span class="token keyword">return</span> <span class="token boolean">nil</span><br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">BenchmarkNoPool</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>        wg <span class="token operator">:=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">{</span><span class="token punctuation">}</span><br>        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><br>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>            <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>執行後得到</p><pre class="language-bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -v -bench<span class="token operator">=</span><span class="token string">"."</span> <span class="token builtin class-name">.</span><br>goos: darwin<br>goarch: amd64<br>cpu: Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i7-9750H CPU @ <span class="token number">2</span>.60GHz<br>BenchmarkPool<br>BenchmarkPool-12           <span class="token number">70965</span>             <span class="token number">16668</span> ns/op<br>BenchmarkNoPool<br>BenchmarkNoPool-12         <span class="token number">58084</span>             <span class="token number">20715</span> ns/op</code></pre><p>大約能改善 22% 的效能，對計算密集的場景，應該能擠出一些運算能力。</p><h2 id="%E5%85%B6%E4%BB%96%E4%BA%BA%E7%9A%84%E5%81%9A%E6%B3%95"><a href="#%E5%85%B6%E4%BB%96%E4%BA%BA%E7%9A%84%E5%81%9A%E6%B3%95" class="direct-link">#</a> 其他人的做法</h2><p>除了前面自行實現的 Worker Pool 外，也來看看其他人怎麼設計。Github 的 <a href="https://github.com/gammazero/workerpool" rel="noopener noreferrer" target="_blank">gammazero/workerpool</a> 有 900+ 星星，應該具有一定的成熟度，它的 API 包含</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Pause</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">StopWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Stopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Submit</span><span class="token punctuation">(</span>task <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">SubmitWait</span><span class="token punctuation">(</span>task <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">WaitingQueueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span></code></pre><p>其中 <code>Pause()</code> 有點意思，可以讓 Goroutine 先暫停，不要執行 Job。來看看說明</p><blockquote><p>Pause causes all workers to wait on the given Context, thereby making them unavailable to run tasks. Pause returns when all workers are waiting. Tasks can continue to be queued to the workerpool, but are not executed until the Context is canceled or times out.</p></blockquote><p>這是怎麼辦到的呢？因為理論上，不同 input 間不會彼此影響，因此要讓 Goroutine 停止執行，就需要塞住整個 Goroutine，給它一個持續等待的 Job</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Pause</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// ...</span><br>    ready <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">)</span><br>    ready<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>maxWorkers<span class="token punctuation">)</span><br>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>maxWorkers<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>        p<span class="token punctuation">.</span><span class="token function">Submit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            ready<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token keyword">select</span> <span class="token punctuation">{</span><br>            <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>            <span class="token keyword">case</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>stopSignal<span class="token punctuation">:</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    <span class="token comment">// Wait for workers to all be paused</span><br>    ready<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>在這個 Job 中，會用到 context 來當結束的命令，除非 context cancel 或 timeout，Goroutine 會阻塞在 <code>ctx.Done()</code>。阻塞 Job 的總量跟 Goroutine 最大數量相同，當一個 Goroutine 阻塞後，它就不會再收到新的 Job，因此能確保每個 Goroutine 都能被分配到一個阻塞 Job。</p><p>另一個有意思的設計是，Work Pool 可以根據需求自行 scale out 或 scale in Goroutine 的數量，這段邏輯實作在 dispatch 的 func 中</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    timeout <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span>idleTimeout<span class="token punctuation">)</span><br>    <span class="token keyword">var</span> workerCount <span class="token builtin">int</span><br>    <span class="token comment">// ...</span><br>    <span class="token keyword">for</span> <span class="token punctuation">{</span><br>        <span class="token comment">// ...</span><br>        <span class="token keyword">select</span> <span class="token punctuation">{</span><br>        <span class="token keyword">case</span> task<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>taskQueue<span class="token punctuation">:</span><br>            <span class="token comment">// ...</span><br>            <span class="token keyword">select</span> <span class="token punctuation">{</span><br>            <span class="token keyword">case</span> p<span class="token punctuation">.</span>workerQueue <span class="token operator">&lt;-</span> task<span class="token punctuation">:</span><br>            <span class="token keyword">default</span><span class="token punctuation">:</span><br>                <span class="token comment">// Create a new worker, if not at max.</span><br>                <span class="token keyword">if</span> workerCount <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>maxWorkers <span class="token punctuation">{</span><br>                    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>                    <span class="token keyword">go</span> <span class="token function">worker</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> p<span class="token punctuation">.</span>workerQueue<span class="token punctuation">,</span> <span class="token operator">&</span>wg<span class="token punctuation">)</span><br>                    workerCount<span class="token operator">++</span><br>                <span class="token punctuation">}</span><br>                <span class="token comment">//...</span><br>            <span class="token punctuation">}</span><br>            <span class="token comment">//...</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <span class="token comment">//...</span><br><span class="token punctuation">}</span></code></pre><p>Job 進來會直接發進 workerQueue 中，如果發不進去，表示每個 worker 都在忙碌，這時先確認當前的 worker 量是否小於最大值，如果是，起一個新的 Goroutine 來幫忙處理 Job。</p><p>至於要回收的話，看 select 的另一條分支</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    timeout <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span>idleTimeout<span class="token punctuation">)</span><br>    <span class="token comment">//...</span><br>    <span class="token keyword">for</span> <span class="token punctuation">{</span><br>        <span class="token comment">//...</span><br>        <span class="token keyword">select</span> <span class="token punctuation">{</span><br>        <span class="token comment">//...</span><br>        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>timeout<span class="token punctuation">.</span>C<span class="token punctuation">:</span><br>            <span class="token keyword">if</span> idle <span class="token operator">&&</span> workerCount <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span><br>                <span class="token keyword">if</span> p<span class="token punctuation">.</span><span class="token function">killIdleWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    workerCount<span class="token operator">--</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>            idle <span class="token operator">=</span> <span class="token boolean">true</span><br>            timeout<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>idleTimeout<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <span class="token comment">//...</span><br><span class="token punctuation">}</span></code></pre><p>有個 timer 會每 2s 起來看一次，如果這時發現沒有任務執行，而且 worker 的量大於 0，就送出結束訊號，讓 worker 停止。這樣可以降低記憶體的使用，讓閒置的 worker 不要占用資源。</p><h2 id="%E5%B0%8F%E7%B5%90"><a href="#%E5%B0%8F%E7%B5%90" class="direct-link">#</a> 小結</h2><p>Worker Pool 透過資源的重複利用，降低 Goroutine 配置與回收的次數，在高併發的場景中，算是個常見的模式。儘管 Worker Pool 的好處很明顯，我還是會建議在優化前，先確認系統的效能瓶頸在哪裡，例如，如果是個 IO Bound 的系統，採用 Worker Pool 可能不一定有幫助；但如果是個 CPU Bound 的系統，採用 Work Pool 應該能降低 CPU 的壓力。</p><p>這篇放進「驗證設計」一節，也是因為寫一寫突然好奇，花功夫設計完一套機制，能帶來多少改善？在單純只看 Goroutine 配置的情況下，我的實驗是 22% 的提升，但如果加入實際的 Job 內容，還能有同樣的改善幅度嗎？我猜在 GC 壓力很大的情況下，效益應該會變得更明顯，反過來說，如果平常也不太會有 GC，Worker Pool 可能也不是必須的。</p><p>希望看完這篇文章，能讓大家在設計或選擇 Worker Pool 時更有方向。</p><h2 id="reference"><a href="#reference" class="direct-link">#</a> Reference</h2><ul><li><a href="https://gobyexample.com/worker-pools" rel="noopener noreferrer" target="_blank">Go by Example: Worker Pools</a></li><li>Concurrency in Go</li><li><a href="https://hspazio.github.io/2017/worker-pool/" rel="noopener noreferrer" target="_blank">Implementing a worker pool</a></li><li><a href="http://marcio.io/2015/07/handling-1-million-requests-per-minute-with-golang/" rel="noopener noreferrer" target="_blank">Handling 1 Million Requests per Minute with Go</a></li><li><a href="https://itnext.io/explain-to-me-go-concurrency-worker-pool-pattern-like-im-five-e5f1be71e2b0" rel="noopener noreferrer" target="_blank">Explain to me Go Concurrency Worker Pool Pattern like I’m five</a></li><li><a href="https://github.com/gammazero/workerpool" rel="noopener noreferrer" target="_blank">gammazero/workerpool: Concurrency limiting goroutine pool</a></li><li><a href="https://github.com/panjf2000/ants" rel="noopener noreferrer" target="_blank">panjf2000/ants: 🐜🐜🐜 ants is a high-performance and low-cost goroutine pool in Go</a></li></ul><div class="article-footer"></div><div><p style="font-weight: bold;">標籤</p><div class="post-tags"><a href="/tags/go/" class="post-tag">Go</a> <a href="/tags/concurrency/" class="post-tag">Concurrency</a></div><p style="font-weight: bold;">其他文章</p><ul><li><a href="/posts/2020/gorm-from-init-to-use/">GORM：從建置到 CRUD</a></li><li><a href="/posts/2019/use-codelite-to-program-c/">C++ 開發環境架設：使用 CodeLite</a></li><li><a href="/posts/2019/use-commitizen-to-write-graceful-git-comment/">輕鬆上手約定式提交：Commitizen 初體驗</a></li><li><a href="/posts/2019/use-prometheus-to-monitor-end-devices/">監控節點的度量指標：Prometheus 入門</a></li><li><a href="/posts/2019/visualize-your-redmine-data/">掌握 Redmine 的活動指標：繪製熱度圖</a></li></ul></div><p style="font-weight: bold;">評論</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="ken00535/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Goroutine 的併發治理：管理 Worker Pool","image":["https://blog.kenwsc.com/img/posts/2022/concurrency-of-go-worker-pool/worker-1-1920w.png"],"author":{"@type":"Person","name":""},"publisher":{"@type":"Organization","name":"Ken Chen&#39;s Blog","url":"https://blog.kenwsc.com","logo":{"@type":"ImageObject","url":"https://blog.kenwsc.com/img/favicon/favicon.png","width":512,"height":512}},"url":"https://blog.kenwsc.com/posts/2022/concurrency-of-go-worker-pool/","mainEntityOfPage":"https://blog.kenwsc.com/posts/2022/concurrency-of-go-worker-pool/","datePublished":"2022-12-20","dateModified":"2023-01-06","description":"併發會需要多個 Goroutine 來同時執行任務，Goroutine 雖然輕量，也還是有配置成本，如果每次新的任務進來，都需要重新建立並配置 Goroutine，一方面不容易管理 Goroutine 的記憶體，一方面也會消耗 CPU 的運算效能。這時 Worker Pool..."}</script></article></main><footer><div class="footer-logos"><a href="https://medium.com/@ken00535" rel="noopener noreferrer" target="_blank"><img height="50" src="/img/icons/icon_social media_medium.svg" width="50" alt="medium"></a><a href="https://www.linkedin.com/in/ken00535" rel="noopener noreferrer" target="_blank"><img height="30" src="/img/icons/icon_social media_linkedln.svg" width="30" alt="linkedin"></a><a href="https://blog.kenwsc.com/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img height="30" src="/img/icons/rss-feed.svg" width="30" alt="rss feed"></a></div><div class="copyright">© 2022 Ken Chen's Blog, Powered by <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>