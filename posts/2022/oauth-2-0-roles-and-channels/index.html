<!DOCTYPE html><html domain="blog.kenwsc.com" ga-id="GTM-MM4P38S" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="Backend,Golang" name="keywords"><link href="/img/favicon/favicon.png?hash=b6fc65e341" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>OAuth 2.0：角色與信道</title><meta content="OAuth 2.0：角色與信道" property="og:title"><meta content="OAuth 2.0：角色與信道" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="當需要取得使用者資訊時，我們可以合理假設，使用者資訊已經存在社群媒體中，例如 Google、Facebook、Twitter、GitHub，而我們需要的只是請求使用者同意，讓我們可以代表使用者，存取社群媒體中受限制的資源。也就是，我們關注的是有沒有一個授權框架，可以讓第三方應用取得對資源的訪問權限。這篇文的出發點是想探討 OAuth 2.0 的授權模型。讓開發者在選擇授權許可時，能理解角色間的互動，還有設計上要注意的資安風險。…" name="description"><meta content="當需要取得使用者資訊時，我們可以合理假設，使用者資訊已經存在社群媒體中，例如 Google、Facebook、Twitter、GitHub，而我們需要的只是請求使用者同意，讓我們可以代表使用者，存取社群媒體中受限制的資源。也就是，我們關注的是有沒有一個授權框架，可以讓第三方應用取得對資源的訪問權限。這篇文的出發點是想探討 OAuth 2.0 的授權模型。讓開發者在選擇授權許可時，能理解角色間的互動，還有設計上要注意的資安風險。…" name="twitter:description"><meta content="當需要取得使用者資訊時，我們可以合理假設，使用者資訊已經存在社群媒體中，例如 Google、Facebook、Twitter、GitHub，而我們需要的只是請求使用者同意，讓我們可以代表使用者，存取社群媒體中受限制的資源。也就是，我們關注的是有沒有一個授權框架，可以讓第三方應用取得對資源的訪問權限。這篇文的出發點是想探討 OAuth 2.0 的授權模型。讓開發者在選擇授權許可時，能理解角色間的互動，還有設計上要注意的資安風險。…" property="og:description"><meta content="article" property="og:type"><meta content="https://blog.kenwsc.com/posts/2022/oauth-2-0-roles-and-channels/" property="og:url"><meta content="Ken Chen's Blog" property="og:site_name"><meta content="https://blog.kenwsc.com/img/posts/2022/oauth-2-0-roles-and-channels/cover.png" property="og:image"><meta content="https://blog.kenwsc.com/img/posts/2022/oauth-2-0-roles-and-channels/cover.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://blog.kenwsc.com/posts/2022/oauth-2-0-roles-and-channels/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Ken Chen's Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
            var f = d.getElementsByTagName(s)[0];
            var j = d.createElement(s);
            var dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-MM4P38S');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}dl{clear:both;display:block!important;margin:0 0 1.5em}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.5rem;margin-bottom:1rem}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,h3,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:1.75rem}h3{font-size:1.5rem}body,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,h3,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}button,code{border-radius:.3em}code{color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li dl,li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.punctuation{color:#ccc}.token.function,.token.number{color:#f08d49}.token.class-name,.token.property{color:#f8c555}.token.builtin{color:#cc99cd}.token.string,.token.variable{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post{padding-top:35px}.post+div,footer{margin-top:35px;border-top:1px solid #ccc}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:240px;height:40px;background:url(/img/logo.png) no-repeat;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.post-tag:not(body){text-decoration:none;background-color:#f5f5f5;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border-radius:20px;color:#4a4a4a;display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;font-size:.75rem;height:2em;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;line-height:1.5;padding-left:.75em;padding-right:.75em;white-space:nowrap}.post-tag:hover{text-decoration:none;background:#ccc}.direct-link{display:none}.post-avatar{display:flex;align-items:center;height:36px}.post-avatar__time{font-size:13px}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:240px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px;width:max-content}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">文章列表</a> <a href="/tags/">標籤</a> <a href="/about/">關於我</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">OAuth 2.0：角色與信道</h1><aside class="w-full"><div class="post-avatar"><div class="post-avatar__time">Ken Chen | 02 Nov 2022 <a href="/tags/web/" class="post-tag">Web</a> <a href="/tags/authorization/" class="post-tag">Authorization</a></div></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>使用者體驗是 B2C 重要的產品面向。通常一個網路服務，會要求使用者註冊帳戶後才能開始使用——以台灣金融保險法規為例，使用者需要建立帳戶後，才能得到報價。站在行銷觀點，註冊會降低用戶的轉換率，因為它需要填寫姓名、暱稱、生日、信箱等資料，步驟相當繁瑣，對行動場景，這百分百是個負面體驗。這讓人不禁想問，這個環節是可以優化的嗎？</p><p>事實上，我們可以合理假設使用者資訊已經存在社群媒體中，例如 Google、Facebook、Twitter、GitHub，而我們需要的只是請求使用者同意，讓我們可以代表使用者，存取社群媒體中受限制的資源。也就是，我們關注的是有沒有一個授權框架，可以讓第三方應用取得對資源的訪問權限。</p><h2 id="oauth-2.0"><a href="#oauth-2.0" class="direct-link">#</a> OAuth 2.0</h2><p>這就帶到 OAuth 2.0 想要解決的問題。在傳統的 Client-Server 認證架構中，當客戶端要存取伺服端資源時，需要提供使用者的帳號密碼。如果發起請求的是第三方應用，則資源擁有者要將帳號密碼提供給第三方應用。可以想像，你需要請人幫你收信，就需要把家裡鑰匙交給對方。而這會有幾個問題：</p><ul><li>第三方應用會儲存使用者帳號密碼，而且為了後續使用，會存成明文。</li><li>第三方應用會得到完整權限，使用者沒辦法限制第三方應用的使用時間與存取範圍。</li><li>第三方應用的存取權無法單方面撤回，如果修改密碼，不只是想撤回的應用，所有應用的存取權都會被撤銷。</li><li>任何第三方應用被駭，所有的用到該密碼的資源都可能被惡意人士存取。</li></ul><h2 id="%E8%A7%92%E8%89%B2%E5%AE%9A%E7%BE%A9"><a href="#%E8%A7%92%E8%89%B2%E5%AE%9A%E7%BE%A9" class="direct-link">#</a> 角色定義</h2><p>你可能會發現，我們要做的是件很衝突的事。一方面希望可以對應用授權，另一方面又希望授權不會有資安問題。處理過金融應用的人應該深有同感，金融的基礎就是信任，而信任關係著角色的分配與互動。以常見的例子來說，開發者跟維運人員的角色不同，不僅是為了讓責任更明確，也是為了防止開發問題影響到生產環境。</p><p>OAuth 2.0 在系統設計中，定義了四個角色</p><p align="center"><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/oauth-2-0-roles-and-channels/oauth-1-1920w.webp 1920w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-1-1280w.webp 1280w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-1-840w.webp 840w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/oauth-2-0-roles-and-channels/oauth-1-1920w.png 1920w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-1-1280w.png 1280w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-1-840w.png 840w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-1-320w.png 320w" type="image/png"><img height="453" src="/img/posts/2022/oauth-2-0-roles-and-channels/oauth-1-1920w.png" width="669" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 669 453'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAIAAACepSOSAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAbklEQVQImSXNSQoEMQxD0dz/qKECZcuDnAGaVGuv/xqLJM1Mvilg5r13d29rr6oyM1UVEQCZGRFJNg+HISIAiIi7A+i9i2qrWSxW1ZyTzL03yfvLvM3r4XrPeMysqsYYn7fWOSczAQVUVd/3/Qd+0rCbEnmla88AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p><strong>資源擁有者(Resource Owner)</strong> 是能授權訪問權限的主體。通常資源擁有者是終端使用者，他們握有密碼，能進行身分認證，並核可授權範圍。在網路世界，終端使用者會透過瀏覽器跟網路服務互動，我們可以把瀏覽器看成是使用者的代理人，稱為「用戶代理」，這意味著，安全的瀏覽器非常重要，一名不可靠的代理人容易有資安問題。</p><p><strong>受保護資源(Protected Resource)</strong> 是資源擁有者存放在其他服務的資源，在社群媒體註冊的例子中，受保護資源是資源擁有者的個人資訊。如前面提到的，為降低服務的使用門檻，第三方應用希望取得既有的受保護資源，至於如何取得呢？第三方應用會在請求時攜帶 Token，說明自己有得到授權，受保護資源確認 Token 後，會允許第三方應用訪問核可的資源。</p><p>講到第三方應用，在 OAuth 2.0 的正式名稱叫<strong>客戶端(Client)</strong>，是代表資源擁有者存取受保護資源的主體，可以理解成需要存取資源的應用。如前面講到的，該應用需要攜帶 Token 來請求資源。因此在 OAuth 2.0 中，它主要負責請求和使用 Token。</p><p><strong>授權伺服器(Authorization Server)</strong> 負責認證與授權的伺服器。OAuth 2.0 為區別資源擁有者與客戶端兩個角色，在中間引入授權伺服器，將資源擁有者的權限轉換成客戶端使用的 Token。舉例來說，辦公室的門禁系統，員工可以持員工證進入大門，因為該員工證是系統發放的憑證。但使用同樣的憑證，卻可能進不去 SRE 的機房，因為機房不在該憑證的授權範圍內。藉由這樣的機制，限定受保護資源的存取，讓認證不等同授權。</p><h3 id="token"><a href="#token" class="direct-link">#</a> Token</h3><p>在前面的介紹中，我們說到客戶端跟受保護資源彼此隔離，透過授權服務器核發的 Token 來存取資源。因此在 OAuth 2.0 中，Token 代表著資源擁有者授予客戶端的存取權限。用門禁系統來比喻的話，可以看成是員工證這樣的工具。</p><p>值得注意的是，Token 對不同角色的透明程度不同，對客戶端來說，因為它不需要知道 Token 的內容，只需要在請求資源時攜帶 Token，所以 Token 對它是不透明的存在。這就像我們不需要知道員工證感應時傳遞了哪些資訊，只需要知道員工證可以打開大門。而授權伺服器負責頒發 Token，受保護資源負責驗證 Token，兩者都會需要知道 Token 具體的含意。在這裡，使用 Token，而不是帳號密碼的設計，可以讓客戶端保持單純，因為它不透明的特性，客戶端不會受到 Token 變動的影響。即使使用者的密碼更改了，客戶端仍然可以維持相同設定。</p><p>圍繞著 Token，也延伸出一個議題：權限應該如何獲取？我們可以想像，四個角色在處理授權時應該會遵循一套流程，OAuth 2.0 稱呼這套流程為<strong>授權許可(Authorization Grant)</strong>，客戶端用它來取得 Token，並用 Token 向受保護資源發出請求。為因應不同的應用場景，RFC 6749 有定義出四套授權許可類型，分別是</p><ul><li>授權碼許可類型(Authorization Code)</li><li>隱式許可類型(Implicit)</li><li>資源擁有者憑證許可類型(Resource Owner Password Credentials)</li><li>客戶端憑證許可類型(Client Credentials)</li></ul><p>其中以授權碼許可類型最為普遍。</p><h2 id="%E4%BF%A1%E9%81%93"><a href="#%E4%BF%A1%E9%81%93" class="direct-link">#</a> 信道</h2><p>現在我們有了角色，也有了流程。角色間要交流，就會需要有通信的管道，這稱為信道(Channel)。OAuth 2.0 是基於 HTTP 實現的，因此會使用 HTTP 來傳遞訊息，然而，HTTP 的通訊模型與 OAuth 2.0 的設計存在語義落差，我們需要找出彼此的對應關係，才能實現角色間的通訊。在這裡，我們依照通訊是否經過資源擁有者，將信道分為兩種類型：後端信道(Back-channel)與前端信道(Front-channel)。</p><p><strong>後端信道(Back-channel)</strong> 使用常見的 Client-Server 通訊，因為通訊發生在資源擁有者的可見範圍外，所以稱為後端(Back)。具體來說，會依照授權許可的不同，而有不同的實現。像客戶端跟授權伺服器兌換 Token，或客戶端向受保護資源存取資源，都是通過後端信道。這樣的好處是，使用者不需要參與其中，動作能自動完成，而且因為請求沒有暴露，能降低攻擊面積，從資安的角度來講更加安全。</p><p align="center"><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/oauth-2-0-roles-and-channels/oauth-2-1920w.webp 1920w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-2-1280w.webp 1280w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-2-840w.webp 840w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/oauth-2-0-roles-and-channels/oauth-2-1920w.png 1920w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-2-1280w.png 1280w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-2-840w.png 840w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-2-320w.png 320w" type="image/png"><img height="392" src="/img/posts/2022/oauth-2-0-roles-and-channels/oauth-2-1920w.png" width="529" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 529 392'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAIAAABV+fA3AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAz0lEQVQImQHEADv/AM/a5Zy0yv////3+/v///8rd8KDD5aDD5eXu+AAkWIsFP3qJpcD///////9poNUHYroDXbmxzOkAQ3CbL2GRla7G////+/j2p8ThcqbZcKTX1uX0AP////////39/fb29vT09Pz8/P///////////wCTu+GUvOOzy+T59/b////A1+2RueGQueDf6/YAAFa1AFi3TIrI//z3/fn1XZXMAV+6AFm2scvoAIay3YOw3LLN6f/+/f///bnS6oKw3YKw3Nzp9cJSkXY47WIXAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>常見的後端信道請求類似</p><pre class="language-bash"><code class="language-bash">POST /token<br>Host: localhost:9001<br>Accept: application/json<br>Content-type: application/x-www-form-encoded<br>Authorization: Basic b2F1dGgtY2xpZW50LTE6b2F1dGgtY2xpZW50LXNlY3JldC0x<br><br><span class="token assign-left variable">grant_type</span><span class="token operator">=</span>authorization_code<span class="token operator">&</span><span class="token assign-left variable">redirect_uri</span><span class="token operator">=</span>http%3A%2F%2Flocalhost%3A9000%2Fcallback<span class="token operator">&</span><span class="token assign-left variable">code</span><span class="token operator">=</span>8V1pr0rJ</code></pre><p>而響應則是</p><pre class="language-bash"><code class="language-bash">HTTP <span class="token number">200</span> OK<br>Date: Fri, <span class="token number">31</span> Jul <span class="token number">2015</span> <span class="token number">21</span>:19:03 GMT<br>Content-type: application/json<br><br><span class="token punctuation">{</span><br>    <span class="token string">"access_token"</span><span class="token builtin class-name">:</span> <span class="token string">"987tghjkiu6trfghjuytrghj"</span>,<br>    <span class="token string">"token_type"</span><span class="token builtin class-name">:</span> <span class="token string">"Bearer"</span><br><span class="token punctuation">}</span></code></pre><p><strong>前端信道(Front-channel)</strong> 是經過資源擁有者的通信管道，通過瀏覽器使用 HTTP 的重定向來實現。可能有人會好奇，既然已經有後端信道，而且資安防護上更好，為什麼還需要用前端信道來通訊？原因是，我們不希望由客戶端來進行身分認證與授權。資源擁有者可以把授權結果轉交給客戶端，可是不會把帳號密碼交給客戶端。它的目的是隔離客戶端跟授權伺服器間的通訊，讓資源擁有者參與到認證與授權過程，而不是由客戶端自行處理。</p><p align="center"><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/oauth-2-0-roles-and-channels/oauth-3-1920w.webp 1920w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-3-1280w.webp 1280w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-3-840w.webp 840w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-3-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/oauth-2-0-roles-and-channels/oauth-3-1920w.png 1920w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-3-1280w.png 1280w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-3-840w.png 840w, /img/posts/2022/oauth-2-0-roles-and-channels/oauth-3-320w.png 320w" type="image/png"><img height="383" src="/img/posts/2022/oauth-2-0-roles-and-channels/oauth-3-1920w.png" width="521" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 521 383'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAIAAABV+fA3AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAx0lEQVQImWP4+etP4/zdl+8+/w8Gn7//WXzk6dTdD9eefsEQ3bSCwbpcK6b36u1H////PnX9iUjmPoao7brlRxjKZ2zXie3zr1j44s3H////v/74vXXj3aKlNybvesjw////929e/fv3D2ImMmDYcPZl+7prcw48efvl1////z99/73g8JNJOx+uPvmcwbr+OEPsTo7EXWfugcy8+fyLZO4+loRdBtXHGKbvfZS3+Hr1mlvP3v/4////2y+/GtbfyV18vX/HAwDH/I7SlXRoxwAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>聽起來有些複雜，希望客戶端能得到授權結果，卻又不希望客戶端自行處理，這是什麼意思？當我們覺得軟體太複雜時，請想想身邊的例子。假設你現在想請假，會怎麼做呢？你會上請假系統申請假單，假單經主管簽核後生效，在請假日就可以不用上班。同樣的，當客戶端需要資源時，它會講說，請幫我到授權伺服器核准，核准後，授權結果才會轉交給客戶端。如果讓客戶端自行處理，就像一個員工可以自己簽假單，你會希望他簽核時有摸著良心。</p><p>在授權模型中，真正需要資源擁有者參與的，只有「認證」與「授權」，其他事情都希望能自動完成。前端信道的設計是利用 HTTP 的重定向跟瀏覽器收到重定向後的跳轉來達成。希望獲得授權的客戶端，會在瀏覽器發起請求時回覆</p><pre class="language-bash"><code class="language-bash">HTTP <span class="token number">302</span> Found<br>Location: http://localhost:9001/authorize?client_id<span class="token operator">=</span>oauth-client-1<span class="token operator">&</span>response_<br><span class="token assign-left variable">type</span><span class="token operator">=</span>code<span class="token operator">&</span><span class="token assign-left variable">state</span><span class="token operator">=</span>843hi43824h42tj</code></pre><p>瀏覽器收到回覆後，因為有 302，會自動導向 Location 中的授權伺服器授權端點，交由資源擁有者與授權伺服器進行認證與授權。等到完成後，授權伺服器會回覆瀏覽器</p><pre class="language-bash"><code class="language-bash">HTTP <span class="token number">302</span> Found<br>Location: http://localhost:9000/oauth_callback?code<span class="token operator">=</span>23ASKBWe4<span class="token operator">&</span><span class="token assign-left variable">state</span><span class="token operator">=</span>843hi438</code></pre><p>瀏覽器收到後，會再重新導向到客戶端。</p><p>跟後端信道比起來，前端信道給了資源擁有者參與的空間，也給了惡意攻擊者攻擊的空間。就像前面討論的，前端信道是透過 HTTP 重定向的方式來傳遞訊息，而重定向是種間接的通訊方式，客戶端跟授權伺服器兩端，沒辦法知道發出的響應是否真的有到達目的地，也不知道中間是不是有被竄改跟複製。攻擊者可以攔截重定向的位置，修改後傳給受害者，而當受害者將修改後的重定向位置傳給授權伺服器時，授權伺服器也不知道這個請求的來源是正常還是惡意。因為這個緣故，在使用前端信道傳遞訊息時，會需要注意相對應的資安措施是否做到位。</p><h2 id="%E5%B0%8F%E7%B5%90"><a href="#%E5%B0%8F%E7%B5%90" class="direct-link">#</a> 小結</h2><p>這篇文的出發點是想探討 OAuth 2.0 的授權模型。讓開發者在選擇授權許可時，能理解角色間的互動，還有設計上要注意的資安風險。資安問題也是 OAuth 2.0 這麼複雜的主因，實作上許多細節都是為了處理各種資安漏洞。要理解這些漏洞為什麼存在，就必須理解角色權責與信道，如果我是攻擊者，想取得 Token 好存取受保護資源，我可能會偽造角色（假的客戶端）或偽造信道（修改重定向後讓被害者使用），而這些偽造方式，又跟互動模式有密切關係。</p><p>希望讀完這篇文後，能幫助讀者釐清一些原本的困惑，知道 OAuth 2.0 的原理與限制。</p><h2 id="reference"><a href="#reference" class="direct-link">#</a> Reference</h2><ul><li><a href="https://www.rfc-editor.org/rfc/rfc6749" rel="noopener noreferrer" target="_blank">RFC 6749: The OAuth 2.0 Authorization Framework</a></li><li><a href="https://github.com/oauthinaction/oauth-in-action-code/" rel="noopener noreferrer" target="_blank">GitHub - oauthinaction/oauth-in-action-code: Source code for OAuth 2 in Action</a></li><li><a href="https://l3ouu4n9.github.io/post/learningnotes/2021-05-27-oauth-notes/" rel="noopener noreferrer" target="_blank">OAuth 2.0 學習筆記</a></li><li><a href="https://developers.google.com/identity/protocols/oauth2/web-server#httprest" rel="noopener noreferrer" target="_blank">Using OAuth 2.0 for Web Server Applications | Authorization | Google Developers</a></li><li><a href="https://xiang753017.gitbook.io/zixiang-blog/security/cong-rfc-gui-ge-shu-guan-dian-jie-xi-oauth-2.0" rel="noopener noreferrer" target="_blank">從 RFC 規格書觀點解析 OAuth 2.0</a></li></ul><div class="article-footer"></div><div><p style="font-weight: bold;">標籤</p><div class="post-tags"><a href="/tags/web/" class="post-tag">Web</a> <a href="/tags/authorization/" class="post-tag">Authorization</a></div><p style="font-weight: bold;">其他文章</p><ul><li><a href="/posts/2022/error-as-resource-grpc-error-handling/">讓錯誤成為資源：gRPC 的錯誤處理模型</a></li><li><a href="/posts/2022/go-dependency-injection-by-fx/">用 Fx 來替 Go 依賴注入吧</a></li><li><a href="/posts/2019/use-feedly-to-subscribe-facebooks-group/">訂閱 Facebook Group 的訊息：自建 RSS 伺服器</a></li><li><a href="/posts/2019/visualize-your-redmine-data/">掌握 Redmine 的活動指標：繪製熱度圖</a></li><li><a href="/posts/2019/using-physical-disc-with-virtualbox/">用 VirtualBox 開啟實體硬碟中的 Windows</a></li></ul></div><p style="font-weight: bold;">評論</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="ken00535/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"OAuth 2.0：角色與信道","image":["https://blog.kenwsc.com/img/posts/2022/oauth-2-0-roles-and-channels/oauth-1-1920w.png","https://blog.kenwsc.com/img/posts/2022/oauth-2-0-roles-and-channels/oauth-2-1920w.png","https://blog.kenwsc.com/img/posts/2022/oauth-2-0-roles-and-channels/oauth-3-1920w.png"],"author":{"@type":"Person","name":""},"publisher":{"@type":"Organization","name":"Ken Chen&#39;s Blog","url":"https://blog.kenwsc.com","logo":{"@type":"ImageObject","url":"https://blog.kenwsc.com/img/favicon/favicon.png","width":512,"height":512}},"url":"https://blog.kenwsc.com/posts/2022/oauth-2-0-roles-and-channels/","mainEntityOfPage":"https://blog.kenwsc.com/posts/2022/oauth-2-0-roles-and-channels/","datePublished":"2022-11-02","dateModified":"2023-01-30","description":"使用者體驗是 B2C..."}</script></article></main><footer><div class="footer-logos"><a href="https://medium.com/@ken00535" rel="noopener noreferrer" target="_blank"><img height="50" src="/img/icons/icon_social media_medium.svg" width="50" alt="medium"></a><a href="https://www.linkedin.com/in/ken00535" rel="noopener noreferrer" target="_blank"><img height="30" src="/img/icons/icon_social media_linkedln.svg" width="30" alt="linkedin"></a><a href="https://blog.kenwsc.com/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img height="30" src="/img/icons/rss-feed.svg" width="30" alt="rss feed"></a></div><div class="copyright">© 2023 Ken Chen's Blog, Powered by <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>