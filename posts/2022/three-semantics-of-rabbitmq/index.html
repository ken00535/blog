<!DOCTYPE html><html domain="blog.kenwsc.com" ga-id="G-G76M9XJCKN" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="Backend,Golang" name="keywords"><link href="/img/favicon/favicon.png?hash=b6fc65e341" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>關於消息的三層語義：以 RabbitMQ 為例</title><meta content="關於消息的三層語義：以 RabbitMQ 為例" property="og:title"><meta content="關於消息的三層語義：以 RabbitMQ 為例" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="對分散式系統來說，消息的可靠性非常重要，想想一個金融應用的場景，如果在支付時，消息遺失了，或是重複遞送了，都會造成使用者的困擾。當我們在系統中引入消息隊列時，我們同時引入了複雜度，這意思是，系統的「處理消息」跟你想的不一定是同一件事。從可靠性的角度來看，「處理消息」的語義可以分為三個層次，第一層是「最多一次」，當你請系統處理消息時，它會幫你進行，但最多一次，並且不保證是否完成；第二層是「最少一次」…" name="description"><meta content="對分散式系統來說，消息的可靠性非常重要，想想一個金融應用的場景，如果在支付時，消息遺失了，或是重複遞送了，都會造成使用者的困擾。當我們在系統中引入消息隊列時，我們同時引入了複雜度，這意思是，系統的「處理消息」跟你想的不一定是同一件事。從可靠性的角度來看，「處理消息」的語義可以分為三個層次，第一層是「最多一次」，當你請系統處理消息時，它會幫你進行，但最多一次，並且不保證是否完成；第二層是「最少一次」…" name="twitter:description"><meta content="對分散式系統來說，消息的可靠性非常重要，想想一個金融應用的場景，如果在支付時，消息遺失了，或是重複遞送了，都會造成使用者的困擾。當我們在系統中引入消息隊列時，我們同時引入了複雜度，這意思是，系統的「處理消息」跟你想的不一定是同一件事。從可靠性的角度來看，「處理消息」的語義可以分為三個層次，第一層是「最多一次」，當你請系統處理消息時，它會幫你進行，但最多一次，並且不保證是否完成；第二層是「最少一次」…" property="og:description"><meta content="article" property="og:type"><meta content="https://blog.kenwsc.com/posts/2022/three-semantics-of-rabbitmq/" property="og:url"><meta content="Ken Chen's Blog" property="og:site_name"><meta content="https://blog.kenwsc.com/img/posts/2022/three-semantics-of-rabbitmq/cover.png" property="og:image"><meta content="https://blog.kenwsc.com/img/posts/2022/three-semantics-of-rabbitmq/cover.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://blog.kenwsc.com/posts/2022/three-semantics-of-rabbitmq/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Ken Chen's Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-G76M9XJCKN"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-G76M9XJCKN');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}.article-footer img,body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:1.75rem}body,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}button,code{border-radius:.3em}code{color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2{font-family:var(--font-family)}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.boolean,.token.function{color:#f08d49}.token.property{color:#f8c555}.token.builtin,.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}#nav,.menu__btn{position:relative}.menu__btn{display:inline-block;width:24px;height:24px}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav{height:68px;z-index:2;align-items:center}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}#nav,.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}footer{margin-top:48px;font-size:14px;padding:24px;border-top:1px solid #ccc;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.post-tag:not(body){text-decoration:none;background-color:#f5f5f5;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border-radius:20px;color:#4a4a4a;display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;font-size:.75rem;height:2em;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;line-height:1.5;padding-left:.75em;padding-right:.75em;white-space:nowrap}.post-tag:hover{text-decoration:none;background:#ccc}.direct-link{display:none}.post-avatar{display:flex;align-items:center;height:36px}.post-avatar__time{font-size:13px}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}</style></head><body><header><nav><div id="nav"><div class="nav__links"><a href="/" title="Homepage">Home</a> <a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">關於消息的三層語義：以 RabbitMQ 為例</h1><aside class="w-full"><div class="post-avatar"><div class="post-avatar__time">Ken Chen | 22 Oct 2022 <a href="/tags/go/" class="post-tag">Go</a> <a href="/tags/rabbitmq/" class="post-tag">RabbitMQ</a> <a href="/tags/message-queue/" class="post-tag">Message Queue</a></div></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>對分散式系統來說，消息的可靠性非常重要，想想一個金融應用的場景，如果在支付時，消息遺失了，或是重複遞送了，都會造成使用者的困擾。當我們在系統中引入消息隊列時，我們同時引入了複雜度，這意思是，系統的「處理消息」跟你想的不一定是同一件事。從可靠性的角度來看，「處理消息」的語義可以分為三個層次，第一層是「最多一次」，當你請系統處理消息時，它會幫你進行，但最多一次，並且不保證是否完成；第二層是「最少一次」，系統會幫你處理消息，而且附帶必要的錯誤處理，確保消息至少被完成一次；第三層是「準確一次」，意指消息不多不少，恰恰好被準確處理並完成了一次。</p><p>當試著從語言學的角度來看待系統時，我們才能規劃出系統的整體面貌。儘管「準確處理一次」有最佳的可靠性，但因為其處理成本，降低了系統整體的吞吐量。在〈Starbucks Does Not Use Two-Phase Commit〉一文中，Gregor Hohpe 精確描繪了星巴克的異步系統。收銀員收費後，將咖啡杯放到隊列中，等待咖啡師處理，再交給取貨區的顧客。這個過程中，收銀員跟咖啡師不會特別確認咖啡杯的狀態，假設咖啡杯被放錯位置，直到顧客反應前都沒有人會知道，這是「最多一次」的語義；但如果咖啡杯掉落到地上，他們可能會重新做一杯新的咖啡，這裡就是「最少一次」的語義。因此我們可以說，星巴克是在「最多一次」的基礎上，有部分操作實現「最少一次」的語義。</p><h2 id="amqp-%26-rabbitmq"><a href="#amqp-%26-rabbitmq" class="direct-link">#</a> AMQP & RabbitMQ</h2><p>軟體的隊列設計也需要面臨類似問題，讓我們來看看 AMQP 的例子。AMQP 是由 JP Morgan Chase 提出的通訊協定，目的是為了讓消息隊列有個開放式的標準可以依循，如此一來，不同的語言跟架構能夠建置共通的應用程式。在 2007 年，Rabbit 公司開發一套開源軟體來實作 AMQP，稱為 RabbitMQ，現在由 Pivotal 維護。也因為它開源加上支持多語言客戶端，許多消息隊列會採用 RabbitMQ 來執行。</p><p>AMQP 的訊框格式是</p><pre><code>+ — — — + — — — — -+ — — — — -+ + — — — — — — -+ + — — — — — -+
| type  | channel  | size     | | payload      | | frame-end  |
+ — — — + — — — — -+ — — — — -+ + — — — — — — -+ + — — — — — -+
</code></pre><p>訊框的類型(type)分為 4 種。應用上常碰到的有 3 種</p><ul><li>METHOD(1)：該訊框用於傳送 AMQP 的指令</li><li>HEADER(2)：該訊框用於傳送 AMQP 的標頭</li><li>BODY(3)：該訊框用於傳送 AMQP 的內容</li></ul><p>其中 METHOD 會依照命令的不同，而有不同的參數(Argument)，實現越進階的語義就需要仰賴越複雜的設定。</p><h2 id="at-most-once"><a href="#at-most-once" class="direct-link">#</a> At most once</h2><p>先從最基本的「最多一次」來看。最多一次可以指生產端，也可以指消費端。對生產端來說，只要發佈一次消息就算完成語義，後續也不會再重發。這裡我們使用開源庫 <a href="https://github.com/wagslane/go-rabbitmq" rel="noopener noreferrer" target="_blank">go-rabbitmq</a>，來當 Golang 的 RabbitMQ 的客戶端，程式碼會是</p><pre class="language-go"><code class="language-go">producer<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><br>    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>“hello”<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    routingKeys<span class="token punctuation">,</span><br>    rabbitmq<span class="token punctuation">.</span><span class="token function">WithPublishOptionsExchange</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">)</span></code></pre><p>指定好內文、路由規則、還有交換器，進行發送。</p><p>因為已經保證了傳遞「最多一次」，消費端只要在這基礎上進行消費，就能達成語義</p><pre class="language-go"><code class="language-go">consumer<span class="token punctuation">.</span><span class="token function">StartConsuming</span><span class="token punctuation">(</span><br>    consumeMessage<span class="token punctuation">,</span><br>    queueName<span class="token punctuation">,</span><br>    routingKeys<span class="token punctuation">,</span><br><span class="token punctuation">)</span><br><br><span class="token keyword">func</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span>d rabbitmq<span class="token punctuation">.</span>Delivery<span class="token punctuation">)</span> rabbitmq<span class="token punctuation">.</span>Action <span class="token punctuation">{</span><br>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> rabbitmq<span class="token punctuation">.</span>Ack<br><span class="token punctuation">}</span></code></pre><p>指定消費函數、隊列名稱、路由規則來消費。</p><p>用 WireShark 抓封包的話，會看到 Basic.Publish 發佈了一次的消息</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-1-1920w.webp 1920w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-1-1280w.webp 1280w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-1-840w.webp 840w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-1-1920w.jpg 1920w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-1-1280w.jpg 1280w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-1-840w.jpg 840w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-1-320w.jpg 320w" type="image/jpeg"><img alt="" height="724" src="/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-1-1920w.jpg" width="2138" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2138 724'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAAi0lEQVQImX3E0Q6CIBhAYd7/nbqrTWvLhoJK6gQB5c/ArASvaq17z74dtD9ckoRRynHaVNVASItxQ4lgTEdxdk5YWaoilyhLcV1d26YWvJWd0EpqJXuttOrGGzwm94cwrUVvNbzMuJi7BxuM9eb3AHYFt4IL4ALaxfyUzxFdjoXfgOZphEG9n+6z2Rfk6K9+CbemrgAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>消費端也用 Basic.Consume 進行了消費</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-2-1920w.webp 1920w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-2-1280w.webp 1280w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-2-840w.webp 840w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-2-1920w.jpg 1920w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-2-1280w.jpg 1280w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-2-840w.jpg 840w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-2-320w.jpg 320w" type="image/jpeg"><img alt="" height="934" src="/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-2-1920w.jpg" width="2832" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2832 934'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAECAIAAADahiLjAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAAZUlEQVQImYXEQQqAIBBAUe9/rhZtZCJJxnQMSnJRWVquC4Ig2vT4fAaAnEspO6WG+33TWCGMbp0lb8kTeTIjQ4WI6JybHyGElFJM8Y2tyxS3cP5hBYxl7Xm7g8mgM+gDdK4+mXwBuUiNXG3MhaIAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h2 id="at-least-once"><a href="#at-least-once" class="direct-link">#</a> At least once</h2><p>「最多一次」對於分散式系統的應用來說是遠遠不夠的，假設客戶購買商品，產生一則消息，這個消息卻在傳遞的過程中因為一些網路問題而讓消息丟失，像是某人突然拔掉網路線，或是供電的電廠跳電，如果使用「最多一次」的語義，直到客戶反應前，我們都不會知道這個問題，同時，因為消息傳遞到一半丟失，有可能會造成系統狀態不一致，有部分系統已經執行過消息，有部分系統則是沒有。</p><p>如果問題是由消息丟失引起的，最直覺的想法就是重試。想想，客戶向星巴克的店員抱怨，他點的咖啡還沒好，店員查詢後發現漏單，因此重做一份，這稱為重試(Retry)。</p><p>同樣先從生產端來看。要重試，就需要先知道原本的消息是有否正確傳遞。這裡可以用 AMQP 的 Confirm 機制 來實現，時序圖上是</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/three-semantics-of-rabbitmq/pub-and-sub-1920w.webp 1920w, /img/posts/2022/three-semantics-of-rabbitmq/pub-and-sub-1280w.webp 1280w, /img/posts/2022/three-semantics-of-rabbitmq/pub-and-sub-840w.webp 840w, /img/posts/2022/three-semantics-of-rabbitmq/pub-and-sub-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/three-semantics-of-rabbitmq/pub-and-sub-1920w.jpg 1920w, /img/posts/2022/three-semantics-of-rabbitmq/pub-and-sub-1280w.jpg 1280w, /img/posts/2022/three-semantics-of-rabbitmq/pub-and-sub-840w.jpg 840w, /img/posts/2022/three-semantics-of-rabbitmq/pub-and-sub-320w.jpg 320w" type="image/jpeg"><img alt="" height="321" src="/img/posts/2022/three-semantics-of-rabbitmq/pub-and-sub-1920w.jpg" width="263" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 263 321'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAJCAIAAABxOqH0AAAACXBIWXMAAAPoAAAD6AG1e1JrAAAAiUlEQVQImTXMMQ6EMAwF0dz/citBSYGQEhNjILKCQWn8d0HslK+Y0HVd3/fDMACIMX6egogsy6KqAMws58zMwd1rrcw8jiMRmZm733pdlz2pKhEBCAByzkSUUooxHsdxq7uXUvZ9F5FSiqq+BzNj5mmamHmV9dV5nrdtIyJVPc/z1dYa/rXWfvoFmbWxSJWeSBIAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>在建立 channel 時，聲明這個 channel 需要 confirm。Broker 收到後會回 Confirm.Select-Ok，表示同意生產者將 channel 設為 confirm。之後，每次生產者發佈消息後，都會收到 Ack，如果因為 RabbitMQ 自身的問題導致消息丟失，則會回傳 Nack 給生產者。</p><p>程式碼會是</p><pre class="language-go"><code class="language-go">comfirmCh <span class="token operator">:=</span> producer<span class="token punctuation">.</span><span class="token function">NotifyPublish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>producer<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><br>    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>“hello”<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    routingKeys<span class="token punctuation">,</span><br>    rabbitmq<span class="token punctuation">.</span><span class="token function">WithPublishOptionsExchange</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    rabbitmq<span class="token punctuation">.</span>WithPublishOptionsMandatory<span class="token punctuation">,</span><br>    rabbitmq<span class="token punctuation">.</span>WithPublishOptionsPersistentDelivery<span class="token punctuation">,</span><br><span class="token punctuation">)</span><br>comfirmation <span class="token operator">:=</span> <span class="token operator">&lt;-</span>comfirmCh<br>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span>“receive<span class="token punctuation">:</span> <span class="token operator">%</span><span class="token operator">+</span>v\n”<span class="token punctuation">,</span> comfirmation<span class="token punctuation">)</span></code></pre><p>遺憾的是，僅僅這樣還不算達到「至少一次」的語義。讓我們更進一步思考情境。假設 Broker 能收到消息，可是卻因為設定的因素，導致消息無法被放入隊列，例如使用了一組不存在的路由規則。那 AMQP 應該如何通知這類「運行正常但邏輯有誤」的情況呢？這時需要用到 mandatory 這個 Publish 的參數。</p><p>當 Publish 附帶 mandatory 時，生產端會告訴 Broker，這則消息需要被放進 Queue 中，如果沒辦法放入的話，需要將此消息退回給我。在程式碼上，需要改成</p><pre class="language-go"><code class="language-go">comfirmCh <span class="token operator">:=</span> producer<span class="token punctuation">.</span><span class="token function">NotifyPublish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>returnCh <span class="token operator">:=</span> producer<span class="token punctuation">.</span><span class="token function">NotifyReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>err <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><br>    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"non-existence"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>    rabbitmq<span class="token punctuation">.</span><span class="token function">WithPublishOptionsExchange</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    rabbitmq<span class="token punctuation">.</span>WithPublishOptionsMandatory<span class="token punctuation">,</span><br><span class="token punctuation">)</span><br>comfirmation <span class="token operator">=</span> <span class="token operator">&lt;-</span>comfirmCh<br>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"receive: %+v\n"</span><span class="token punctuation">,</span> comfirmation<span class="token punctuation">)</span><br>returnVal <span class="token operator">:=</span> <span class="token operator">&lt;-</span>returnCh<br>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"receive: %+v\n"</span><span class="token punctuation">,</span> returnVal<span class="token punctuation">)</span><br><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>到此，我們可以確保消息會被放進隊列，但我們仍然沒辦法確保這則消息被放進隊列後，Broker 會突然關閉，導致消息丟失。要防範這情況，就需要持久化隊列中的消息。RabbitMQ 的持久化分爲三個部分：交換器的持久化、隊列的持久化和消息的持久化。這裡會需要操作的是後兩者。如果只設置隊列持久化，重啓 RabbitMQ 後，消息會丟失；只設置消息的持久化，重啓之後隊列消失，繼而消息也丟失。因此隊列跟消息的持久化都需要設定。</p><p>要設定隊列的持久化，用</p><pre class="language-go"><code class="language-go">conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> amqp<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>Url<span class="token punctuation">)</span><br>ch<span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token comment">// the second arg is durable</span><br><span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">QueueDeclare</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></code></pre><p>同時，在發布的消息中設定消息持久化</p><pre class="language-go"><code class="language-go">err <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><br>    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    routingKeys<span class="token punctuation">,</span><br>    rabbitmq<span class="token punctuation">.</span><span class="token function">WithPublishOptionsExchange</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    rabbitmq<span class="token punctuation">.</span>WithPublishOptionsMandatory<span class="token punctuation">,</span><br>    rabbitmq<span class="token punctuation">.</span>WithPublishOptionsPersistentDelivery<span class="token punctuation">,</span><br><span class="token punctuation">)</span></code></pre><p>來看 WireShark 抓到的封包</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-3-1920w.webp 1920w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-3-1280w.webp 1280w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-3-840w.webp 840w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-3-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-3-1920w.jpg 1920w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-3-1280w.jpg 1280w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-3-840w.jpg 840w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-3-320w.jpg 320w" type="image/jpeg"><img alt="" height="343" src="/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-3-1920w.jpg" width="1057" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1057 343'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAECAIAAAAxsZngAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAAbElEQVQImYXKsQ6DMAxF0fz/35UlAzWJQySQ3SiSVWyGqEEwVKhLj+7whue898NjgHGcAAIAxhhDwIhzwoS4LuuL+YzIpTkBPHPOtVYRed9suu27qZ2ZmSulMHNrrf/jRISIVPVz6b1/x8/1APmFnvkJJFO6AAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>可以看到 Header 的 Delivery-Mode 被設為 2，指的就是有持久化消息。</p><p>在傳遞「最少一次」的基礎上，消費端要保證消息也至少被消費一次。這個相對單純，只需要消費完成後，用 Ack 回應 Broker 消費已完成。如果 Broker 沒收到 Ack 且連結斷開，那再下次建立連結時，Broker 會重新發送消息。</p><h2 id="exactly-once"><a href="#exactly-once" class="direct-link">#</a> Exactly once</h2><p>「最少一次」的問題很明顯，要是消息不斷被重複發送，有可能導致同樣的消息被重複處理，以電商的情境為例，有可能出現重複扣款的狀況。對於重複不敏感的場景，例如物聯網資訊蒐集，「最少一次」已經足以應付，但對金融場景來講，重複扣款是個嚴重的問題。</p><p>為了達到「準確一次」的語義，會需要在「最少一次」的基礎上，加上去重複的機制。最直覺的想法是替所有消息都加上 ID，當收到消息時，會將該 ID 緩存起來，日後如果收到新的消息，先確認緩存中沒有重複的 ID 再進行處理。這個技巧又稱為「冪等鍵」，意思是將操作冪等化，不論重複送多少次，都會得到相同的結果。</p><p>RabbitMQ 沒有實作緩存確認的機制，因此無法保證「準確一次」。這可以分兩個方向來看，假設生產端正在等待 Broker 回覆 Confirm，此時網路斷開，生產端偵測到異常，為了滿足「至少一次」，生產端重複發送消息，RabbitMQ 的 Broker 中就會存在兩條相同的消息。或者，消費端在消費完消息後，因為網路斷開，Broker 沒收到 Ack，則在連線恢復後，Broker 會將同樣的消息再度發送給消費端，造成重複消費。</p><p>如上面講到的，因為 RabbitMQ 沒有辦法保證每個步驟能「準確一次」，我們得退而求其次，希望能做到端到端的「準確一次」。這代表說，我們不在意 RabbitMQ 中間是否存在重複遞送，只要訊息最後能被準確消費一次即可。</p><p>要達成這件事，生產端需要替每則訊息加上 unique ID</p><pre class="language-go"><code class="language-go">err <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><br>    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    routingKeys<span class="token punctuation">,</span><br>    rabbitmq<span class="token punctuation">.</span><span class="token function">WithPublishOptionsMessageID</span><span class="token punctuation">(</span>uniqueID<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    rabbitmq<span class="token punctuation">.</span><span class="token function">WithPublishOptionsExchange</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    rabbitmq<span class="token punctuation">.</span>WithPublishOptionsMandatory<span class="token punctuation">,</span><br>    rabbitmq<span class="token punctuation">.</span>WithPublishOptionsPersistentDelivery<span class="token punctuation">,</span><br><span class="token punctuation">)</span></code></pre><p>消費端收到訊息後，確認緩存內沒有 uniqueID，再進行處理</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span>d rabbitmq<span class="token punctuation">.</span>Delivery<span class="token punctuation">)</span> rabbitmq<span class="token punctuation">.</span>Action <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> cache<span class="token punctuation">.</span><span class="token function">IsExist</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>MessageId<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"duplicated message"</span><span class="token punctuation">)</span><br>        <span class="token keyword">return</span> rabbitmq<span class="token punctuation">.</span>Ack<br>    <span class="token punctuation">}</span><br>    cache<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>MessageId<span class="token punctuation">)</span><br>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> rabbitmq<span class="token punctuation">.</span>Ack<br><span class="token punctuation">}</span></code></pre><p>用 WireShark 也能看到 MessageID</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-4-1920w.webp 1920w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-4-1280w.webp 1280w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-4-840w.webp 840w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-4-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-4-1920w.jpg 1920w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-4-1280w.jpg 1280w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-4-840w.jpg 840w, /img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-4-320w.jpg 320w" type="image/jpeg"><img alt="" height="674" src="/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-4-1920w.jpg" width="2146" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2146 674'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAECAIAAAAxsZngAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAAeklEQVQImX3C0Q6CIBQAUP7/r+qt1hYojQScwPBe1CutNudLamu91Etnh5253u1PUjZCWKWCUoFzWxS10XA4Si6M9+QcuYbYtarKUlpbex9ibAEQABETYuq6PufbOOZPRkOfEszztK3L9rZ+/cGMGy46tv1Ej4Xuzz9fIVmZjS0+QIQAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>因為我們是在業務層面保證「準確一次」，實作方式就會跟系統相關，像是引入集中式緩存（Redis）會增加系統複雜度；而緩存的空間與失效期間也需要設計，這就不是單單調整參數就好，而是需要視具體運作的狀況來確定了。</p><h2 id="%E5%B0%8F%E7%B5%90"><a href="#%E5%B0%8F%E7%B5%90" class="direct-link">#</a> 小結</h2><p>軟體工程的其中一項挑戰來自於「語義鴻溝」，可以看到光是消息處理就存在著三層不同的語義，而且越高階語義就需要越複雜的設定。如果消息處理跟使用者的期待有落差，很容易產生無形的錯誤。可能對於大多數的使用者來說，都是以「準確一次」為預設，開發者也不會跟使用者講，消息丟失算是正常情況（即使在有條件的情況下，它的確是正常）。</p><p>也許可以這麼想：身為開發者，如何盡早辨識出語義鴻溝，並提出對應的技術方案，就是功力所在了。雖然用層次的概念來描述語義，好像會給人只要實作高層次就好的印象，但高層次的保證需要更多操作，像是更多的 Confirm、跟緩存間更多的溝通，都會影響到其他效能指標。以「準確一次」來說，還得確保緩存不會在執行中出問題，如果有問題的話，錯誤處理也要額外設計。</p><p>商業模型跟技術模型間如何對應一直是很有意思的題目，希望大家看完這篇後能體會到消息處理有趣的地方。</p><h2 id="reference"><a href="#reference" class="direct-link">#</a> Reference</h2><ul><li><a href="https://www.rabbitmq.com/amqp-0-9-1-reference.html" rel="noopener noreferrer" target="_blank">AMQP 0-9-1 Complete Reference Guide</a></li></ul><div class="article-footer"></div><div><p style="font-weight: bold;">標籤</p><div class="post-tags"><a href="/tags/go/" class="post-tag">Go</a> <a href="/tags/rabbitmq/" class="post-tag">RabbitMQ</a> <a href="/tags/message-queue/" class="post-tag">Message Queue</a></div><p style="font-weight: bold;">其他文章</p><ul><li><a href="/posts/2022/go-error-handling/">如何優雅包裝錯誤：聊聊 Go 的 error</a></li><li><a href="/posts/2022/error-as-resource-grpc-error-handling/">讓錯誤成為資源：gRPC 的錯誤處理模型</a></li><li><a href="/posts/2022/show-test-coverage-at-gitlab-a-go-example/">在 GitLab 顯示測試覆蓋率：以 Go 為例</a></li><li><a href="/posts/2019/send-gmail-with-python/">從零開始的 SMTP：以 Python 為例</a></li><li><a href="/posts/2019/setup-openwrt-on-virtualbox/">在 VirtualBox 上建置 Openwrt</a></li></ul></div><p style="font-weight: bold;">評論</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="ken00535/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"關於消息的三層語義：以 RabbitMQ 為例","image":["https://blog.kenwsc.com/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-1-1920w.jpg","https://blog.kenwsc.com/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-2-1920w.jpg","https://blog.kenwsc.com/img/posts/2022/three-semantics-of-rabbitmq/pub-and-sub-1920w.jpg","https://blog.kenwsc.com/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-3-1920w.jpg","https://blog.kenwsc.com/img/posts/2022/three-semantics-of-rabbitmq/wireshark-rabbitmq-4-1920w.jpg"],"author":{"@type":"Person","name":""},"publisher":{"@type":"Organization","name":"Ken Chen&#39;s Blog","url":"https://blog.kenwsc.com","logo":{"@type":"ImageObject","url":"https://blog.kenwsc.com/img/favicon/favicon.png","width":512,"height":512}},"url":"https://blog.kenwsc.com/posts/2022/three-semantics-of-rabbitmq/","mainEntityOfPage":"https://blog.kenwsc.com/posts/2022/three-semantics-of-rabbitmq/","datePublished":"2022-10-22","dateModified":"2022-12-17","description":"對分散式系統來說，消息的可靠性非常重要，想想一個金融應用的場景，如果在支付時，消息遺失了，或是重複遞送了，都會造成使用者的困擾。當我們在系統中引入消息隊列時，我們同時引入了複雜度，這意思是，系統的「處理消息」跟你想的不一定是同一件事。從可靠性的角度來看，「處理消息」的語義可以分為..."}</script></article></main><footer><div class="footer-logos"><a href="https://medium.com/@ken00535" rel="noopener noreferrer" target="_blank"><img alt="medium" height="50" src="/img/icons/icon_social media_medium.svg" width="50"></a><a href="https://www.linkedin.com/in/ken00535" rel="noopener noreferrer" target="_blank"><img alt="linkedin" height="30" src="/img/icons/icon_social media_linkedln.svg" width="30"></a><a href="https://blog.kenwsc.com/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" height="30" src="/img/icons/rss-feed.svg" width="30"></a></div><div class="copyright">© 2022 Ken Chen's Blog, Powered by <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>